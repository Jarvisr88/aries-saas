[
  {
    "TRIGGER_NAME": "tbl_invoice_transaction_beforeinsert",
    "EVENT_MANIPULATION": "INSERT",
    "EVENT_OBJECT_TABLE": "tbl_invoice_transaction",
    "ACTION_STATEMENT": "BEGIN\r\n  DECLARE V_OldValue DECIMAL(18, 2) DEFAULT (0); --\r\n  DECLARE V_Quantity DOUBLE DEFAULT (0); --\r\n  DECLARE V_TranType VARCHAR(50); --\r\n\r\n  -- we will allow to change Allowable, Billable and Taxes through transactions but in UI\r\n  -- all will stay the same\r\n\r\n  SELECT Name\r\n  INTO V_TranType\r\n  FROM tbl_invoice_transactiontype\r\n  WHERE ID = NEW.TransactionTypeID; --\r\n\r\n  IF (V_TranType = 'Adjust Allowable') THEN\r\n    SELECT AllowableAmount, Quantity\r\n    INTO V_OldValue, V_Quantity\r\n    FROM tbl_invoicedetails\r\n    WHERE (CustomerID = NEW.CustomerID) AND (InvoiceID = NEW.InvoiceID) AND (ID = NEW.InvoiceDetailsID); --\r\n\r\n    SET NEW.Quantity = V_Quantity; --\r\n    SET NEW.Comments = Concat('Previous Value=', V_OldValue); --\r\n\r\n    IF 0.001 < ABS(V_OldValue - NEW.Amount) THEN\r\n      UPDATE tbl_invoicedetails\r\n      SET AllowableAmount = NEW.Amount\r\n      WHERE (CustomerID = NEW.CustomerID) AND (InvoiceID = NEW.InvoiceID) AND (ID = NEW.InvoiceDetailsID); --\r\n    END IF; --\r\n  ELSEIF (V_TranType = 'Adjust Customary') THEN\r\n    SELECT BillableAmount, Quantity\r\n    INTO V_OldValue, V_Quantity\r\n    FROM tbl_invoicedetails\r\n    WHERE (CustomerID = NEW.CustomerID) AND (InvoiceID = NEW.InvoiceID) AND (ID = NEW.InvoiceDetailsID); --\r\n\r\n    SET NEW.Quantity = V_Quantity; --\r\n    SET NEW.Comments = Concat('Previous Value=', V_OldValue); --\r\n\r\n    IF 0.001 < ABS(V_OldValue - NEW.Amount) THEN\r\n      UPDATE tbl_invoicedetails\r\n      SET BillableAmount = NEW.Amount\r\n      WHERE (CustomerID = NEW.CustomerID) AND (InvoiceID = NEW.InvoiceID) AND (ID = NEW.InvoiceDetailsID); --\r\n    END IF; --\r\n  ELSEIF (V_TranType = 'Adjust Taxes') THEN\r\n    SELECT Taxes, Quantity\r\n    INTO V_OldValue, V_Quantity\r\n    FROM tbl_invoicedetails\r\n    WHERE (CustomerID = NEW.CustomerID) AND (InvoiceID = NEW.InvoiceID) AND (ID = NEW.InvoiceDetailsID); --\r\n\r\n    SET NEW.Quantity = V_Quantity; --\r\n    SET NEW.Comments = Concat('Previous Value=', V_OldValue); --\r\n\r\n    IF 0.001 < ABS(V_OldValue - NEW.Amount) THEN\r\n      UPDATE tbl_invoicedetails\r\n      SET Taxes = NEW.Amount\r\n      WHERE (CustomerID = NEW.CustomerID) AND (InvoiceID = NEW.InvoiceID) AND (ID = NEW.InvoiceDetailsID); --\r\n    END IF; --\r\n  END IF; --\r\nEND",
    "ACTION_TIMING": "BEFORE"
  }
]