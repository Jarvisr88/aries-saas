[
  {
    "ROUTINE_NAME": "customer_insurance_fixrank",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE V_ID, V_Rank INT; --\r\n  DECLARE cur CURSOR FOR\r\n    SELECT ID\r\n    FROM tbl_customer_insurance\r\n    WHERE (CustomerID = P_CustomerID)\r\n    ORDER BY IF(InactiveDate <= Current_Date(), 1, 0), `Rank`, ID; --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  SET V_Rank = 1; --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO V_ID; --\r\n\r\n    IF NOT done THEN\r\n      UPDATE tbl_customer_insurance SET `Rank` = IF(InactiveDate <= Current_Date(), 99999, V_Rank) WHERE (ID = V_ID) AND (CustomerID = P_CustomerID); --\r\n      SET V_Rank = V_Rank + 1; --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "fixInvoicePolicies",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  UPDATE tbl_invoice\r\n        INNER JOIN tbl_customer_insurance ON tbl_customer_insurance.InsuranceCompanyID = tbl_invoice.CustomerInsurance1_ID\r\n                                          AND tbl_customer_insurance.CustomerID = tbl_invoice.CustomerID\r\n  SET tbl_invoice.CustomerInsurance1_ID = tbl_customer_insurance.ID; --\r\n\r\n  UPDATE tbl_invoice\r\n        INNER JOIN tbl_customer_insurance ON tbl_customer_insurance.InsuranceCompanyID = tbl_invoice.CustomerInsurance2_ID\r\n                                          AND tbl_customer_insurance.CustomerID = tbl_invoice.CustomerID\r\n  SET tbl_invoice.CustomerInsurance2_ID = tbl_customer_insurance.ID; --\r\n\r\n  UPDATE tbl_invoice\r\n        INNER JOIN tbl_customer_insurance ON tbl_customer_insurance.InsuranceCompanyID = tbl_invoice.CustomerInsurance3_ID\r\n                                          AND tbl_customer_insurance.CustomerID = tbl_invoice.CustomerID\r\n  SET tbl_invoice.CustomerInsurance3_ID = tbl_customer_insurance.ID; --\r\n\r\n  UPDATE tbl_invoice\r\n        INNER JOIN tbl_customer_insurance ON tbl_customer_insurance.InsuranceCompanyID = tbl_invoice.CustomerInsurance4_ID\r\n                                          AND tbl_customer_insurance.CustomerID = tbl_invoice.CustomerID\r\n  SET tbl_invoice.CustomerInsurance4_ID = tbl_customer_insurance.ID; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "fixOrderPolicies",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  UPDATE tbl_order\r\n        INNER JOIN tbl_customer_insurance ON tbl_customer_insurance.InsuranceCompanyID = tbl_order.CustomerInsurance1_ID\r\n                                          AND tbl_customer_insurance.CustomerID = tbl_order.CustomerID\r\n  SET tbl_order.CustomerInsurance1_ID = tbl_customer_insurance.ID; --\r\n\r\n  UPDATE tbl_order\r\n        INNER JOIN tbl_customer_insurance ON tbl_customer_insurance.InsuranceCompanyID = tbl_order.CustomerInsurance2_ID\r\n                                          AND tbl_customer_insurance.CustomerID = tbl_order.CustomerID\r\n  SET tbl_order.CustomerInsurance2_ID = tbl_customer_insurance.ID; --\r\n\r\n  UPDATE tbl_order\r\n        INNER JOIN tbl_customer_insurance ON tbl_customer_insurance.InsuranceCompanyID = tbl_order.CustomerInsurance3_ID\r\n                                          AND tbl_customer_insurance.CustomerID = tbl_order.CustomerID\r\n  SET tbl_order.CustomerInsurance3_ID = tbl_customer_insurance.ID; --\r\n\r\n  UPDATE tbl_order\r\n        INNER JOIN tbl_customer_insurance ON tbl_customer_insurance.InsuranceCompanyID = tbl_order.CustomerInsurance4_ID\r\n                                          AND tbl_customer_insurance.CustomerID = tbl_order.CustomerID\r\n  SET tbl_order.CustomerInsurance4_ID = tbl_customer_insurance.ID; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "fix_serial_transactions",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n\r\n  -- cursor variables\r\n  DECLARE cur_Priority         int(11); --\r\n  DECLARE cur_CustomerID       int(11); --\r\n  DECLARE cur_OrderID          int(11); --\r\n  DECLARE cur_OrderDetailsID   int(11); --\r\n  DECLARE cur_SerialID         int(11); --\r\n  DECLARE cur_WarehouseID      int(11); --\r\n  DECLARE cur_TranType         varchar(50); --\r\n  DECLARE cur_TranTime         datetime; --\r\n\r\n  DECLARE cur CURSOR FOR\r\n  SELECT\r\n    Priority\r\n  , CustomerID\r\n  , OrderID\r\n  , OrderDetailsID\r\n  , SerialID\r\n  , WarehouseID\r\n  , TranType\r\n  , TranTime\r\n  FROM `{E9A96545-F98D-4318-836E-A10EA2CD78B7}`\r\n  ORDER BY DateReserved, OrderDetailsID, SerialId, Priority; --\r\n\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  DROP TABLE IF EXISTS `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}`; --\r\n\r\n  CREATE TEMPORARY TABLE `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}` AS\r\n  SELECT DISTINCT\r\n    od.SerialID\r\n  , od.CustomerID\r\n  , od.OrderID\r\n  , od.ID as OrderDetailsID\r\n  , od.WarehouseID\r\n  , o.DeliveryDate as DateReserved\r\n  , trf.Time as DateTransferred\r\n  , CASE WHEN (o.Approved = 1) AND (od.IsRented = 1)\r\n         THEN o.DeliveryDate\r\n         ELSE NULL END as DateRented\r\n  , CASE WHEN (o.Approved = 1) AND (od.IsRented = 1) AND (od.IsActive = 0) AND (od.IsCanceled = 0) AND (od.IsPickedup = 0)\r\n         THEN od.EndDate\r\n         ELSE NULL END as DateRentSold\r\n  , CASE WHEN (o.Approved = 1) AND (od.IsRented = 1) AND (od.IsActive = 0) AND (od.IsCanceled = 0) AND (od.IsPickedup = 1)\r\n         THEN od.EndDate\r\n         ELSE NULL END as DatePickedup\r\n  , CASE WHEN (o.Approved = 1) AND (od.IsSold = 1)\r\n         THEN o.DeliveryDate\r\n         ELSE NULL END as DateSold\r\n  FROM tbl_order AS o\r\n       INNER JOIN view_orderdetails AS od ON od.CustomerID = o.CustomerID\r\n                                         AND od.OrderID    = o.ID\r\n       INNER JOIN tbl_serial AS s ON od.SerialID        = s.ID -- serial exists\r\n                                 AND od.InventoryItemID = s.InventoryItemID\r\n       LEFT JOIN (SELECT st.SerialID, st.WarehouseID, MIN(TransactionDatetime) as Time\r\n                  FROM tbl_serial_transaction as st\r\n                       INNER JOIN tbl_serial_transaction_type as stt ON stt.ID = st.TypeID\r\n                  WHERE stt.Name = 'Transferred In'\r\n                  GROUP BY st.SerialID, st.WarehouseID) as trf ON trf.SerialID    = od.SerialID\r\n                                                              AND trf.WarehouseID = od.WarehouseID\r\n  WHERE (o.DeliveryDate IS NOT NULL)\r\n    AND (P_SerialID IS NULL OR s.ID = P_SerialID)\r\n  ORDER BY od.SerialID, o.DeliveryDate, od.ID; --\r\n\r\n  ALTER TABLE `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}` ADD COLUMN Number INT NOT NULL AUTO_INCREMENT PRIMARY KEY; --\r\n  ALTER TABLE `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}` ADD COLUMN IsFirst BOOL NOT NULL DEFAULT 0; --\r\n\r\n  DROP TABLE IF EXISTS `{F591E13A-9C30-445B-A812-BDE8F9A4566F}`; --\r\n\r\n  CREATE TEMPORARY TABLE `{F591E13A-9C30-445B-A812-BDE8F9A4566F}` AS\r\n  SELECT SerialID, Min(Number) as Number\r\n  FROM `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}`\r\n  GROUP BY SerialID; --\r\n\r\n  UPDATE `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}` AS a\r\n         INNER JOIN `{F591E13A-9C30-445B-A812-BDE8F9A4566F}` AS b ON a.SerialID = b.SerialID\r\n  SET a.IsFirst = CASE WHEN a.Number = b.Number THEN 1 ELSE 0 END; --\r\n\r\n  DROP TABLE IF EXISTS `{F591E13A-9C30-445B-A812-BDE8F9A4566F}`; --\r\n\r\n  -- delete bad entries\r\n\r\n  DROP TABLE IF EXISTS `{B3F09F5E-8C0F-41BD-B652-25386EAAEAC4}`; --\r\n\r\n  CREATE TEMPORARY TABLE `{B3F09F5E-8C0F-41BD-B652-25386EAAEAC4}` AS\r\n  SELECT SerialID\r\n  FROM `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}`\r\n  GROUP BY SerialID\r\n  HAVING 2 <= SUM(CASE WHEN DateRentSold IS NULL AND DatePickedup IS NULL THEN 1 ELSE 0 END); --\r\n\r\n  -- OUTPUT bad entries for investigations\r\n\r\n  SELECT SerialID\r\n  FROM `{B3F09F5E-8C0F-41BD-B652-25386EAAEAC4}`; --\r\n\r\n  DELETE FROM `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}`\r\n  WHERE SerialID IN (SELECT SerialID FROM `{B3F09F5E-8C0F-41BD-B652-25386EAAEAC4}`); --\r\n\r\n  DROP TABLE IF EXISTS `{B3F09F5E-8C0F-41BD-B652-25386EAAEAC4}`; --\r\n\r\n  -- OUTPUT bad entries for investigations\r\n  SELECT DISTINCT tmp.SerialID, stt.Name\r\n  FROM `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}` as tmp\r\n       INNER JOIN tbl_serial_transaction as st ON st.SerialID = tmp.SerialID\r\n       INNER JOIN tbl_serial_transaction_type as stt ON stt.ID = st.TypeID\r\n  WHERE stt.Name NOT IN ('Reserved', 'Reserve Cancelled', 'Rented', 'Sold', 'Returned', 'In from Maintenance', 'Transferred In')\r\n  ORDER BY tmp.SerialID, stt.Name; --\r\n\r\n  DELETE tmp\r\n  FROM `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}` as tmp\r\n       INNER JOIN tbl_serial_transaction as st ON st.SerialID = tmp.SerialID\r\n       INNER JOIN tbl_serial_transaction_type as stt ON stt.ID = st.TypeID\r\n  WHERE stt.Name NOT IN ('Reserved', 'Reserve Cancelled', 'Rented', 'Sold', 'Returned', 'In from Maintenance', 'Transferred In'); --\r\n\r\n  DROP TABLE IF EXISTS `{E9A96545-F98D-4318-836E-A10EA2CD78B7}`; --\r\n\r\n  CREATE TEMPORARY TABLE `{E9A96545-F98D-4318-836E-A10EA2CD78B7}` AS\r\n  SELECT\r\n    CASE WHEN s.IsFirst = 1              AND t.Name = 'Transferred In'      THEN 0\r\n         WHEN s.IsFirst = 0              AND t.Name = 'In from Maintenance' THEN 0\r\n         WHEN s.DateReserved IS NOT NULL AND t.Name = 'Reserved'            THEN 1\r\n         WHEN s.DateSold     IS NOT NULL AND t.Name = 'Sold'                THEN 2\r\n         WHEN s.DateRented   IS NOT NULL AND t.Name = 'Rented'              THEN 2\r\n         WHEN s.DateRentSold IS NOT NULL AND t.Name = 'Sold'                THEN 3\r\n         WHEN s.DatePickedup IS NOT NULL AND t.Name = 'Returned'            THEN 3\r\n         END as Priority\r\n  , s.DateReserved\r\n  , s.CustomerID\r\n  , s.OrderID\r\n  , s.OrderDetailsID\r\n  , s.SerialID\r\n  , s.WarehouseID\r\n  , t.Name as TranType\r\n  , CASE WHEN s.IsFirst = 1              AND t.Name = 'Transferred In'      THEN IFNULL(s.DateTransferred, s.DateReserved)\r\n         WHEN s.IsFirst = 0              AND t.Name = 'In from Maintenance' THEN s.DateReserved\r\n         WHEN s.DateReserved IS NOT NULL AND t.Name = 'Reserved'            THEN s.DateReserved\r\n         WHEN s.DateSold     IS NOT NULL AND t.Name = 'Sold'                THEN s.DateSold\r\n         WHEN s.DateRented   IS NOT NULL AND t.Name = 'Rented'              THEN s.DateRented\r\n         WHEN s.DateRentSold IS NOT NULL AND t.Name = 'Sold'                THEN s.DateRentSold\r\n         WHEN s.DatePickedup IS NOT NULL AND t.Name = 'Returned'            THEN s.DatePickedup\r\n         END as TranTime\r\n  FROM ( SELECT Name\r\n         FROM tbl_serial_transaction_type\r\n         WHERE Name IN ('Reserved', 'Reserve Cancelled', 'Rented', 'Sold', 'Returned', 'In from Maintenance', 'Transferred In')\r\n       ) as t\r\n       INNER JOIN `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}` as s\r\n               ON (s.IsFirst = 1              AND t.Name = 'Transferred In')\r\n               OR (s.IsFirst = 0              AND t.Name = 'In from Maintenance')\r\n               OR (s.DateReserved IS NOT NULL AND t.Name = 'Reserved')\r\n               OR (s.DateSold     IS NOT NULL AND t.Name = 'Sold')\r\n               OR (s.DateRented   IS NOT NULL AND t.Name = 'Rented')\r\n               OR (s.DateRentSold IS NOT NULL AND t.Name = 'Sold')\r\n               OR (s.DatePickedup IS NOT NULL AND t.Name = 'Returned')\r\n  ORDER BY SerialId, DateReserved, OrderDetailsID, Priority; --\r\n\r\n  DROP TABLE IF EXISTS `{B19B3C36-B432-4F3C-86F9-F4AF004EE8AF}`; --\r\n\r\n  DELETE\r\n  FROM tbl_serial_transaction\r\n  WHERE SerialID IN (SELECT SerialID FROM `{E9A96545-F98D-4318-836E-A10EA2CD78B7}`); --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO\r\n     cur_Priority\r\n    ,cur_CustomerID\r\n    ,cur_OrderID\r\n    ,cur_OrderDetailsID\r\n    ,cur_SerialID\r\n    ,cur_WarehouseID\r\n    ,cur_TranType\r\n    ,cur_TranTime; --\r\n\r\n    IF (done = 0) THEN\r\n      CALL serial_add_transaction(\r\n          cur_TranType       -- P_TranType         VARCHAR(50)\r\n        , cur_TranTime       -- P_TranTime         DATETIME\r\n        , cur_SerialID       -- P_SerialID         INT,\r\n        , cur_WarehouseID    -- P_WarehouseID      INT,\r\n        , null               -- P_VendorID         INT,\r\n        , cur_CustomerID     -- P_CustomerID       INT,\r\n        , cur_OrderID        -- P_OrderID          INT,\r\n        , cur_OrderDetailsID -- P_OrderDetailsID   INT,\r\n        , null               -- P_LotNumber        VARCHAR(50),\r\n        , 1                  -- P_LastUpdateUserID INT\r\n      ); --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\n\r\n  DROP TABLE IF EXISTS `{E9A96545-F98D-4318-836E-A10EA2CD78B7}`; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetAllowableAmount",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  IF P_BillingMonth <= 0 THEN\r\n    SET P_BillingMonth = 1; --\r\n  END IF; --\r\n\r\n  IF B_FlatRate = 1 THEN\r\n    SET P_Quantity = 1; --\r\n  END IF; --\r\n\r\n  IF P_SaleRentType IN ('One Time Sale', 'Re-occurring Sale', 'One Time Rental') THEN\r\n    IF P_BillingMonth = 1 THEN\r\n      RETURN P_Price * P_Quantity; --\r\n    END IF; --\r\n  ELSEIF P_SaleRentType IN ('Medicare Oxygen Rental','Monthly Rental') THEN\r\n    RETURN P_Price * P_Quantity; --\r\n  ELSEIF P_SaleRentType = 'Rent to Purchase' THEN\r\n    IF P_BillingMonth <= 9 THEN\r\n      RETURN P_Price * P_Quantity; --\r\n    ELSEIF P_BillingMonth = 10 THEN\r\n      RETURN (P_SalePrice - 9 * P_Price) * P_Quantity; --\r\n    END IF; --\r\n  ELSEIF P_SaleRentType = 'Capped Rental' THEN\r\n    IF P_BillingMonth <= 3 THEN\r\n      RETURN P_Price * P_Quantity; --\r\n    ELSEIF P_BillingMonth <= 15 THEN\r\n      RETURN 0.75 * P_Price * P_Quantity; --\r\n    ELSEIF (22 <= P_BillingMonth) AND ((P_BillingMonth - 22) Mod 6 = 0) THEN\r\n      RETURN P_Price * P_Quantity; --\r\n    END IF; --\r\n  ELSEIF P_SaleRentType = 'Parental Capped Rental' THEN\r\n    IF P_BillingMonth <= 15 THEN\r\n      RETURN P_Price * P_Quantity; --\r\n    ELSEIF (22 <= P_BillingMonth) AND ((P_BillingMonth - 22) Mod 6 = 0) THEN\r\n      RETURN P_Price * P_Quantity; --\r\n    END IF; --\r\n  END IF; --\r\n\r\n  RETURN 0.00; --\r\nEND",
    "DATA_TYPE": "decimal",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetAmountMultiplier",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n    DECLARE V_NextToDate DATETIME; --\r\n\r\n    IF     P_SaleRentType = 'One Time Sale'          THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Re-occurring Sale'      THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Rent to Purchase'       THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Capped Rental'          THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Parental Capped Rental' THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Medicare Oxygen Rental' THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Monthly Rental'         THEN\r\n        IF (P_OrderedWhen = 'Daily') THEN\r\n            SET V_NextToDate = GetNextDosFrom(P_FromDate, P_ToDate, P_BilledWhen); --\r\n            IF P_PickupDate IS NULL THEN\r\n                RETURN DATEDIFF(V_NextToDate, P_FromDate); --\r\n            ELSEIF V_NextToDate <= P_PickupDate THEN\r\n                RETURN DATEDIFF(V_NextToDate, P_FromDate); --\r\n            ELSEIF P_FromDate <= P_PickupDate THEN\r\n                RETURN (DATEDIFF(P_PickupDate, P_FromDate) + 1); --\r\n            ELSE -- P_PickupDate < P_FromDate\r\n                RETURN 0; --\r\n            END IF; --\r\n        ELSE\r\n          RETURN GetMultiplier(P_FromDate, P_ToDate, P_OrderedWhen, P_BilledWhen); --\r\n        END IF; --\r\n    ELSEIF P_SaleRentType = 'One Time Rental'        THEN\r\n        IF     P_OrderedWhen = 'One Time'      THEN RETURN 1; --\r\n        ELSEIF P_OrderedWhen = 'Daily'         THEN RETURN (DATEDIFF(P_PickupDate, P_FromDate) + 1); --\r\n        ELSEIF P_OrderedWhen = 'Weekly'        THEN RETURN (DATEDIFF(P_PickupDate, P_FromDate) + 1) / 7.0; --\r\n        ELSEIF P_OrderedWhen = 'Monthly'       THEN RETURN (DATEDIFF(P_PickupDate, P_FromDate) + 1) / 30.4; --\r\n        ELSEIF P_OrderedWhen = 'Quarterly'     THEN RETURN (DATEDIFF(P_PickupDate, P_FromDate) + 1) / 91.25; --\r\n        ELSEIF P_OrderedWhen = 'Semi-Annually' THEN RETURN (DATEDIFF(P_PickupDate, P_FromDate) + 1) / 182.5; --\r\n        ELSEIF P_OrderedWhen = 'Annually'      THEN RETURN (DATEDIFF(P_PickupDate, P_FromDate) + 1) / 365.0; --\r\n        END IF; --\r\n    END IF; --\r\n\r\n    RETURN NULL; --\r\nEND",
    "DATA_TYPE": "double",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetBillableAmount",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  IF P_BillingMonth <= 0 THEN\r\n    SET P_BillingMonth = 1; --\r\n  END IF; --\r\n\r\n  IF B_FlatRate = 1 THEN\r\n    SET P_Quantity = 1; --\r\n  END IF; --\r\n\r\n  IF P_SaleRentType IN ('One Time Sale', 'Re-occurring Sale', 'One Time Rental') THEN\r\n    IF P_BillingMonth = 1 THEN\r\n      RETURN P_Price * P_Quantity; --\r\n    END IF; --\r\n  ELSEIF P_SaleRentType IN ('Medicare Oxygen Rental','Monthly Rental') THEN\r\n    RETURN P_Price * P_Quantity; --\r\n  ELSEIF P_SaleRentType = 'Rent to Purchase' THEN\r\n    IF P_BillingMonth <= 9 THEN\r\n      RETURN P_Price * P_Quantity; --\r\n    ELSEIF P_BillingMonth = 10 THEN\r\n      RETURN (P_SalePrice - 9 * P_Price) * P_Quantity; --\r\n    END IF; --\r\n  ELSEIF P_SaleRentType = 'Capped Rental' OR P_SaleRentType = 'Parental Capped Rental' THEN\r\n    IF P_BillingMonth <= 15 THEN\r\n      RETURN P_Price * P_Quantity; --\r\n    ELSEIF (22 <= P_BillingMonth) AND ((P_BillingMonth - 22) Mod 6 = 0) THEN\r\n      RETURN P_Price * P_Quantity; --\r\n    END IF; --\r\n  END IF; --\r\n\r\n  RETURN 0.00; --\r\nEND",
    "DATA_TYPE": "decimal",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetInvoiceModifier",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  IF P_BillingMonth <= 0 THEN\r\n    SET P_BillingMonth = 1; --\r\n  END IF; --\r\n\r\n  IF P_SaleRentType = 'Capped Rental' OR P_SaleRentType = 'Parental Capped Rental' THEN\r\n    IF     P_Index = 1 THEN\r\n      IF (22 <= P_BillingMonth) AND ((P_BillingMonth - 22) Mod 6 = 0) THEN\r\n        RETURN 'MS'; --\r\n      ELSE\r\n        RETURN 'RR'; --\r\n      END IF; --\r\n    ELSEIF P_Index = 2 THEN\r\n      IF P_BillingMonth = 1 THEN\r\n        RETURN 'KH'; --\r\n      ELSEIF P_BillingMonth <= 3 THEN\r\n        RETURN 'KI'; --\r\n      ELSEIF P_BillingMonth <= 15 THEN\r\n        RETURN 'KJ'; --\r\n      ELSEIF (22 <= P_BillingMonth) AND ((P_BillingMonth - 22) Mod 6 = 0) THEN\r\n        IF P_Modifier4 = 'KX' THEN\r\n          RETURN 'KX'; --\r\n        ELSE\r\n          RETURN ''; --\r\n        END IF; --\r\n      ELSE\r\n        RETURN ''; --\r\n      END IF; --\r\n    ELSEIF P_Index = 3 THEN\r\n      IF P_DeliveryDate < '2006-01-01' THEN\r\n        IF (22 <= P_BillingMonth) AND ((P_BillingMonth - 22) Mod 6 = 0) THEN\r\n          RETURN ''; --\r\n        END IF; --\r\n      ELSE\r\n        IF (P_BillingMonth >= 12) THEN\r\n          RETURN 'KX'; --\r\n        END IF; --\r\n      END IF; --\r\n    ELSEIF P_Index = 4 THEN\r\n      IF P_DeliveryDate < '2006-01-01' THEN\r\n        IF (22 <= P_BillingMonth) AND ((P_BillingMonth - 22) Mod 6 = 0) THEN\r\n          RETURN ''; --\r\n        END IF; --\r\n      ELSE\r\n        IF (P_BillingMonth >= 12) THEN\r\n          RETURN ''; --\r\n        END IF; --\r\n      END IF; --\r\n    END IF; --\r\n  END IF; --\r\n\r\n  IF     P_Index = 1 THEN\r\n    RETURN P_Modifier1; --\r\n  ELSEIF P_Index = 2 THEN\r\n    RETURN P_Modifier2; --\r\n  ELSEIF P_Index = 3 THEN\r\n    RETURN P_Modifier3; --\r\n  ELSEIF P_Index = 4 THEN\r\n    RETURN P_Modifier4; --\r\n  ELSE\r\n    RETURN ''; --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "varchar",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetMultiplier",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  IF P_OrderedWhen = 'One Time' THEN RETURN 1; --\r\n\r\n  ELSEIF P_OrderedWhen = 'Daily'  AND P_BilledWhen = 'Daily' THEN RETURN 1; --\r\n\r\n  ELSEIF P_OrderedWhen = 'Daily'  AND P_BilledWhen = 'Weekly' THEN RETURN 7; --\r\n  ELSEIF P_OrderedWhen = 'Weekly' AND P_BilledWhen = 'Weekly' THEN RETURN 1; --\r\n\r\n  ELSEIF P_OrderedWhen = 'Daily'   AND P_BilledWhen = 'Monthly' THEN RETURN DATEDIFF(GetNextDosFrom(P_FromDate, P_ToDate, P_BilledWhen), P_FromDate); --\r\n  ELSEIF P_OrderedWhen = 'Weekly'  AND P_BilledWhen = 'Monthly' THEN RETURN 4; --\r\n  ELSEIF P_OrderedWhen = 'Monthly' AND P_BilledWhen = 'Monthly' THEN RETURN 1; --\r\n\r\n  ELSEIF P_OrderedWhen = 'Daily'   AND P_BilledWhen = 'Calendar Monthly' THEN RETURN DATEDIFF(GetNextDosFrom(P_FromDate, P_ToDate, P_BilledWhen), P_FromDate); --\r\n  ELSEIF P_OrderedWhen = 'Weekly'  AND P_BilledWhen = 'Calendar Monthly' THEN RETURN DATEDIFF(GetNextDosFrom(P_FromDate, P_ToDate, P_BilledWhen), P_FromDate) / 7.0; --\r\n  ELSEIF P_OrderedWhen = 'Monthly' AND P_BilledWhen = 'Calendar Monthly' THEN RETURN 1; --\r\n\r\n  ELSEIF P_OrderedWhen = 'Daily'     AND P_BilledWhen = 'Quarterly' THEN RETURN DATEDIFF(GetNextDosFrom(P_FromDate, P_ToDate, P_BilledWhen), P_FromDate); --\r\n  ELSEIF P_OrderedWhen = 'Weekly'    AND P_BilledWhen = 'Quarterly' THEN RETURN 13; --\r\n  ELSEIF P_OrderedWhen = 'Monthly'   AND P_BilledWhen = 'Quarterly' THEN RETURN 3; --\r\n  ELSEIF P_OrderedWhen = 'Quarterly' AND P_BilledWhen = 'Quarterly' THEN RETURN 1; --\r\n\r\n  ELSEIF P_OrderedWhen = 'Daily'         AND P_BilledWhen = 'Semi-Annually' THEN RETURN DATEDIFF(GetNextDosFrom(P_FromDate, P_ToDate, P_BilledWhen), P_FromDate); --\r\n  ELSEIF P_OrderedWhen = 'Weekly'        AND P_BilledWhen = 'Semi-Annually' THEN RETURN 26; --\r\n  ELSEIF P_OrderedWhen = 'Monthly'       AND P_BilledWhen = 'Semi-Annually' THEN RETURN 6; --\r\n  ELSEIF P_OrderedWhen = 'Quarterly'     AND P_BilledWhen = 'Semi-Annually' THEN RETURN 2; --\r\n  ELSEIF P_OrderedWhen = 'Semi-Annually' AND P_BilledWhen = 'Semi-Annually' THEN RETURN 1; --\r\n\r\n  ELSEIF P_OrderedWhen = 'Daily'         AND P_BilledWhen = 'Annually' THEN RETURN DATEDIFF(GetNextDosFrom(P_FromDate, P_ToDate, P_BilledWhen), P_FromDate); --\r\n  ELSEIF P_OrderedWhen = 'Weekly'        AND P_BilledWhen = 'Annually' THEN RETURN 52; --\r\n  ELSEIF P_OrderedWhen = 'Monthly'       AND P_BilledWhen = 'Annually' THEN RETURN 12; --\r\n  ELSEIF P_OrderedWhen = 'Quarterly'     AND P_BilledWhen = 'Annually' THEN RETURN 4; --\r\n  ELSEIF P_OrderedWhen = 'Semi-Annually' AND P_BilledWhen = 'Annually' THEN RETURN 2; --\r\n  ELSEIF P_OrderedWhen = 'Annually'      AND P_BilledWhen = 'Annually' THEN RETURN 1; --\r\n\r\n  ELSEIF P_OrderedWhen = 'Daily'  AND P_BilledWhen = 'Custom' THEN RETURN DATEDIFF(GetNextDosFrom(P_FromDate, P_ToDate, P_BilledWhen), P_FromDate); --\r\n\r\n  END IF; --\r\n\r\n  RETURN NULL; --\r\nEND",
    "DATA_TYPE": "double",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetNewDosTo",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_LENGTH INT; --\r\n\r\n  IF     P_Frequency = 'One time'         THEN RETURN P_NewFromDate; --\r\n  ELSEIF P_Frequency = 'Daily'            THEN RETURN DATE_ADD(DATE_ADD(P_NewFromDate, INTERVAL 01 DAY  ), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Weekly'           THEN RETURN DATE_ADD(DATE_ADD(P_NewFromDate, INTERVAL 07 DAY  ), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Monthly'          THEN RETURN DATE_ADD(DATE_ADD(P_NewFromDate, INTERVAL 01 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Calendar Monthly' THEN\r\n    SET P_NewFromDate = DATE_ADD(P_NewFromDate, INTERVAL 01 MONTH); --\r\n    RETURN DATE_ADD(P_NewFromDate, INTERVAL 0-DAY(P_NewFromDate) DAY); -- end of month\r\n  ELSEIF P_Frequency = 'Quarterly'        THEN RETURN DATE_ADD(DATE_ADD(P_NewFromDate, INTERVAL 03 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Semi-Annually'    THEN RETURN DATE_ADD(DATE_ADD(P_NewFromDate, INTERVAL 06 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Annually'         THEN RETURN DATE_ADD(DATE_ADD(P_NewFromDate, INTERVAL 12 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Custom'           THEN\r\n    SET V_LENGTH = DATEDIFF(P_OldToDate, P_OldFromDate) + 1; --\r\n    RETURN DATE_ADD(DATE_ADD(P_NewFromDate, INTERVAL V_LENGTH DAY), INTERVAL -1 DAY); --\r\n  END IF; --\r\n\r\n  RETURN NULL; --\r\nEND",
    "DATA_TYPE": "datetime",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetNextDosFrom",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  IF     P_Frequency = 'One time'         THEN RETURN P_FromDate; --\r\n  ELSEIF P_Frequency = 'Daily'            THEN RETURN DATE_ADD(P_FromDate, INTERVAL 01 DAY); --\r\n  ELSEIF P_Frequency = 'Weekly'           THEN RETURN DATE_ADD(P_FromDate, INTERVAL 07 DAY); --\r\n  ELSEIF P_Frequency = 'Monthly'          THEN RETURN DATE_ADD(P_FromDate, INTERVAL 01 MONTH); --\r\n  ELSEIF P_Frequency = 'Calendar Monthly' THEN\r\n    SET P_FromDate = DATE_ADD(P_FromDate, INTERVAL 1 MONTH); --\r\n    RETURN DATE_ADD(P_FromDate, INTERVAL 1-DAY(P_FromDate) DAY); --\r\n  ELSEIF P_Frequency = 'Quarterly'        THEN RETURN DATE_ADD(P_FromDate, INTERVAL 03 MONTH); --\r\n  ELSEIF P_Frequency = 'Semi-Annually'    THEN RETURN DATE_ADD(P_FromDate, INTERVAL 06 MONTH); --\r\n  ELSEIF P_Frequency = 'Annually'         THEN RETURN DATE_ADD(P_FromDate, INTERVAL 12 MONTH); --\r\n  ELSEIF P_Frequency = 'Custom'           THEN RETURN DATE_ADD(P_ToDate  , INTERVAL 01 DAY); --\r\n  END IF; --\r\n\r\n  RETURN NULL; --\r\nEND",
    "DATA_TYPE": "datetime",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetNextDosTo",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_LENGTH INT; --\r\n\r\n  IF     P_Frequency = 'One time'         THEN RETURN P_FromDate; --\r\n  ELSEIF P_Frequency = 'Daily'            THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 2 * 01 DAY  ), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Weekly'           THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 2 * 07 DAY  ), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Monthly'          THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 2 * 01 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Calendar Monthly' THEN\r\n    SET P_FromDate = DATE_ADD(P_FromDate, INTERVAL 02 MONTH); --\r\n    RETURN DATE_ADD(P_FromDate, INTERVAL 0-DAY(P_FromDate) DAY); --\r\n  ELSEIF P_Frequency = 'Quarterly'        THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 2 * 03 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Semi-Annually'    THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 2 * 06 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Annually'         THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 2 * 12 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Custom'           THEN\r\n    SET V_LENGTH = DATEDIFF(P_ToDate, P_FromDate) + 1; --\r\n    RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 2 * V_LENGTH DAY), INTERVAL -1 DAY); --\r\n  END IF; --\r\n\r\n  RETURN NULL; --\r\nEND",
    "DATA_TYPE": "datetime",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetPeriodEnd",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  IF     P_Frequency = 'One time'         THEN RETURN P_FromDate; --\r\n  ELSEIF P_Frequency = 'Daily'            THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 01 DAY  ), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Weekly'           THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 07 DAY  ), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Monthly'          THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 01 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Calendar Monthly' THEN\r\n    SET P_FromDate = DATE_ADD(P_FromDate, INTERVAL 1 MONTH); --\r\n    RETURN DATE_ADD(P_FromDate, INTERVAL 0-DAY(P_FromDate) DAY); --\r\n  ELSEIF P_Frequency = 'Quarterly'        THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 03 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Semi-Annually'    THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 06 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Annually'         THEN RETURN DATE_ADD(DATE_ADD(P_FromDate, INTERVAL 12 MONTH), INTERVAL -1 DAY); --\r\n  ELSEIF P_Frequency = 'Custom'           THEN RETURN P_ToDate; --\r\n  END IF; --\r\n\r\n  RETURN NULL; --\r\nEND",
    "DATA_TYPE": "datetime",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetPeriodEnd2",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_PeriodEnd DATETIME; --\r\n\r\n  SET V_PeriodEnd = `GetPeriodEnd`(P_FromDate, P_ToDate, P_Frequency); --\r\n\r\n  IF     P_PickupDate IS NULL        THEN RETURN V_PeriodEnd; --\r\n  ELSEIF V_PeriodEnd <= P_PickupDate THEN RETURN V_PeriodEnd; --\r\n  ELSEIF P_FromDate  <= P_PickupDate THEN RETURN P_PickupDate; --\r\n  END IF; --\r\n\r\n  RETURN P_FromDate; --\r\nEND",
    "DATA_TYPE": "datetime",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "GetQuantityMultiplier",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n    DECLARE V_NextToDate DATETIME; --\r\n\r\n    IF     P_SaleRentType = 'One Time Sale'          THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Re-occurring Sale'      THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Rent to Purchase'       THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Capped Rental'          THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Parental Capped Rental' THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Medicare Oxygen Rental' THEN RETURN 1; --\r\n    ELSEIF P_SaleRentType = 'Monthly Rental'         THEN\r\n        IF (P_OrderedWhen = 'Daily') THEN\r\n            SET V_NextToDate = GetNextDosFrom(P_FromDate, P_ToDate, P_BilledWhen); --\r\n            IF P_PickupDate IS NULL THEN\r\n                RETURN DATEDIFF(V_NextToDate, P_FromDate); --\r\n            ELSEIF V_NextToDate <= P_PickupDate THEN\r\n                RETURN DATEDIFF(V_NextToDate, P_FromDate); --\r\n            ELSEIF P_FromDate <= P_PickupDate THEN\r\n                RETURN (DATEDIFF(P_PickupDate, P_FromDate) + 1); --\r\n            ELSE -- P_PickupDate < P_FromDate\r\n                RETURN 0; --\r\n            END IF; --\r\n        ELSE\r\n            RETURN 1; --\r\n        END IF; --\r\n    ELSEIF P_SaleRentType = 'One Time Rental'        THEN RETURN (DATEDIFF(P_PickupDate, P_FromDate) + 1); --\r\n    END IF; --\r\n\r\n    RETURN NULL; --\r\nEND",
    "DATA_TYPE": "double",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "internal_inventory_transfer",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE\r\n    V_OnHand INT; --\r\n  DECLARE\r\n    V_CostPerUnit DECIMAL(18, 2); --\r\n\r\n  IF (P_InventoryItemID IS NOT NULL)\r\n  AND (P_SrcWarehouseID IS NOT NULL)\r\n  AND (P_DstWarehouseID IS NOT NULL)\r\n  AND (0 < IFNULL(P_Quantity, 0)) THEN\r\n    CALL inventory_refresh(P_SrcWarehouseID, P_InventoryItemID); --\r\n\r\n    SELECT\r\n      IFNULL(OnHand     , 0) as OnHand\r\n    , IFNULL(CostPerUnit, 0) as CostPerUnit\r\n    INTO\r\n      V_OnHand\r\n    , V_CostPerUnit\r\n    FROM tbl_inventory\r\n    WHERE (InventoryItemID = P_InventoryItemID)\r\n      AND (WarehouseID     = P_SrcWarehouseID); --\r\n\r\n    IF (P_Quantity <= V_OnHand) THEN\r\n      CALL inventory_transaction_add_adjustment(\r\n        P_SrcWarehouseID,\r\n        P_InventoryItemID,\r\n        'Transferred Out',\r\n        P_Description,\r\n        P_Quantity,\r\n        V_CostPerUnit,\r\n        P_LastUpdateUserID); --\r\n\r\n      CALL inventory_transaction_add_adjustment(\r\n        P_DstWarehouseID,\r\n        P_InventoryItemID,\r\n        'Transferred In',\r\n        P_Description,\r\n        P_Quantity,\r\n        V_CostPerUnit,\r\n        P_LastUpdateUserID); --\r\n\r\n      CALL inventory_refresh(P_SrcWarehouseID, P_InventoryItemID); --\r\n      CALL inventory_refresh(P_DstWarehouseID, P_InventoryItemID); --\r\n    END IF; --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "InventoryItem_Clone",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_RowCount INT; --\r\n\r\n  INSERT INTO tbl_inventoryitem (\r\n    Barcode\r\n  , BarcodeType\r\n  , Basis\r\n  , CommissionPaidAt\r\n  , VendorID\r\n  , FlatRate\r\n  , FlatRateAmount\r\n  , Frequency\r\n  , InventoryCode\r\n  , ModelNumber\r\n  , Name\r\n  , O2Tank\r\n  , Percentage\r\n  , PercentageAmount\r\n  , PredefinedTextID\r\n  , ProductTypeID\r\n  , Serialized\r\n  , Service\r\n  , LastUpdateUserID\r\n  , LastUpdateDatetime\r\n  , Inactive\r\n  , ManufacturerID\r\n  , PurchasePrice\r\n  ) SELECT\r\n    Barcode\r\n  , BarcodeType\r\n  , Basis\r\n  , CommissionPaidAt\r\n  , VendorID\r\n  , FlatRate\r\n  , FlatRateAmount\r\n  , Frequency\r\n  , InventoryCode\r\n  , ModelNumber\r\n  , IFNULL(P_NewName, Name) as Name\r\n  , O2Tank\r\n  , Percentage\r\n  , PercentageAmount\r\n  , PredefinedTextID\r\n  , ProductTypeID\r\n  , Serialized\r\n  , Service\r\n  , LastUpdateUserID\r\n  , LastUpdateDatetime\r\n  , Inactive\r\n  , ManufacturerID\r\n  , PurchasePrice\r\n  FROM tbl_inventoryitem\r\n  WHERE (ID = P_OldInventoryItemID); --\r\n\r\n  SELECT ROW_COUNT(), LAST_INSERT_ID() INTO V_RowCount, P_NewInventoryItemID; --\r\n\r\n  IF (V_RowCount = 0) THEN\r\n    SET P_NewInventoryItemID = NULL; --\r\n  ELSE\r\n    INSERT INTO `tbl_pricecode_item` (\r\n      AcceptAssignment\r\n    , OrderedQuantity\r\n    , OrderedUnits\r\n    , OrderedWhen\r\n    , OrderedConverter\r\n    , BilledUnits\r\n    , BilledWhen\r\n    , BilledConverter\r\n    , DeliveryUnits\r\n    , DeliveryConverter\r\n    , BillingCode\r\n    , BillItemOn\r\n    , DefaultCMNType\r\n    , DefaultOrderType\r\n    , AuthorizationTypeID\r\n    , FlatRate\r\n    , InventoryItemID\r\n    , Modifier1\r\n    , Modifier2\r\n    , Modifier3\r\n    , Modifier4\r\n    , PriceCodeID\r\n    , PredefinedTextID\r\n    , Rent_AllowablePrice\r\n    , Rent_BillablePrice\r\n    , Sale_AllowablePrice\r\n    , Sale_BillablePrice\r\n    , RentalType\r\n    , ReoccuringSale\r\n    , ShowSpanDates\r\n    , Taxable\r\n    , LastUpdateUserID\r\n    , LastUpdateDatetime\r\n    , BillInsurance\r\n    , DrugNoteField\r\n    , DrugControlNumber\r\n    ) SELECT\r\n      AcceptAssignment\r\n    , OrderedQuantity\r\n    , OrderedUnits\r\n    , OrderedWhen\r\n    , OrderedConverter\r\n    , BilledUnits\r\n    , BilledWhen\r\n    , BilledConverter\r\n    , DeliveryUnits\r\n    , DeliveryConverter\r\n    , BillingCode\r\n    , BillItemOn\r\n    , DefaultCMNType\r\n    , DefaultOrderType\r\n    , AuthorizationTypeID\r\n    , FlatRate\r\n    , P_NewInventoryItemID as InventoryItemID\r\n    , Modifier1\r\n    , Modifier2\r\n    , Modifier3\r\n    , Modifier4\r\n    , PriceCodeID\r\n    , PredefinedTextID\r\n    , Rent_AllowablePrice\r\n    , Rent_BillablePrice\r\n    , Sale_AllowablePrice\r\n    , Sale_BillablePrice\r\n    , RentalType\r\n    , ReoccuringSale\r\n    , ShowSpanDates\r\n    , Taxable\r\n    , LastUpdateUserID\r\n    , LastUpdateDatetime\r\n    , BillInsurance\r\n    , DrugNoteField\r\n    , DrugControlNumber\r\n    FROM `tbl_pricecode_item`\r\n    WHERE (InventoryItemID = P_OldInventoryItemID); --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "inventory_adjust_2",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE\r\n    V_DeltaOnHand\r\n  , V_DeltaRented\r\n  , V_DeltaSold\r\n  , V_DeltaUnavailable\r\n  , V_DeltaCommitted\r\n  , V_DeltaOnOrder\r\n  , V_DeltaBackOrdered INT; --\r\n  DECLARE\r\n    V_CostPerUnit DECIMAL(18, 2); --\r\n\r\n  IF (P_WarehouseID IS NOT NULL) AND (P_InventoryItemID IS NOT NULL) THEN\r\n    CALL inventory_refresh(P_WarehouseID, P_InventoryItemID); --\r\n\r\n    /* in case when this entry does not have any transactions */\r\n    SET V_DeltaOnHand        = IF(0 <= IFNULL(P_OnHand     , -1), P_OnHand      - 0, NULL); --\r\n    SET V_DeltaRented        = IF(0 <= IFNULL(P_Rented     , -1), P_Rented      - 0, NULL); --\r\n    SET V_DeltaSold          = IF(0 <= IFNULL(P_Sold       , -1), P_Sold        - 0, NULL); --\r\n    SET V_DeltaUnavailable   = IF(0 <= IFNULL(P_Unavailable, -1), P_Unavailable - 0, NULL); --\r\n    SET V_DeltaCommitted     = IF(0 <= IFNULL(P_Committed  , -1), P_Committed   - 0, NULL); --\r\n    SET V_DeltaOnOrder       = IF(0 <= IFNULL(P_OnOrder    , -1), P_OnOrder     - 0, NULL); --\r\n    SET V_DeltaBackOrdered   = IF(0 <= IFNULL(P_BackOrdered, -1), P_BackOrdered - 0, NULL); --\r\n    SET V_CostPerUnit        = P_CostPerUnit; --\r\n\r\n    SELECT\r\n      IF(0 <= IFNULL(P_OnHand     , -1), P_OnHand      - IFNULL(OnHand     , 0), NULL) as DeltaOnHand\r\n    , IF(0 <= IFNULL(P_Rented     , -1), P_Rented      - IFNULL(Rented     , 0), NULL) as DeltaRented\r\n    , IF(0 <= IFNULL(P_Sold       , -1), P_Sold        - IFNULL(Sold       , 0), NULL) as DeltaSold\r\n    , IF(0 <= IFNULL(P_Unavailable, -1), P_Unavailable - IFNULL(Unavailable, 0), NULL) as DeltaUnavailable\r\n    , IF(0 <= IFNULL(P_Committed  , -1), P_Committed   - IFNULL(Committed  , 0), NULL) as DeltaCommitted\r\n    , IF(0 <= IFNULL(P_OnOrder    , -1), P_OnOrder     - IFNULL(OnOrder    , 0), NULL) as DeltaOnOrder\r\n    , IF(0 <= IFNULL(P_BackOrdered, -1), P_BackOrdered - IFNULL(BackOrdered, 0), NULL) as DeltaBackOrdered\r\n    , CostPerUnit\r\n    INTO\r\n      V_DeltaOnHand\r\n    , V_DeltaRented\r\n    , V_DeltaSold\r\n    , V_DeltaUnavailable\r\n    , V_DeltaCommitted\r\n    , V_DeltaOnOrder\r\n    , V_DeltaBackOrdered\r\n    , V_CostPerUnit\r\n    FROM tbl_inventory\r\n    WHERE (WarehouseID     = P_WarehouseID)\r\n      AND (InventoryItemID = P_InventoryItemID); --\r\n\r\n    SET V_CostPerUnit = IFNULL(P_CostPerUnit, IFNULL(V_CostPerUnit, 0)); --\r\n\r\n    CALL inventory_transaction_add_adjustment(\r\n      P_WarehouseID,\r\n      P_InventoryItemID,\r\n      'OnHand Adjustment',\r\n      'Manual Adjustment',\r\n      IFNULL(V_DeltaOnHand, 0) + IFNULL(V_DeltaCommitted, 0) + IF(V_DeltaOnOrder < 0, V_DeltaOnOrder, 0),\r\n      V_CostPerUnit,\r\n      P_LastUpdateUserID); --\r\n\r\n    CALL inventory_transaction_add_adjustment(\r\n      P_WarehouseID,\r\n      P_InventoryItemID,\r\n      'Rented Adjustment',\r\n      'Manual Adjustment',\r\n      V_DeltaRented,\r\n      V_CostPerUnit,\r\n      P_LastUpdateUserID); --\r\n\r\n    CALL inventory_transaction_add_adjustment(\r\n      P_WarehouseID,\r\n      P_InventoryItemID,\r\n      'Sold Adjustment',\r\n      'Manual Adjustment',\r\n      V_DeltaSold,\r\n      V_CostPerUnit,\r\n      P_LastUpdateUserID); --\r\n\r\n    CALL inventory_transaction_add_adjustment(\r\n      P_WarehouseID,\r\n      P_InventoryItemID,\r\n      'Unavailable Adj',\r\n      'Manual Adjustment',\r\n      0 - V_DeltaUnavailable,\r\n      V_CostPerUnit,\r\n      P_LastUpdateUserID); --\r\n\r\n    CALL inventory_transaction_add_adjustment(\r\n      P_WarehouseID,\r\n      P_InventoryItemID,\r\n      'Committed',\r\n      'Manual Adjustment',\r\n      IF(0 < V_DeltaCommitted, ABS(V_DeltaCommitted), 0),\r\n      V_CostPerUnit,\r\n      P_LastUpdateUserID); --\r\n\r\n    CALL inventory_transaction_add_adjustment(\r\n      P_WarehouseID,\r\n      P_InventoryItemID,\r\n      'Commit Cancelled',\r\n      'Manual Adjustment',\r\n      IF(V_DeltaCommitted < 0, ABS(V_DeltaCommitted), 0),\r\n      V_CostPerUnit,\r\n      P_LastUpdateUserID); --\r\n\r\n    CALL inventory_transaction_add_adjustment(\r\n      P_WarehouseID,\r\n      P_InventoryItemID,\r\n      'Ordered',\r\n      'Manual Adjustment',\r\n      IF(0 < V_DeltaOnOrder, ABS(V_DeltaOnOrder), 0),\r\n      V_CostPerUnit,\r\n      P_LastUpdateUserID); --\r\n\r\n    CALL inventory_transaction_add_adjustment(\r\n      P_WarehouseID,\r\n      P_InventoryItemID,\r\n      'Received',\r\n      'Manual Adjustment',\r\n      IF(V_DeltaOnOrder < 0, ABS(V_DeltaOnOrder), 0),\r\n      V_CostPerUnit,\r\n      P_LastUpdateUserID); --\r\n\r\n    CALL inventory_transaction_add_adjustment(\r\n      P_WarehouseID,\r\n      P_InventoryItemID,\r\n      'BackOrdered',\r\n      'Manual Adjustment',\r\n      IF(0 < V_DeltaBackOrdered, ABS(V_DeltaBackOrdered), 0),\r\n      V_CostPerUnit,\r\n      P_LastUpdateUserID); --\r\n\r\n    CALL inventory_transaction_add_adjustment(\r\n      P_WarehouseID,\r\n      P_InventoryItemID,\r\n      'Fill Back Order',\r\n      'Manual Adjustment',\r\n      IF(V_DeltaBackOrdered < 0, ABS(V_DeltaBackOrdered), 0),\r\n      V_CostPerUnit,\r\n      P_LastUpdateUserID); --\r\n\r\n    IF (0 < IFNULL(P_CostPerUnit, -1)) THEN\r\n      CALL inventory_transaction_add_adjustment(\r\n        P_WarehouseID,\r\n        P_InventoryItemID,\r\n        'CostPerUnit Adj',\r\n        'Manual Adjustment',\r\n        1, -- to satisfy quantity check\r\n        P_CostPerUnit,\r\n        P_LastUpdateUserID); --\r\n    END IF; --\r\n\r\n    IF (0 <= IFNULL(P_ReOrderPoint, -1)) THEN\r\n      UPDATE tbl_inventory\r\n      SET ReOrderPoint = P_ReOrderPoint\r\n      WHERE (WarehouseID     = P_WarehouseID)\r\n        AND (InventoryItemID = P_InventoryItemID); --\r\n    END IF; --\r\n\r\n    CALL inventory_refresh(P_WarehouseID, P_InventoryItemID); --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "inventory_order_refresh",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE V_WarehouseID, V_InventoryItemID INT; --\r\n  DECLARE cur CURSOR FOR SELECT WarehouseID, InventoryItemID FROM tbl_orderdetails WHERE (OrderID = P_OrderID); --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO V_WarehouseID, V_InventoryItemID; --\r\n\r\n    IF NOT done THEN\r\n      CALL inventory_refresh(V_WarehouseID, V_InventoryItemID); --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "inventory_po_refresh",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE V_WarehouseID, V_InventoryItemID INT; --\r\n  DECLARE cur CURSOR FOR SELECT WarehouseID, InventoryItemID FROM tbl_purchaseorderdetails WHERE (PurchaseOrderID = P_PurchaseOrderID); --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO V_WarehouseID, V_InventoryItemID; --\r\n\r\n    IF NOT done THEN\r\n      CALL inventory_refresh(V_WarehouseID, V_InventoryItemID); --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "inventory_refresh",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE\r\n    V_WarehouseID,\r\n    V_InventoryItemID INT; --\r\n  DECLARE\r\n    V_OnHand,\r\n    V_Committed,\r\n    V_OnOrder,\r\n    V_UnAvailable,\r\n    V_Rented,\r\n    V_Sold,\r\n    V_BackOrdered INT; --\r\n  DECLARE\r\n    V_UnitPrice DECIMAL(18, 2); --\r\n\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE cur CURSOR FOR\r\n      SELECT\r\n        summary.WarehouseID\r\n      , summary.InventoryItemID\r\n      , IF(item.Service = 0, IFNULL(summary.OnHand      , 0), 0) as OnHand\r\n      , IF(item.Service = 0, IFNULL(summary.Committed   , 0), 0) as Committed\r\n      , IF(item.Service = 0, IFNULL(summary.OnOrder     , 0), 0) as OnOrder\r\n      , IF(item.Service = 0, IFNULL(summary.UnAvailable , 0), 0) as UnAvailable\r\n      , IF(item.Service = 0, IFNULL(summary.Rented      , 0), 0) as Rented\r\n      , IF(item.Service = 0, IFNULL(summary.Sold        , 0), 0) as Sold\r\n      , IF(item.Service = 0, IFNULL(summary.BackOrdered , 0), 0) as BackOrdered\r\n      , IF(item.Service = 0, IFNULL(tran.Cost / tran.Quantity, IFNULL(summary.TotalCost / summary.TotalQuantity, 0)), 0) as UnitPrice\r\n      FROM (SELECT\r\n              tran.WarehouseID\r\n            , tran.InventoryItemID\r\n            , SUM(CASE WHEN tran_type.OnHand       > 0 THEN tran.Quantity WHEN tran_type.OnHand       < 0 THEN -tran.Quantity ELSE null END) as OnHand\r\n            , SUM(CASE WHEN tran_type.Committed    > 0 THEN tran.Quantity WHEN tran_type.Committed    < 0 THEN -tran.Quantity ELSE null END) as Committed\r\n            , SUM(CASE WHEN tran_type.OnOrder      > 0 THEN tran.Quantity WHEN tran_type.OnOrder      < 0 THEN -tran.Quantity ELSE null END) as OnOrder\r\n            , SUM(CASE WHEN tran_type.UnAvailable  > 0 THEN tran.Quantity WHEN tran_type.UnAvailable  < 0 THEN -tran.Quantity ELSE null END) as UnAvailable\r\n            , SUM(CASE WHEN tran_type.Rented       > 0 THEN tran.Quantity WHEN tran_type.Rented       < 0 THEN -tran.Quantity ELSE null END) as Rented\r\n            , SUM(CASE WHEN tran_type.Sold         > 0 THEN tran.Quantity WHEN tran_type.Sold         < 0 THEN -tran.Quantity ELSE null END) as Sold\r\n            , SUM(CASE WHEN tran_type.BackOrdered  > 0 THEN tran.Quantity WHEN tran_type.BackOrdered  < 0 THEN -tran.Quantity ELSE null END) as BackOrdered\r\n            , SUM(IF(tran_type.AdjTotalCost = 1, tran.Cost    , null)) as TotalCost\r\n            , SUM(IF(tran_type.AdjTotalCost = 1, tran.Quantity, null)) as TotalQuantity\r\n            , MAX(IF(tran_type.Name = 'CostPerUnit Adj', tran.ID, null)) as LastAdjustID\r\n            FROM tbl_inventory_transaction as tran\r\n                 INNER JOIN tbl_inventory_transaction_type as tran_type ON tran.TypeID = tran_type.ID\r\n            WHERE ((P_WarehouseID     IS NULL) OR (tran.WarehouseID     = P_WarehouseID    ))\r\n              AND ((P_InventoryItemID IS NULL) OR (tran.InventoryItemID = P_InventoryItemID))\r\n            GROUP BY tran.WarehouseID, tran.InventoryItemID) as summary\r\n      LEFT JOIN tbl_inventory_transaction as tran ON tran.ID              = summary.LastAdjustID\r\n                                                 AND tran.WarehouseID     = summary.WarehouseID\r\n                                                 AND tran.InventoryItemID = summary.InventoryItemID\r\n      INNER JOIN tbl_inventoryitem as item ON item.ID = summary.InventoryItemID\r\n      WHERE (1 = 1); --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO\r\n      V_WarehouseID\r\n    , V_InventoryItemID\r\n    , V_OnHand\r\n    , V_Committed\r\n    , V_OnOrder\r\n    , V_UnAvailable\r\n    , V_Rented\r\n    , V_Sold\r\n    , V_BackOrdered\r\n    , V_UnitPrice; --\r\n\r\n    IF NOT done THEN\r\n      UPDATE tbl_inventory SET\r\n       OnHand           = V_OnHand\r\n      ,Committed        = V_Committed\r\n      ,OnOrder          = V_OnOrder\r\n      ,UnAvailable      = V_UnAvailable\r\n      ,Rented           = V_Rented\r\n      ,Sold             = V_Sold\r\n      ,BackOrdered      = V_BackOrdered\r\n      ,CostPerUnit      = V_UnitPrice\r\n      ,TotalCost        = V_UnitPrice * (V_OnHand + V_Rented + V_UnAvailable)\r\n      ,LastUpdateUserID = 1\r\n      WHERE (WarehouseID     = V_WarehouseID)\r\n        AND (InventoryItemID = V_InventoryItemID); --\r\n\r\n      IF (ROW_COUNT() = 0) THEN\r\n        INSERT IGNORE INTO tbl_inventory SET\r\n         OnHand           = V_OnHand\r\n        ,Committed        = V_Committed\r\n        ,OnOrder          = V_OnOrder\r\n        ,UnAvailable      = V_UnAvailable\r\n        ,Rented           = V_Rented\r\n        ,Sold             = V_Sold\r\n        ,BackOrdered      = V_BackOrdered\r\n        ,CostPerUnit      = V_UnitPrice\r\n        ,TotalCost        = V_UnitPrice * (V_OnHand + V_Rented + V_UnAvailable)\r\n        ,LastUpdateUserID = 1\r\n        ,ReOrderPoint     = 0\r\n        ,WarehouseID      = V_WarehouseID\r\n        ,InventoryItemID  = V_InventoryItemID; --\r\n      END IF; --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "inventory_transaction_add_adjustment",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_TranTypeID INT; --\r\n\r\n  IF (P_WarehouseID IS NOT NULL) AND (P_InventoryItemID IS NOT NULL) AND (IFNULL(P_Quantity, 0) != 0) THEN\r\n    SELECT ID\r\n    INTO V_TranTypeID\r\n    FROM tbl_inventory_transaction_type\r\n    WHERE (Name = P_Type); --\r\n\r\n    IF (V_TranTypeID IS NOT NULL) THEN\r\n      INSERT INTO tbl_inventory_transaction SET\r\n       WarehouseID            = P_WarehouseID\r\n      ,InventoryItemID        = P_InventoryItemID\r\n      ,TypeID                 = V_TranTypeID\r\n      ,Date                   = Now()\r\n      ,Quantity               = P_Quantity\r\n      ,Cost                   = P_Quantity * P_CostPerUnit\r\n      ,Description            = IFNULL(P_Description, 'No Description')\r\n      ,SerialID               = NULL\r\n      ,VendorID               = NULL\r\n      ,CustomerID             = NULL\r\n      ,LastUpdateUserID       = P_LastUpdateUserID\r\n      ,LastUpdateDatetime     = Now()\r\n      ,PurchaseOrderID        = NULL\r\n      ,PurchaseOrderDetailsID = NULL\r\n      ,InvoiceID              = NULL\r\n      ,ManufacturerID         = NULL\r\n      ,OrderID                = NULL\r\n      ,OrderDetailsID         = NULL; --\r\n    END IF; --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "inventory_transaction_order_cleanup",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  -- delete transactions if corresponding orders or line items do not exist\r\n  DELETE tran\r\n  FROM tbl_inventory_transaction as tran\r\n       LEFT JOIN view_orderdetails as d ON tran.InventoryItemID = d.InventoryItemID\r\n                                       AND tran.WarehouseID     = d.WarehouseID\r\n                                       AND tran.CustomerID      = d.CustomerID\r\n                                       AND tran.OrderID         = d.OrderID\r\n                                       AND tran.OrderDetailsID  = d.ID\r\n       LEFT JOIN tbl_order as o ON d.OrderID    = o.ID\r\n                               AND d.CustomerID = o.CustomerID\r\n  WHERE (tran.OrderID IS NOT NULL)\r\n    AND (o.ID IS NULL); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "inventory_transaction_order_refresh",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  -- type:\r\n  -- Committed\r\n  -- Sold\r\n  -- Rented\r\n  -- Rental Returned\r\n  -- since user with necessary permissions have ability to set Approved = False\r\n  -- we need to delete all transactions for not approved order\r\n  -- and check all warehouses for it.\r\n\r\n  -- if something was severily changed we need to delete\r\n  DELETE tran\r\n  FROM tbl_inventory_transaction as tran\r\n       LEFT JOIN view_orderdetails as d ON tran.InventoryItemID = d.InventoryItemID\r\n                                       AND tran.WarehouseID     = d.WarehouseID\r\n                                       AND tran.CustomerID      = d.CustomerID\r\n                                       AND tran.OrderID         = d.OrderID\r\n                                       AND tran.OrderDetailsID  = d.ID\r\n       LEFT JOIN tbl_order as o ON d.OrderID    = o.ID\r\n                               AND d.CustomerID = o.CustomerID\r\n  WHERE (tran.OrderID = P_OrderID)\r\n    AND (o.ID IS NULL); --\r\n\r\n  -- if transaction type does not correspond to the state of order we need to delete\r\n  DELETE tran\r\n  FROM tbl_inventory_transaction as tran\r\n       INNER JOIN view_orderdetails as d ON tran.InventoryItemID = d.InventoryItemID\r\n                                        AND tran.WarehouseID     = d.WarehouseID\r\n                                        AND tran.CustomerID      = d.CustomerID\r\n                                        AND tran.OrderID         = d.OrderID\r\n                                        AND tran.OrderDetailsID  = d.ID\r\n       INNER JOIN tbl_order as o ON d.OrderID    = o.ID\r\n                                AND d.CustomerID = o.CustomerID\r\n       INNER JOIN tbl_inventory_transaction_type as tt ON tt.ID = tran.TypeID\r\n  WHERE (tran.OrderID = P_OrderID)\r\n    AND NOT CASE tt.Name WHEN 'Committed'       THEN 1\r\n                         WHEN 'Sold'            THEN (o.Approved = 1) AND (o.DeliveryDate IS NOT NULL) AND d.IsSold\r\n                         WHEN 'Rented'          THEN (o.Approved = 1) AND (o.DeliveryDate IS NOT NULL) AND d.IsRented\r\n                         WHEN 'Rental Returned' THEN (o.Approved = 1) AND (o.DeliveryDate IS NOT NULL) AND d.IsRented AND d.IsPickedup\r\n                         ELSE 0 END; --\r\n\r\n  -- if transaction were not removed we have to update it to sync with order\r\n  UPDATE tbl_inventory_transaction as tran\r\n         INNER JOIN view_orderdetails as d ON tran.WarehouseID     = d.WarehouseID\r\n                                          AND tran.InventoryItemID = d.InventoryItemID\r\n                                          AND tran.CustomerID      = d.CustomerID\r\n                                          AND tran.OrderID         = d.OrderID\r\n                                          AND tran.OrderDetailsID  = d.ID\r\n         INNER JOIN tbl_order as o ON d.OrderID = o.ID\r\n                                  AND d.CustomerID = o.CustomerID\r\n         INNER JOIN tbl_inventory_transaction_type as tt ON tt.ID = tran.TypeID\r\n  SET tran.Date        = IFNULL(o.OrderDate, CURRENT_DATE()),\r\n      tran.Quantity    = d.DeliveryQuantity,\r\n      tran.Description = CONCAT('Order #', d.OrderID),\r\n      tran.Cost        = 0,\r\n      tran.SerialID    = NULL,\r\n      tran.VendorID    = NULL,\r\n      tran.InvoiceID   = NULL,\r\n      tran.ManufacturerID = NULL,\r\n      tran.LastUpdateUserID = o.LastUpdateUserID\r\n  WHERE (o.ID = P_OrderID)\r\n    AND CASE tt.Name WHEN 'Committed'       THEN 1\r\n                     WHEN 'Sold'            THEN (o.Approved = 1) AND (o.DeliveryDate IS NOT NULL) AND d.IsSold\r\n                     WHEN 'Rented'          THEN (o.Approved = 1) AND (o.DeliveryDate IS NOT NULL) AND d.IsRented\r\n                     WHEN 'Rental Returned' THEN (o.Approved = 1) AND (o.DeliveryDate IS NOT NULL) AND d.IsRented AND d.IsPickedup\r\n                     ELSE 0 END; --\r\n\r\n  INSERT INTO tbl_inventory_transaction\r\n    (WarehouseID\r\n    ,InventoryItemID\r\n    ,TypeID\r\n    ,Date\r\n    ,Quantity\r\n    ,Cost\r\n    ,Description\r\n    ,CustomerID\r\n    ,OrderID\r\n    ,OrderDetailsID\r\n    ,LastUpdateUserID\r\n    ,SerialID\r\n    ,VendorID\r\n    ,PurchaseOrderID\r\n    ,PurchaseOrderDetailsID\r\n    ,InvoiceID\r\n    ,ManufacturerID)\r\n  SELECT d.WarehouseID,\r\n         d.InventoryItemID,\r\n         tt.ID as TypeID,\r\n         IFNULL(o.OrderDate, CURRENT_DATE()) as Date,\r\n         d.DeliveryQuantity as Quantity,\r\n         0 as Cost,\r\n         CONCAT('Order #', d.OrderID) as Description,\r\n         d.CustomerID,\r\n         d.OrderID,\r\n         d.ID as OrderDetailsID,\r\n         o.LastUpdateUserID,\r\n         NULL as SerialID,\r\n         NULL as VendorID,\r\n         NULL as PurchaseOrderID,\r\n         NULL as PurchaseOrderDetailsID,\r\n         NULL as InvoiceID,\r\n         NULL as ManufacturerID\r\n  FROM view_orderdetails as d\r\n       INNER JOIN tbl_order as o ON d.OrderID    = o.ID\r\n                                AND d.CustomerID = o.CustomerID\r\n       INNER JOIN tbl_inventory_transaction_type as tt ON tt.Name IN ('Committed', 'Sold', 'Rented', 'Rental Returned')\r\n       LEFT JOIN tbl_inventory_transaction as tran ON tran.WarehouseID     = d.WarehouseID\r\n                                                  AND tran.InventoryItemID = d.InventoryItemID\r\n                                                  AND tran.CustomerID      = d.CustomerID\r\n                                                  AND tran.OrderID         = d.OrderID\r\n                                                  AND tran.OrderDetailsID  = d.ID\r\n                                                  AND tran.TypeID          = tt.ID\r\n  WHERE (o.ID = P_OrderID)\r\n    AND (tran.ID IS NULL)\r\n    AND CASE tt.Name WHEN 'Committed'       THEN 1\r\n                     WHEN 'Sold'            THEN (o.Approved = 1) AND (o.DeliveryDate IS NOT NULL) AND d.IsSold\r\n                     WHEN 'Rented'          THEN (o.Approved = 1) AND (o.DeliveryDate IS NOT NULL) AND d.IsRented\r\n                     WHEN 'Rental Returned' THEN (o.Approved = 1) AND (o.DeliveryDate IS NOT NULL) AND d.IsRented AND d.IsPickedup\r\n                     ELSE 0 END; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "inventory_transaction_po_refresh",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  -- 'Ordered'\r\n  -- 'Received'\r\n  -- 'BackOrdered'\r\n  UPDATE tbl_inventory_transaction as tran\r\n         INNER JOIN tbl_purchaseorderdetails as podetails ON tran.WarehouseID = podetails.WarehouseID\r\n                                                         AND tran.InventoryItemID = podetails.InventoryItemID\r\n                                                         AND tran.PurchaseOrderID = podetails.PurchaseOrderID\r\n                                                         AND tran.PurchaseOrderDetailsID = podetails.ID\r\n         INNER JOIN tbl_purchaseorder as po ON podetails.PurchaseOrderID = po.ID\r\n         INNER JOIN tbl_inventory_transaction_type ON tbl_inventory_transaction_type.ID   = tran.TypeID\r\n                                                  AND tbl_inventory_transaction_type.Name = P_Type\r\n  SET tran.Date = CASE P_Type WHEN 'Ordered'     THEN IFNULL(po.OrderDate   , CURRENT_DATE())\r\n                              WHEN 'Received'    THEN IFNULL(podetails.DateReceived, CURRENT_DATE())\r\n                              WHEN 'BackOrdered' THEN IFNULL(podetails.DateReceived, CURRENT_DATE())\r\n                              ELSE 0 END,\r\n      tran.Quantity = CASE P_Type WHEN 'Ordered'     THEN podetails.Ordered\r\n                                  WHEN 'Received'    THEN podetails.Received\r\n                                  WHEN 'BackOrdered' THEN podetails.Ordered - podetails.Received\r\n                                  ELSE 0 END,\r\n      tran.Cost = CASE P_Type WHEN 'Ordered'     THEN 0\r\n                              WHEN 'Received'    THEN IFNULL(podetails.Received, 0) * IFNULL(podetails.Price, 0)\r\n                              WHEN 'BackOrdered' THEN 0\r\n                              ELSE 0 END,\r\n      tran.Description = CONCAT('PO #', podetails.PurchaseOrderID),\r\n      tran.SerialID = NULL,\r\n      tran.VendorID = po.VendorID,\r\n      tran.CustomerID = NULL,\r\n      tran.InvoiceID  = NULL,\r\n      tran.ManufacturerID = NULL,\r\n      tran.OrderDetailsID = NULL,\r\n      tran.LastUpdateUserID = po.LastUpdateUserID\r\n  WHERE (po.ID = P_PurchaseOrderID)\r\n    AND (po.Approved = 1)\r\n    AND CASE P_Type WHEN 'Ordered'     THEN (0 < podetails.Ordered)\r\n                    WHEN 'Received'    THEN (0 < podetails.Ordered) AND (0 < podetails.Received)\r\n                    WHEN 'BackOrdered' THEN (0 < podetails.Ordered) AND (0 < podetails.Received) -- AND (podetails.Received < podetails.Ordered)\r\n                    ELSE 0 END; --\r\n\r\n  INSERT INTO tbl_inventory_transaction\r\n  (WarehouseID,\r\n   InventoryItemID,\r\n   TypeID,\r\n   Date,\r\n   Quantity,\r\n   Cost,\r\n   Description,\r\n   SerialID,\r\n   VendorID,\r\n   CustomerID,\r\n   LastUpdateUserID,\r\n   PurchaseOrderID,\r\n   PurchaseOrderDetailsID,\r\n   InvoiceID,\r\n   ManufacturerID,\r\n   OrderDetailsID)\r\n  SELECT podetails.WarehouseID,\r\n         podetails.InventoryItemID,\r\n         tran_type.ID as TypeID,\r\n         CASE P_Type WHEN 'Ordered'     THEN IFNULL(po.OrderDate   , CURRENT_DATE())\r\n                     WHEN 'Received'    THEN IFNULL(podetails.DateReceived, CURRENT_DATE())\r\n                     WHEN 'BackOrdered' THEN IFNULL(podetails.DateReceived, CURRENT_DATE())\r\n                     ELSE 0 END as Date,\r\n         CASE P_Type WHEN 'Ordered'     THEN podetails.Ordered\r\n                     WHEN 'Received'    THEN podetails.Received\r\n                     WHEN 'BackOrdered' THEN podetails.Ordered - podetails.Received\r\n                     ELSE 0 END as Quantity,\r\n         CASE P_Type WHEN 'Ordered'     THEN 0\r\n                     WHEN 'Received'    THEN IFNULL(podetails.Received, 0) * IFNULL(podetails.Price, 0)\r\n                     WHEN 'BackOrdered' THEN 0\r\n                     ELSE 0 END as Cost,\r\n         CONCAT('PO #', podetails.PurchaseOrderID) as Description,\r\n         NULL as SerialID,\r\n         po.VendorID,\r\n         NULL as CustomerID,\r\n         po.LastUpdateUserID,\r\n         podetails.PurchaseOrderID,\r\n         podetails.ID as PurchaseOrderDetailsID,\r\n         NULL as InvoiceID,\r\n         NULL as ManufacturerID,\r\n         NULL as OrderDetailsID\r\n  FROM tbl_purchaseorderdetails as podetails\r\n       INNER JOIN tbl_purchaseorder as po ON podetails.PurchaseOrderID = po.ID\r\n       INNER JOIN tbl_inventory_transaction_type as tran_type ON tran_type.Name = P_Type\r\n       LEFT JOIN tbl_inventory_transaction as tran ON tran.WarehouseID = podetails.WarehouseID\r\n                                                  AND tran.InventoryItemID = podetails.InventoryItemID\r\n                                                  AND tran.PurchaseOrderID = podetails.PurchaseOrderID\r\n                                                  AND tran.PurchaseOrderDetailsID = podetails.ID\r\n                                                  AND tran.TypeID = tran_type.ID\r\n  WHERE (po.ID = P_PurchaseOrderID)\r\n    AND (po.Approved = 1)\r\n    AND (tran.ID IS NULL)\r\n    AND CASE P_Type WHEN 'Ordered'     THEN (0 < podetails.Ordered)\r\n                    WHEN 'Received'    THEN (0 < podetails.Ordered) AND (0 < podetails.Received)\r\n                    WHEN 'BackOrdered' THEN (0 < podetails.Ordered) AND (0 < podetails.Received) -- AND (podetails.Received < podetails.Ordered)\r\n                    ELSE 0 END; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "inventory_transfer",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  CALL internal_inventory_transfer(\r\n    P_InventoryItemID\r\n  , P_SrcWarehouseID\r\n  , P_DstWarehouseID\r\n  , P_Quantity\r\n  , 'Inventory Transfer'\r\n  , P_LastUpdateUserID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_AddAutoSubmit",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "PROC: BEGIN\r\n  DECLARE V_CustomerID, V_InvoiceID, V_InvoiceDetailsID INT; --\r\n  DECLARE V_TransmittedCustomerInsuranceID, V_TransmittedInsuranceCompanyID INT; --\r\n  DECLARE V_Billable DECIMAL(18, 2); --\r\n  DECLARE V_Quantity, V_Count INT; --\r\n\r\n  SELECT\r\n   `detail`.CustomerID,\r\n   `detail`.InvoiceID,\r\n   `detail`.ID as InvoiceDetailsID,\r\n   CASE WHEN ins1.InsuranceCompanyID = P_InsuranceCompanyID THEN ins1.ID\r\n        WHEN ins2.InsuranceCompanyID = P_InsuranceCompanyID THEN ins2.ID\r\n        WHEN ins3.InsuranceCompanyID = P_InsuranceCompanyID THEN ins3.ID\r\n        WHEN ins4.InsuranceCompanyID = P_InsuranceCompanyID THEN ins4.ID\r\n        ELSE NULL END AS TransmittedCustomerInsuranceID,\r\n   CASE WHEN ins1.InsuranceCompanyID = P_InsuranceCompanyID THEN ins1.InsuranceCompanyID\r\n        WHEN ins2.InsuranceCompanyID = P_InsuranceCompanyID THEN ins2.InsuranceCompanyID\r\n        WHEN ins3.InsuranceCompanyID = P_InsuranceCompanyID THEN ins3.InsuranceCompanyID\r\n        WHEN ins4.InsuranceCompanyID = P_InsuranceCompanyID THEN ins4.InsuranceCompanyID\r\n        ELSE NULL END AS TransmittedInsuranceCompanyID,\r\n   `detail`.BillableAmount,\r\n   `detail`.Quantity\r\n  INTO\r\n    V_CustomerID,\r\n    V_InvoiceID,\r\n    V_InvoiceDetailsID,\r\n    V_TransmittedCustomerInsuranceID,\r\n    V_TransmittedInsuranceCompanyID,\r\n    V_Billable,\r\n    V_Quantity\r\n  FROM tbl_invoicedetails as `detail`\r\n       INNER JOIN tbl_invoice as `invoice` ON `detail`.InvoiceID  = `invoice`.ID\r\n                                          AND `detail`.CustomerID = `invoice`.CustomerID\r\n       LEFT JOIN `tbl_customer_insurance` as `ins1` ON `ins1`.ID         = `invoice`.CustomerInsurance1_ID\r\n                                                   AND `ins1`.CustomerID = `invoice`.CustomerID\r\n                                                   AND `detail`.BillIns1 = 1\r\n       LEFT JOIN `tbl_customer_insurance` as `ins2` ON `ins2`.ID         = `invoice`.CustomerInsurance2_ID\r\n                                                   AND `ins2`.CustomerID = `invoice`.CustomerID\r\n                                                   AND `detail`.BillIns2 = 1\r\n       LEFT JOIN `tbl_customer_insurance` as `ins3` ON `ins3`.ID         = `invoice`.CustomerInsurance3_ID\r\n                                                   AND `ins3`.CustomerID = `invoice`.CustomerID\r\n                                                   AND `detail`.BillIns3 = 1\r\n       LEFT JOIN `tbl_customer_insurance` as `ins4` ON `ins4`.ID         = `invoice`.CustomerInsurance4_ID\r\n                                                   AND `ins4`.CustomerID = `invoice`.CustomerID\r\n                                                   AND `detail`.BillIns4 = 1\r\n  WHERE (`detail`.ID = P_InvoiceDetailsID); --\r\n\r\n  IF (V_CustomerID IS NULL) OR (V_InvoiceID IS NULL) OR (V_InvoiceDetailsID IS NULL) THEN\r\n    SET P_Result = 'InvoiceDetailsID is wrong'; --\r\n    LEAVE PROC; --\r\n  END IF; --\r\n\r\n  IF (V_TransmittedCustomerInsuranceID IS NULL) OR (V_TransmittedInsuranceCompanyID IS NULL) THEN\r\n    SET P_Result = 'Autosubmitted Company ID is wrong'; --\r\n    LEAVE PROC; --\r\n  END IF; --\r\n\r\n  SELECT COUNT(*)\r\n  INTO V_Count\r\n  FROM tbl_invoice_transaction as it\r\n       INNER JOIN tbl_invoice_transactiontype as tt ON it.TransactionTypeID = tt.ID\r\n  WHERE (tt.Name               = 'Auto Submit'                  )\r\n    AND (it.CustomerID         = V_CustomerID                   )\r\n    AND (it.InvoiceID          = V_InvoiceID                    )\r\n    AND (it.InvoiceDetailsID   = V_InvoiceDetailsID             )\r\n    AND (it.InsuranceCompanyID = V_TransmittedInsuranceCompanyID); --\r\n\r\n  IF 0 < V_Count THEN\r\n    SET P_Result = 'Transaction already exists'; --\r\n    LEAVE PROC; --\r\n  END IF; --\r\n\r\n  INSERT INTO tbl_invoice_transaction (\r\n    InvoiceDetailsID\r\n  , InvoiceID\r\n  , CustomerID\r\n  , InsuranceCompanyID\r\n  , CustomerInsuranceID\r\n  , TransactionTypeID\r\n  , TransactionDate\r\n  , Amount\r\n  , Quantity\r\n  , Taxes\r\n  , BatchNumber\r\n  , Comments\r\n  , Extra\r\n  , Approved\r\n  , LastUpdateUserID)\r\n  SELECT\r\n    V_InvoiceDetailsID\r\n  , V_InvoiceID\r\n  , V_CustomerID\r\n  , V_TransmittedInsuranceCompanyID\r\n  , V_TransmittedCustomerInsuranceID\r\n  , ID as TransactionTypeID\r\n  , P_TransactionDate\r\n  , V_Billable as Amount\r\n  , V_Quantity as Quantity\r\n  , 0.00       as Taxes\r\n  , ''         as BatchNumber\r\n  , 'EDI'      as Comments\r\n  , null       as Extra\r\n  , 1          as Approved\r\n  , P_LastUpdateUserID\r\n  FROM tbl_invoice_transactiontype\r\n  WHERE (Name = 'Auto Submit'); --\r\n\r\n  SET P_Result = 'Success'; --\r\nEND PROC",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "MODIFIES SQL DATA"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_AddPayment",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "PROC: BEGIN\r\n  DECLARE V_CustomerID, V_InvoiceID, V_InvoiceDetailsID, V_CustomerInsuranceID, V_InsuranceCompanyID INT; --\r\n  DECLARE V_BasisAllowable, V_FirstInsurance BOOL; --\r\n  DECLARE V_AllowableAmount, V_BillableAmount DECIMAL(18, 2); --\r\n  DECLARE V_Quantity, V_Count INT; --\r\n  DECLARE V_ExtraPaid, V_ExtraAllowable, V_ExtraDeductible, V_ExtraCheckNumber, V_ExtraPostingGuid, V_ExtraSequestration, V_ExtraContractualWriteoff VARCHAR(18); --\r\n  DECLARE V_NumericRegexp VARCHAR(50); --\r\n  DECLARE V_PaymentPaidAmount, V_PaymentAllowableAmount, V_PaymentDeductibleAmount, V_PaymentSequestrationAmount, V_PaymentContractualWriteoffAmount DECIMAL(18, 2); --\r\n\r\n  SET V_ExtraPaid                = ExtractValue(P_Extra, 'values/v[@n=\"Paid\"]/text()'); --\r\n  SET V_ExtraAllowable           = ExtractValue(P_Extra, 'values/v[@n=\"Allowable\"]/text()'); --\r\n  SET V_ExtraCheckNumber         = ExtractValue(P_Extra, 'values/v[@n=\"CheckNumber\"]/text()'); --\r\n  SET V_ExtraPostingGuid         = ExtractValue(P_Extra, 'values/v[@n=\"PostingGuid\"]/text()'); --\r\n  SET V_ExtraDeductible          = ExtractValue(P_Extra, 'values/v[@n=\"Deductible\"]/text()'); --\r\n  SET V_ExtraSequestration       = ExtractValue(P_Extra, 'values/v[@n=\"Sequestration\"]/text()'); --\r\n  SET V_ExtraContractualWriteoff = ExtractValue(P_Extra, 'values/v[@n=\"ContractualWriteoff\"]/text()'); --\r\n\r\n  SET V_NumericRegexp = '^(-|\\+)?([0-9]+\\.[0-9]*|[0-9]*\\.[0-9]+|[0-9]+)$'; --\r\n\r\n  SET V_PaymentPaidAmount                = CASE WHEN V_ExtraPaid                REGEXP V_NumericRegexp THEN V_ExtraPaid                ELSE NULL END; --\r\n  SET V_PaymentAllowableAmount           = CASE WHEN V_ExtraAllowable           REGEXP V_NumericRegexp THEN V_ExtraAllowable           ELSE NULL END; --\r\n  SET V_PaymentDeductibleAmount          = CASE WHEN V_ExtraDeductible          REGEXP V_NumericRegexp THEN V_ExtraDeductible          ELSE NULL END; --\r\n  SET V_PaymentSequestrationAmount       = CASE WHEN V_ExtraSequestration       REGEXP V_NumericRegexp THEN V_ExtraSequestration       ELSE NULL END; --\r\n  SET V_PaymentContractualWriteoffAmount = CASE WHEN V_ExtraContractualWriteoff REGEXP V_NumericRegexp THEN V_ExtraContractualWriteoff ELSE NULL END; --\r\n\r\n  IF (V_PaymentPaidAmount IS NULL) THEN\r\n    SET P_Result = 'Paid amount is not specified'; --\r\n    LEAVE PROC; --\r\n  END IF; --\r\n\r\n  SELECT\r\n   `detail`.CustomerID,\r\n   `detail`.InvoiceID,\r\n   `detail`.ID as InvoiceDetailsID,\r\n   CASE WHEN ins1.InsuranceCompanyID = P_InsuranceCompanyID THEN ins1.ID\r\n        WHEN ins2.InsuranceCompanyID = P_InsuranceCompanyID THEN ins2.ID\r\n        WHEN ins3.InsuranceCompanyID = P_InsuranceCompanyID THEN ins3.ID\r\n        WHEN ins4.InsuranceCompanyID = P_InsuranceCompanyID THEN ins4.ID\r\n        ELSE NULL END AS CustomerInsuranceID,\r\n   CASE WHEN ins1.InsuranceCompanyID = P_InsuranceCompanyID THEN ins1.InsuranceCompanyID\r\n        WHEN ins2.InsuranceCompanyID = P_InsuranceCompanyID THEN ins2.InsuranceCompanyID\r\n        WHEN ins3.InsuranceCompanyID = P_InsuranceCompanyID THEN ins3.InsuranceCompanyID\r\n        WHEN ins4.InsuranceCompanyID = P_InsuranceCompanyID THEN ins4.InsuranceCompanyID\r\n        ELSE NULL END AS InsuranceCompanyID,\r\n   CASE WHEN ins1.ID IS NOT NULL THEN ins1.InsuranceCompanyID = P_InsuranceCompanyID\r\n        WHEN ins2.ID IS NOT NULL THEN ins2.InsuranceCompanyID = P_InsuranceCompanyID\r\n        WHEN ins3.ID IS NOT NULL THEN ins3.InsuranceCompanyID = P_InsuranceCompanyID\r\n        WHEN ins4.ID IS NOT NULL THEN ins4.InsuranceCompanyID = P_InsuranceCompanyID\r\n        ELSE 0 END AS FirstInsurance,\r\n   CASE WHEN ins1.ID IS NOT NULL THEN ins1.Basis = 'Allowed'\r\n        WHEN ins2.ID IS NOT NULL THEN ins2.Basis = 'Allowed'\r\n        WHEN ins3.ID IS NOT NULL THEN ins3.Basis = 'Allowed'\r\n        WHEN ins4.ID IS NOT NULL THEN ins4.Basis = 'Allowed'\r\n        ELSE 0 END AS BasisAllowable,\r\n   `detail`.AllowableAmount,\r\n   `detail`.BillableAmount,\r\n   `detail`.Quantity\r\n  INTO\r\n    V_CustomerID,\r\n    V_InvoiceID,\r\n    V_InvoiceDetailsID,\r\n    V_CustomerInsuranceID,\r\n    V_InsuranceCompanyID,\r\n    V_FirstInsurance,\r\n    V_BasisAllowable,\r\n    V_AllowableAmount,\r\n    V_BillableAmount,\r\n    V_Quantity\r\n  FROM tbl_invoicedetails as `detail`\r\n       INNER JOIN tbl_invoice as `invoice` ON `detail`.InvoiceID  = `invoice`.ID\r\n                                          AND `detail`.CustomerID = `invoice`.CustomerID\r\n       LEFT JOIN `tbl_customer_insurance` as ins1 ON ins1.ID         = `invoice`.CustomerInsurance1_ID\r\n                                                 AND ins1.CustomerID = `invoice`.CustomerID\r\n                                                 AND `detail`.BillIns1 = 1\r\n       LEFT JOIN `tbl_customer_insurance` as ins2 ON ins2.ID         = `invoice`.CustomerInsurance2_ID\r\n                                                 AND ins2.CustomerID = `invoice`.CustomerID\r\n                                                 AND `detail`.BillIns2 = 1\r\n       LEFT JOIN `tbl_customer_insurance` as ins3 ON ins3.ID         = `invoice`.CustomerInsurance3_ID\r\n                                                 AND ins3.CustomerID = `invoice`.CustomerID\r\n                                                 AND `detail`.BillIns3 = 1\r\n       LEFT JOIN `tbl_customer_insurance` as ins4 ON ins4.ID         = `invoice`.CustomerInsurance4_ID\r\n                                                 AND ins4.CustomerID = `invoice`.CustomerID\r\n                                                 AND `detail`.BillIns4 = 1\r\n  WHERE (`detail`.ID = P_InvoiceDetailsID); --\r\n\r\n  IF (V_CustomerID IS NULL)\r\n  OR (V_InvoiceID IS NULL)\r\n  OR (V_InvoiceDetailsID IS NULL) THEN\r\n    SET P_Result = 'InvoiceDetailsID is wrong'; --\r\n    LEAVE PROC; --\r\n  END IF; --\r\n\r\n  IF ((V_InsuranceCompanyID IS NULL) != (P_InsuranceCompanyID IS NULL)) THEN\r\n    SET P_Result = 'InsuranceCompanyID is wrong'; --\r\n    LEAVE PROC; --\r\n  END IF; --\r\n\r\n  IF (V_ExtraCheckNumber != '')\r\n  AND (V_ExtraPostingGuid != '') THEN\r\n    -- if we got both check number and posting guid we have to check that\r\n    -- there are no other payment / denied transactions with same check number but different PostingGuid\r\n    -- that way we allow posting multiple transaction for same checknumber\r\n    -- but prevent autoposting from posting same check (and 835) twice since PostingGuid is used only by auto posting\r\n    SELECT SUM(CASE WHEN ExtractValue(it.Extra, 'values/v[@n=\"CheckNumber\"]/text()') = V_ExtraCheckNumber\r\n                     AND ExtractValue(it.Extra, 'values/v[@n=\"PostingGuid\"]/text()') != V_ExtraPostingGuid\r\n                    THEN 1 ELSE 0 END)\r\n    INTO V_Count\r\n    FROM tbl_invoice_transaction as it\r\n         INNER JOIN tbl_invoice_transactiontype as tt ON it.TransactionTypeID = tt.ID\r\n    WHERE (tt.Name IN ('Denied', 'Payment'))\r\n      AND (it.CustomerID         = V_CustomerID        )\r\n      AND (it.InvoiceID          = V_InvoiceID         )\r\n      AND (it.InvoiceDetailsID   = V_InvoiceDetailsID  )\r\n      AND (it.InsuranceCompanyID = V_InsuranceCompanyID OR (it.InsuranceCompanyID IS NULL AND V_InsuranceCompanyID IS NULL)); --\r\n\r\n    IF V_Count != 0 THEN\r\n      SET P_Result = CONCAT('Payment for check# ', V_ExtraCheckNumber, ' does already exist'); --\r\n      LEAVE PROC; --\r\n    END IF; --\r\n  END IF; --\r\n\r\n  -- 'Adjust Allowable' - optional\r\n  -- 'Denied' IF Amount = 0 - optional\r\n  -- 'Payment' OTHERWISE\r\n  -- 'Contractual Writeoff'\r\n  -- 'Deductible'\r\n  -- 'Auto Submit'\r\n  -- 'Sequestration Writeoff'\r\n  -- 'Hardship Writeoff'\r\n  -- 'Balance Writeoff' - optional\r\n\r\n  IF (0 < FIND_IN_SET('Adjust Allowable', P_Options))\r\n  AND (V_CustomerInsuranceID IS NOT NULL)\r\n  AND (V_InsuranceCompanyID IS NOT NULL)\r\n  AND (V_FirstInsurance = 1)\r\n  AND (0.01 <= ABS(V_PaymentAllowableAmount - V_AllowableAmount)) THEN\r\n    -- we should add transaction only once\r\n    SELECT COUNT(*)\r\n    INTO V_Count\r\n    FROM tbl_invoice_transaction as it\r\n         INNER JOIN tbl_invoice_transactiontype as tt ON it.TransactionTypeID = tt.ID\r\n    WHERE (tt.Name = 'Adjust Allowable')\r\n      AND (it.CustomerID         = V_CustomerID        )\r\n      AND (it.InvoiceID          = V_InvoiceID         )\r\n      AND (it.InvoiceDetailsID   = V_InvoiceDetailsID  )\r\n      AND (it.InsuranceCompanyID = V_InsuranceCompanyID); --\r\n\r\n    IF V_Count = 0 THEN\r\n      INSERT INTO tbl_invoice_transaction (\r\n        InvoiceDetailsID\r\n      , InvoiceID\r\n      , CustomerID\r\n      , InsuranceCompanyID\r\n      , CustomerInsuranceID\r\n      , TransactionTypeID\r\n      , TransactionDate\r\n      , Amount\r\n      , Quantity\r\n      , Taxes\r\n      , BatchNumber\r\n      , Comments\r\n      , Extra\r\n      , Approved\r\n      , LastUpdateUserID)\r\n      SELECT\r\n        V_InvoiceDetailsID\r\n      , V_InvoiceID\r\n      , V_CustomerID\r\n      , V_InsuranceCompanyID\r\n      , V_CustomerInsuranceID\r\n      , ID   as TransactionTypeID\r\n      , P_TransactionDate\r\n      , V_PaymentAllowableAmount\r\n      , V_Quantity\r\n      , 0.00       as Taxes\r\n      , ''         as BatchNumber\r\n      , P_Comments as Comments\r\n      , null       as Extra\r\n      , 1          as Approved\r\n      , P_LastUpdateUserID\r\n      FROM tbl_invoice_transactiontype\r\n      WHERE (Name = 'Adjust Allowable'); --\r\n\r\n      SET V_AllowableAmount = V_PaymentAllowableAmount; --\r\n    END IF; --\r\n  END IF; --\r\n\r\n  IF (0 < FIND_IN_SET('Post Denied', P_Options))\r\n  AND (ABS(V_PaymentPaidAmount) < 0.01) THEN\r\n    -- we allow adding 'denied' transaction many times since they will not affect anything\r\n    INSERT INTO tbl_invoice_transaction (\r\n      InvoiceDetailsID\r\n    , InvoiceID\r\n    , CustomerID\r\n    , InsuranceCompanyID\r\n    , CustomerInsuranceID\r\n    , TransactionTypeID\r\n    , TransactionDate\r\n    , Amount\r\n    , Quantity\r\n    , Taxes\r\n    , BatchNumber\r\n    , Comments\r\n    , Extra\r\n    , Approved\r\n    , LastUpdateUserID)\r\n    SELECT\r\n      V_InvoiceDetailsID\r\n    , V_InvoiceID\r\n    , V_CustomerID\r\n    , V_InsuranceCompanyID\r\n    , V_CustomerInsuranceID\r\n    , ID as TransactionTypeID\r\n    , P_TransactionDate\r\n    , 0.00       as Amount\r\n    , V_Quantity\r\n    , 0.00       as Taxes\r\n    , ''         as BatchNumber\r\n    , P_Comments as Comments\r\n    , P_Extra    as Extra\r\n    , 1          as Approved\r\n    , P_LastUpdateUserID\r\n    FROM tbl_invoice_transactiontype\r\n    WHERE (Name = 'Denied'); --\r\n  ELSE\r\n    INSERT INTO tbl_invoice_transaction (\r\n      InvoiceDetailsID\r\n    , InvoiceID\r\n    , CustomerID\r\n    , InsuranceCompanyID\r\n    , CustomerInsuranceID\r\n    , TransactionTypeID\r\n    , TransactionDate\r\n    , Amount\r\n    , Quantity\r\n    , Taxes\r\n    , BatchNumber\r\n    , Comments\r\n    , Extra\r\n    , Approved\r\n    , LastUpdateUserID)\r\n    SELECT\r\n      V_InvoiceDetailsID\r\n    , V_InvoiceID\r\n    , V_CustomerID\r\n    , V_InsuranceCompanyID\r\n    , V_CustomerInsuranceID\r\n    , ID as TransactionTypeID\r\n    , P_TransactionDate\r\n    , V_PaymentPaidAmount\r\n    , V_Quantity\r\n    , 0.00       as Taxes\r\n    , ''         as BatchNumber\r\n    , P_Comments as Comments\r\n    , P_Extra    as Extra\r\n    , 1          as Approved\r\n    , P_LastUpdateUserID\r\n    FROM tbl_invoice_transactiontype\r\n    WHERE (Name = 'Payment'); --\r\n  END IF; --\r\n\r\n  IF (V_CustomerInsuranceID IS NOT NULL)\r\n  AND (V_InsuranceCompanyID IS NOT NULL) THEN\r\n    IF (0.01 <= ABS(V_PaymentSequestrationAmount)) THEN\r\n      INSERT INTO tbl_invoice_transaction (\r\n        InvoiceDetailsID\r\n      , InvoiceID\r\n      , CustomerID\r\n      , InsuranceCompanyID\r\n      , CustomerInsuranceID\r\n      , TransactionTypeID\r\n      , TransactionDate\r\n      , Amount\r\n      , Quantity\r\n      , Taxes\r\n      , BatchNumber\r\n      , Comments\r\n      , Extra\r\n      , Approved\r\n      , LastUpdateUserID)\r\n      SELECT\r\n        V_InvoiceDetailsID\r\n      , V_InvoiceID\r\n      , V_CustomerID\r\n      , V_InsuranceCompanyID\r\n      , V_CustomerInsuranceID\r\n      , ID as TransactionTypeID\r\n      , P_TransactionDate\r\n      , V_PaymentSequestrationAmount\r\n      , V_Quantity\r\n      , 0.00       as Taxes\r\n      , ''         as BatchNumber\r\n      , 'Sequestration Writeoff' as Comments\r\n      , null       as Extra\r\n      , 1          as Approved\r\n      , P_LastUpdateUserID\r\n      FROM tbl_invoice_transactiontype\r\n      WHERE (Name = 'Writeoff'); --\r\n    END IF; --\r\n\r\n    IF (V_FirstInsurance = 1)\r\n    AND (0.01 <= ABS(V_PaymentContractualWriteoffAmount)) THEN\r\n      INSERT INTO tbl_invoice_transaction (\r\n        InvoiceDetailsID\r\n      , InvoiceID\r\n      , CustomerID\r\n      , InsuranceCompanyID\r\n      , CustomerInsuranceID\r\n      , TransactionTypeID\r\n      , TransactionDate\r\n      , Amount\r\n      , Quantity\r\n      , Taxes\r\n      , BatchNumber\r\n      , Comments\r\n      , Extra\r\n      , Approved\r\n      , LastUpdateUserID)\r\n      SELECT\r\n        V_InvoiceDetailsID\r\n      , V_InvoiceID\r\n      , V_CustomerID\r\n      , V_InsuranceCompanyID\r\n      , V_CustomerInsuranceID\r\n      , ID as TransactionTypeID\r\n      , P_TransactionDate\r\n      , V_PaymentContractualWriteoffAmount\r\n      , V_Quantity\r\n      , 0.00       as Taxes\r\n      , ''         as BatchNumber\r\n      , P_Comments as Comments\r\n      , null       as Extra\r\n      , 1          as Approved\r\n      , P_LastUpdateUserID\r\n      FROM tbl_invoice_transactiontype\r\n      WHERE (Name = 'Contractual Writeoff'); --\r\n    ELSEIF (V_FirstInsurance = 1)\r\n    AND (V_BasisAllowable = 1)\r\n    AND (0.01 <= V_BillableAmount - V_AllowableAmount) THEN\r\n      SELECT COUNT(*)\r\n      INTO V_Count\r\n      FROM tbl_invoice_transaction as it\r\n           INNER JOIN tbl_invoice_transactiontype as tt ON it.TransactionTypeID = tt.ID\r\n      WHERE (tt.Name               = 'Contractual Writeoff')\r\n        AND (it.CustomerID         = V_CustomerID          )\r\n        AND (it.InvoiceID          = V_InvoiceID           )\r\n        AND (it.InvoiceDetailsID   = V_InvoiceDetailsID    )\r\n        AND (it.InsuranceCompanyID = V_InsuranceCompanyID  ); --\r\n\r\n      IF V_Count = 0 THEN\r\n        INSERT INTO tbl_invoice_transaction (\r\n          InvoiceDetailsID\r\n        , InvoiceID\r\n        , CustomerID\r\n        , InsuranceCompanyID\r\n        , CustomerInsuranceID\r\n        , TransactionTypeID\r\n        , TransactionDate\r\n        , Amount\r\n        , Quantity\r\n        , Taxes\r\n        , BatchNumber\r\n        , Comments\r\n        , Extra\r\n        , Approved\r\n        , LastUpdateUserID)\r\n        SELECT\r\n          V_InvoiceDetailsID\r\n        , V_InvoiceID\r\n        , V_CustomerID\r\n        , V_InsuranceCompanyID\r\n        , V_CustomerInsuranceID\r\n        , ID as TransactionTypeID\r\n        , P_TransactionDate\r\n        , V_BillableAmount - V_AllowableAmount\r\n        , V_Quantity\r\n        , 0.00       as Taxes\r\n        , ''         as BatchNumber\r\n        , P_Comments as Comments\r\n        , null       as Extra\r\n        , 1          as Approved\r\n        , P_LastUpdateUserID\r\n        FROM tbl_invoice_transactiontype\r\n        WHERE (Name = 'Contractual Writeoff'); --\r\n      END IF; --\r\n    END IF; --\r\n\r\n    IF (V_FirstInsurance = 1)\r\n    AND (0.01 <= V_PaymentDeductibleAmount) THEN\r\n      SELECT COUNT(*)\r\n      INTO V_Count\r\n      FROM tbl_invoice_transaction as it\r\n           INNER JOIN tbl_invoice_transactiontype as tt ON it.TransactionTypeID = tt.ID\r\n      WHERE (tt.Name               = 'Deductible'        )\r\n        AND (it.CustomerID         = V_CustomerID        )\r\n        AND (it.InvoiceID          = V_InvoiceID         )\r\n        AND (it.InvoiceDetailsID   = V_InvoiceDetailsID  )\r\n        AND (it.InsuranceCompanyID = V_InsuranceCompanyID); --\r\n\r\n      IF V_Count = 0 THEN\r\n        INSERT INTO tbl_invoice_transaction (\r\n          InvoiceDetailsID\r\n        , InvoiceID\r\n        , CustomerID\r\n        , InsuranceCompanyID\r\n        , CustomerInsuranceID\r\n        , TransactionTypeID\r\n        , TransactionDate\r\n        , Amount\r\n        , Quantity\r\n        , Taxes\r\n        , BatchNumber\r\n        , Comments\r\n        , Extra\r\n        , Approved\r\n        , LastUpdateUserID)\r\n        SELECT\r\n          V_InvoiceDetailsID\r\n        , V_InvoiceID\r\n        , V_CustomerID\r\n        , V_InsuranceCompanyID\r\n        , V_CustomerInsuranceID\r\n        , ID as TransactionTypeID\r\n        , P_TransactionDate\r\n        , V_PaymentDeductibleAmount\r\n        , V_Quantity\r\n        , 0.00       as Taxes\r\n        , ''         as BatchNumber\r\n        , P_Comments as Comments\r\n        , null       as Extra\r\n        , 1          as Approved\r\n        , P_LastUpdateUserID\r\n        FROM tbl_invoice_transactiontype\r\n        WHERE (Name = 'Deductible'); --\r\n      END IF; --\r\n    END IF; --\r\n  END IF; --\r\n\r\n  CALL InvoiceDetails_RecalculateInternals_Single(null, P_InvoiceDetailsID); --\r\n  -- for the following operations we need updated balance so we need to recalculate it\r\n\r\n  INSERT INTO tbl_invoice_transaction (\r\n    InvoiceDetailsID\r\n  , InvoiceID\r\n  , CustomerID\r\n  , InsuranceCompanyID\r\n  , CustomerInsuranceID\r\n  , TransactionTypeID\r\n  , TransactionDate\r\n  , Amount\r\n  , Quantity\r\n  , Comments\r\n  , Taxes\r\n  , BatchNumber\r\n  , Extra\r\n  , Approved\r\n  , LastUpdateUserID)\r\n  SELECT\r\n    det.ID as InvoiceDetailsID\r\n  , det.InvoiceID\r\n  , det.CustomerID\r\n  , det.CurrentInsuranceCompanyID\r\n  , det.CurrentCustomerInsuranceID\r\n  , itt.ID as TransactionTypeID\r\n  , NOW() as TransactionDate\r\n  , det.Balance\r\n  , det.Quantity\r\n  , CASE WHEN det.Hardship = 1 THEN 'Hardship Writeoff' ELSE CONCAT('Wrote off by ', IFNULL(usr.Login, '?')) END AS Comments\r\n  , 0.00 as Taxes\r\n  , ''   as BatchNumber\r\n  , null as Extra\r\n  , 1    as Approved\r\n  , P_LastUpdateUserID\r\n  FROM tbl_invoicedetails as det\r\n       INNER JOIN tbl_invoice_transactiontype as itt ON itt.Name = 'Writeoff'\r\n       LEFT JOIN tbl_user as usr ON usr.ID = P_LastUpdateUserID\r\n  WHERE (det.ID = P_InvoiceDetailsID)\r\n    AND ((det.Hardship = 1 AND det.CurrentPayer = 'Patient') OR (0 < FIND_IN_SET('Writeoff Balance', P_Options)))\r\n    AND (0.01 <= det.Balance); --\r\n\r\n  IF (ROW_COUNT() != 0) THEN\r\n    CALL InvoiceDetails_RecalculateInternals_Single(null, P_InvoiceDetailsID); --\r\n  END IF; --\r\n\r\n  SET P_Result = 'Success'; --\r\nEND PROC",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "MODIFIES SQL DATA"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_AddSubmitted",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  CALL InvoiceDetails_InternalAddSubmitted(P_InvoiceDetailsID, P_Amount, P_SubmittedTo, P_SubmittedBy, P_SubmittedBatch, P_LastUpdateUserID); --\r\n  CALL InvoiceDetails_RecalculateInternals_Single(null, P_InvoiceDetailsID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_InternalAddAutoSubmit",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_CustomerID, V_InvoiceID, V_InvoiceDetailsID INT; --\r\n  DECLARE V_TransmittedCustomerInsuranceID, V_TransmittedInsuranceCompanyID INT; --\r\n  DECLARE V_Billable DECIMAL(18, 2); --\r\n  DECLARE V_Quantity, V_Count INT; --\r\n\r\n  SELECT\r\n   `detail`.CustomerID,\r\n   `detail`.InvoiceID,\r\n   `detail`.ID as InvoiceDetailsID,\r\n   CASE WHEN P_AutoSubmittedTo = 'Ins1' THEN `ins1`.ID\r\n        WHEN P_AutoSubmittedTo = 'Ins2' THEN `ins2`.ID\r\n        WHEN P_AutoSubmittedTo = 'Ins3' THEN `ins3`.ID\r\n        WHEN P_AutoSubmittedTo = 'Ins4' THEN `ins4`.ID\r\n        ELSE NULL END AS TransmittedCustomerInsuranceID,\r\n   CASE WHEN P_AutoSubmittedTo = 'Ins1' THEN `ins1`.InsuranceCompanyID\r\n        WHEN P_AutoSubmittedTo = 'Ins2' THEN `ins2`.InsuranceCompanyID\r\n        WHEN P_AutoSubmittedTo = 'Ins3' THEN `ins3`.InsuranceCompanyID\r\n        WHEN P_AutoSubmittedTo = 'Ins4' THEN `ins4`.InsuranceCompanyID\r\n        ELSE NULL END AS TransmittedInsuranceCompanyID,\r\n   `detail`.BillableAmount,\r\n   `detail`.Quantity\r\n  INTO\r\n    V_CustomerID,\r\n    V_InvoiceID,\r\n    V_InvoiceDetailsID,\r\n    V_TransmittedCustomerInsuranceID,\r\n    V_TransmittedInsuranceCompanyID,\r\n    V_Billable,\r\n    V_Quantity\r\n  FROM tbl_invoicedetails as `detail`\r\n       INNER JOIN tbl_invoice as `invoice` ON `detail`.InvoiceID  = `invoice`.ID\r\n                                          AND `detail`.CustomerID = `invoice`.CustomerID\r\n       LEFT JOIN `tbl_customer_insurance` as `ins1` ON `ins1`.ID         = `invoice`.CustomerInsurance1_ID\r\n                                                   AND `ins1`.CustomerID = `invoice`.CustomerID\r\n                                                   AND `detail`.BillIns1 = 1\r\n       LEFT JOIN `tbl_customer_insurance` as `ins2` ON `ins2`.ID         = `invoice`.CustomerInsurance2_ID\r\n                                                   AND `ins2`.CustomerID = `invoice`.CustomerID\r\n                                                   AND `detail`.BillIns2 = 1\r\n       LEFT JOIN `tbl_customer_insurance` as `ins3` ON `ins3`.ID         = `invoice`.CustomerInsurance3_ID\r\n                                                   AND `ins3`.CustomerID = `invoice`.CustomerID\r\n                                                   AND `detail`.BillIns3 = 1\r\n       LEFT JOIN `tbl_customer_insurance` as `ins4` ON `ins4`.ID         = `invoice`.CustomerInsurance4_ID\r\n                                                   AND `ins4`.CustomerID = `invoice`.CustomerID\r\n                                                   AND `detail`.BillIns4 = 1\r\n  WHERE (`detail`.ID = P_InvoiceDetailsID); --\r\n\r\n  IF (V_CustomerID IS NULL) OR (V_InvoiceID IS NULL) OR (V_InvoiceDetailsID IS NULL) THEN\r\n    SET P_Result = 'InvoiceDetailsID is wrong'; --\r\n  ELSEIF (V_TransmittedCustomerInsuranceID IS NULL) OR (V_TransmittedInsuranceCompanyID IS NULL) THEN\r\n    SET P_Result = 'Autosubmitted Payer is wrong'; --\r\n  ELSE\r\n    SELECT COUNT(*)\r\n    INTO V_Count\r\n    FROM tbl_invoice_transaction as it\r\n         INNER JOIN tbl_invoice_transactiontype as tt ON it.TransactionTypeID = tt.ID\r\n    WHERE (tt.Name               = 'Auto Submit'                  )\r\n      AND (it.CustomerID         = V_CustomerID                   )\r\n      AND (it.InvoiceID          = V_InvoiceID                    )\r\n      AND (it.InvoiceDetailsID   = V_InvoiceDetailsID             )\r\n      AND (it.InsuranceCompanyID = V_TransmittedInsuranceCompanyID); --\r\n\r\n    IF 0 < V_Count THEN\r\n      SET P_Result = 'Transaction already exists'; --\r\n    ELSE\r\n      INSERT INTO tbl_invoice_transaction (\r\n        InvoiceDetailsID\r\n      , InvoiceID\r\n      , CustomerID\r\n      , InsuranceCompanyID\r\n      , CustomerInsuranceID\r\n      , TransactionTypeID\r\n      , TransactionDate\r\n      , Amount\r\n      , Quantity\r\n      , Taxes\r\n      , BatchNumber\r\n      , Comments\r\n      , Extra\r\n      , Approved\r\n      , LastUpdateUserID)\r\n      SELECT\r\n        V_InvoiceDetailsID\r\n      , V_InvoiceID\r\n      , V_CustomerID\r\n      , V_TransmittedInsuranceCompanyID\r\n      , V_TransmittedCustomerInsuranceID\r\n      , ID as TransactionTypeID\r\n      , CURRENT_DATE() as TransactionDate\r\n      , V_Billable as Amount\r\n      , V_Quantity as Quantity\r\n      , 0.00       as Taxes\r\n      , ''         as BatchNumber\r\n      , 'Manual'   as Comments\r\n      , null       as Extra\r\n      , 1          as Approved\r\n      , P_LastUpdateUserID\r\n      FROM tbl_invoice_transactiontype\r\n      WHERE (Name = 'Auto Submit'); --\r\n    END IF; --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "MODIFIES SQL DATA"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_InternalAddSubmitted",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_TransactionTypeID INT DEFAULT (0); --\r\n\r\n  SELECT ID\r\n  INTO V_TransactionTypeID\r\n  FROM tbl_invoice_transactiontype\r\n  WHERE Name = 'Submit'; --\r\n\r\n  IF P_SubmittedTo = 'Patient' THEN\r\n    INSERT INTO `tbl_invoice_transaction` (\r\n      `InvoiceDetailsID`,\r\n      `InvoiceID`,\r\n      `CustomerID`,\r\n      `InsuranceCompanyID`,\r\n      `CustomerInsuranceID`,\r\n      `TransactionTypeID`,\r\n      `Amount`,\r\n      `Quantity`,\r\n      `TransactionDate`,\r\n      `BatchNumber`,\r\n      `Comments`,\r\n      `LastUpdateUserID`)\r\n    SELECT tbl_invoicedetails.ID as `InvoiceDetailsID`,\r\n           tbl_invoicedetails.InvoiceID,\r\n           tbl_invoicedetails.CustomerID,\r\n           NULL                  as `InsuranceCompanyID`,\r\n           NULL                  as `CustomerInsuranceID`,\r\n           V_TransactionTypeID,\r\n           P_Amount,\r\n           tbl_invoicedetails.Quantity,\r\n           CURRENT_DATE() as `TransactionDate`,\r\n           P_SubmittedBatch,\r\n           Concat('Submitted by ', P_SubmittedBy) as `Comments`,\r\n           P_LastUpdateUserID\r\n    FROM tbl_invoicedetails\r\n    WHERE (tbl_invoicedetails.ID = P_InvoiceDetailsID); --\r\n\r\n  ELSEIF P_SubmittedTo = 'Ins4' THEN\r\n    INSERT INTO `tbl_invoice_transaction` (\r\n      `InvoiceDetailsID`,\r\n      `InvoiceID`,\r\n      `CustomerID`,\r\n      `InsuranceCompanyID`,\r\n      `CustomerInsuranceID`,\r\n      `TransactionTypeID`,\r\n      `Amount`,\r\n      `Quantity`,\r\n      `TransactionDate`,\r\n      `BatchNumber`,\r\n      `Comments`,\r\n      `LastUpdateUserID`)\r\n    SELECT tbl_invoicedetails.ID as `InvoiceDetailsID`,\r\n           tbl_invoicedetails.InvoiceID,\r\n           tbl_invoicedetails.CustomerID,\r\n           tbl_customer_insurance.InsuranceCompanyID,\r\n           tbl_customer_insurance.ID as `CustomerInsuranceID`,\r\n           V_TransactionTypeID,\r\n           P_Amount,\r\n           tbl_invoicedetails.Quantity,\r\n           CURRENT_DATE() as `TransactionDate`,\r\n           P_SubmittedBatch,\r\n           Concat('Submitted by ', P_SubmittedBy) as `Comments`,\r\n           P_LastUpdateUserID\r\n    FROM ((tbl_invoicedetails\r\n           INNER JOIN tbl_invoice ON tbl_invoicedetails.CustomerID = tbl_invoice.CustomerID\r\n                                 AND tbl_invoicedetails.InvoiceID = tbl_invoice.ID)\r\n          INNER JOIN tbl_customer_insurance ON tbl_invoice.CustomerID = tbl_customer_insurance.CustomerID\r\n                                           AND tbl_invoice.CustomerInsurance4_ID = tbl_customer_insurance.ID)\r\n    WHERE (tbl_invoicedetails.ID = P_InvoiceDetailsID); --\r\n\r\n  ELSEIF P_SubmittedTo = 'Ins3' THEN\r\n    INSERT INTO `tbl_invoice_transaction` (\r\n      `InvoiceDetailsID`,\r\n      `InvoiceID`,\r\n      `CustomerID`,\r\n      `InsuranceCompanyID`,\r\n      `CustomerInsuranceID`,\r\n      `TransactionTypeID`,\r\n      `Amount`,\r\n      `Quantity`,\r\n      `TransactionDate`,\r\n      `BatchNumber`,\r\n      `Comments`,\r\n      `LastUpdateUserID`)\r\n    SELECT tbl_invoicedetails.ID as `InvoiceDetailsID`,\r\n           tbl_invoicedetails.InvoiceID,\r\n           tbl_invoicedetails.CustomerID,\r\n           tbl_customer_insurance.InsuranceCompanyID,\r\n           tbl_customer_insurance.ID as `CustomerInsuranceID`,\r\n           V_TransactionTypeID,\r\n           P_Amount,\r\n           tbl_invoicedetails.Quantity,\r\n           CURRENT_DATE() as `TransactionDate`,\r\n           P_SubmittedBatch,\r\n           Concat('Submitted by ', P_SubmittedBy) as `Comments`,\r\n           P_LastUpdateUserID\r\n    FROM ((tbl_invoicedetails\r\n           INNER JOIN tbl_invoice ON tbl_invoicedetails.CustomerID = tbl_invoice.CustomerID\r\n                                 AND tbl_invoicedetails.InvoiceID = tbl_invoice.ID)\r\n          INNER JOIN tbl_customer_insurance ON tbl_invoice.CustomerID = tbl_customer_insurance.CustomerID\r\n                                           AND tbl_invoice.CustomerInsurance3_ID = tbl_customer_insurance.ID)\r\n    WHERE (tbl_invoicedetails.ID = P_InvoiceDetailsID); --\r\n\r\n  ELSEIF P_SubmittedTo = 'Ins2' THEN\r\n    INSERT INTO `tbl_invoice_transaction` (\r\n      `InvoiceDetailsID`,\r\n      `InvoiceID`,\r\n      `CustomerID`,\r\n      `InsuranceCompanyID`,\r\n      `CustomerInsuranceID`,\r\n      `TransactionTypeID`,\r\n      `Amount`,\r\n      `Quantity`,\r\n      `TransactionDate`,\r\n      `BatchNumber`,\r\n      `Comments`,\r\n      `LastUpdateUserID`)\r\n    SELECT tbl_invoicedetails.ID as `InvoiceDetailsID`,\r\n           tbl_invoicedetails.InvoiceID,\r\n           tbl_invoicedetails.CustomerID,\r\n           tbl_customer_insurance.InsuranceCompanyID,\r\n           tbl_customer_insurance.ID as `CustomerInsuranceID`,\r\n           V_TransactionTypeID,\r\n           P_Amount,\r\n           tbl_invoicedetails.Quantity,\r\n           CURRENT_DATE() as `TransactionDate`,\r\n           P_SubmittedBatch,\r\n           Concat('Submitted by ', P_SubmittedBy) as `Comments`,\r\n           P_LastUpdateUserID\r\n    FROM ((tbl_invoicedetails\r\n           INNER JOIN tbl_invoice ON tbl_invoicedetails.CustomerID = tbl_invoice.CustomerID\r\n                                 AND tbl_invoicedetails.InvoiceID = tbl_invoice.ID)\r\n          INNER JOIN tbl_customer_insurance ON tbl_invoice.CustomerID = tbl_customer_insurance.CustomerID\r\n                                           AND tbl_invoice.CustomerInsurance2_ID = tbl_customer_insurance.ID)\r\n    WHERE (tbl_invoicedetails.ID = P_InvoiceDetailsID); --\r\n\r\n  ELSEIF P_SubmittedTo = 'Ins1' THEN\r\n    INSERT INTO `tbl_invoice_transaction` (\r\n      `InvoiceDetailsID`,\r\n      `InvoiceID`,\r\n      `CustomerID`,\r\n      `InsuranceCompanyID`,\r\n      `CustomerInsuranceID`,\r\n      `TransactionTypeID`,\r\n      `Amount`,\r\n      `Quantity`,\r\n      `TransactionDate`,\r\n      `BatchNumber`,\r\n      `Comments`,\r\n      `LastUpdateUserID`)\r\n    SELECT tbl_invoicedetails.ID as `InvoiceDetailsID`,\r\n           tbl_invoicedetails.InvoiceID,\r\n           tbl_invoicedetails.CustomerID,\r\n           tbl_customer_insurance.InsuranceCompanyID,\r\n           tbl_customer_insurance.ID as `CustomerInsuranceID`,\r\n           V_TransactionTypeID,\r\n           P_Amount,\r\n           tbl_invoicedetails.Quantity,\r\n           CURRENT_DATE() as `TransactionDate`,\r\n           P_SubmittedBatch,\r\n           Concat('Submitted by ', P_SubmittedBy) as `Comments`,\r\n           P_LastUpdateUserID\r\n    FROM ((tbl_invoicedetails\r\n           INNER JOIN tbl_invoice ON tbl_invoicedetails.CustomerID = tbl_invoice.CustomerID\r\n                                 AND tbl_invoicedetails.InvoiceID = tbl_invoice.ID)\r\n          INNER JOIN tbl_customer_insurance ON tbl_invoice.CustomerID = tbl_customer_insurance.CustomerID\r\n                                           AND tbl_invoice.CustomerInsurance1_ID = tbl_customer_insurance.ID)\r\n    WHERE (tbl_invoicedetails.ID = P_InvoiceDetailsID); --\r\n\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_InternalReflag",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE F_Insco_1 tinyint DEFAULT 01; --\r\n  DECLARE F_Insco_2 tinyint DEFAULT 02; --\r\n  DECLARE F_Insco_3 tinyint DEFAULT 04; --\r\n  DECLARE F_Insco_4 tinyint DEFAULT 08; --\r\n  DECLARE F_Patient tinyint DEFAULT 16; --\r\n\r\n  DECLARE V_TransactionTypeID int DEFAULT 0; --\r\n  DECLARE V_Username VARCHAR(50); --\r\n\r\n  SET V_TransactionTypeID = NULL; --\r\n  SELECT ID\r\n  INTO V_TransactionTypeID\r\n  FROM tbl_invoice_transactiontype\r\n  WHERE (Name = 'Voided Submission'); --\r\n\r\n  SET V_Username = ''; --\r\n  SELECT Login\r\n  INTO V_Username\r\n  FROM tbl_user\r\n  WHERE (ID = P_LastUpdateUserID); --\r\n\r\n  INSERT INTO tbl_invoice_transaction\r\n    (InvoiceDetailsID\r\n    ,InvoiceID\r\n    ,CustomerID\r\n    ,InsuranceCompanyID\r\n    ,CustomerInsuranceID\r\n    ,TransactionTypeID\r\n    ,Amount\r\n    ,Quantity\r\n    ,TransactionDate\r\n    ,BatchNumber\r\n    ,Comments\r\n    ,LastUpdateUserID)\r\n  SELECT\r\n     InvoiceDetailsID\r\n    ,InvoiceID\r\n    ,CustomerID\r\n    ,CASE CurrentPayer WHEN 'Patient' THEN null\r\n                       WHEN 'Ins4'    THEN InsuranceCompany4_ID\r\n                       WHEN 'Ins3'    THEN InsuranceCompany3_ID\r\n                       WHEN 'Ins2'    THEN InsuranceCompany2_ID\r\n                       WHEN 'Ins1'    THEN InsuranceCompany1_ID\r\n                       ELSE null END as InsuranceCompanyID\r\n    ,CASE CurrentPayer WHEN 'Patient' THEN null\r\n                       WHEN 'Ins4'    THEN Insurance4_ID\r\n                       WHEN 'Ins3'    THEN Insurance3_ID\r\n                       WHEN 'Ins2'    THEN Insurance2_ID\r\n                       WHEN 'Ins1'    THEN Insurance1_ID\r\n                       ELSE null END as CustomerInsuranceID\r\n    ,V_TransactionTypeID as TransactionTypeID\r\n    ,BillableAmount\r\n    ,Quantity\r\n    ,CURRENT_DATE()\r\n    ,null as BatchNumber\r\n    ,Concat('Reflagged by ', V_Username) as Comments\r\n    ,P_LastUpdateUserID as LastUpdateUserID\r\n  FROM view_invoicetransaction_statistics\r\n  WHERE ((0 < FIND_IN_SET(InvoiceID, P_InvoiceID)) OR (P_InvoiceID IS NULL) OR (P_InvoiceID = ''))\r\n    AND ((0 < FIND_IN_SET(InvoiceDetailsID, P_InvoiceDetailsID)) OR (P_InvoiceDetailsID IS NULL) OR (P_InvoiceDetailsID = ''))\r\n    AND ((CurrentPayer = 'Patient' AND Submits & F_Patient != 0) OR\r\n         (CurrentPayer = 'Ins4'    AND Submits & F_Insco_4 != 0) OR\r\n         (CurrentPayer = 'Ins3'    AND Submits & F_Insco_3 != 0) OR\r\n         (CurrentPayer = 'Ins2'    AND Submits & F_Insco_2 != 0) OR\r\n         (CurrentPayer = 'Ins1'    AND Submits & F_Insco_1 != 0)); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_InternalWriteoffBalance",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  INSERT INTO tbl_invoice_transaction (\r\n    InvoiceDetailsID\r\n  , InvoiceID\r\n  , CustomerID\r\n  , InsuranceCompanyID\r\n  , CustomerInsuranceID\r\n  , TransactionTypeID\r\n  , TransactionDate\r\n  , Amount\r\n  , Quantity\r\n  , Comments\r\n  , Taxes\r\n  , BatchNumber\r\n  , Extra\r\n  , Approved\r\n  , LastUpdateUserID)\r\n  SELECT\r\n    det.ID as InvoiceDetailsID\r\n  , det.InvoiceID\r\n  , det.CustomerID\r\n  , det.CurrentInsuranceCompanyID\r\n  , det.CurrentCustomerInsuranceID\r\n  , itt.ID as TransactionTypeID\r\n  , NOW() as TransactionDate\r\n  , det.Balance\r\n  , det.Quantity\r\n  , CONCAT('Wrote off by ', usr.Login) as Comments\r\n  , 0.00 as Taxes\r\n  , ''   as BatchNumber\r\n  , null as Extra\r\n  , 1    as Approved\r\n  , P_LastUpdateUserID\r\n  FROM tbl_invoicedetails as det\r\n       INNER JOIN tbl_invoice_transactiontype as itt ON itt.Name = 'Writeoff'\r\n       LEFT JOIN tbl_user as usr ON usr.ID = P_LastUpdateUserID\r\n  WHERE ((0 < FIND_IN_SET(det.InvoiceID, P_InvoiceID)) OR (P_InvoiceID IS NULL) OR (P_InvoiceID = ''))\r\n    AND ((0 < FIND_IN_SET(det.ID, P_InvoiceDetailsID)) OR (P_InvoiceDetailsID IS NULL) OR (P_InvoiceDetailsID = ''))\r\n    AND (0.01 <= det.Balance); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "MODIFIES SQL DATA"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_RecalculateInternals",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE\r\n    V_PrevCustomerID,\r\n    V_PrevInvoiceID,\r\n    V_PrevDetailsID,\r\n    cur_CustomerID,\r\n    cur_InvoiceID,\r\n    cur_DetailsID,\r\n    cur_TranID INT; --\r\n  -- cursor variables\r\n  DECLARE\r\n    cur_CustomerInsuranceID_1,\r\n    cur_CustomerInsuranceID_2,\r\n    cur_CustomerInsuranceID_3,\r\n    cur_CustomerInsuranceID_4,\r\n    cur_InsuranceCompanyID_1,\r\n    cur_InsuranceCompanyID_2,\r\n    cur_InsuranceCompanyID_3,\r\n    cur_InsuranceCompanyID_4 INT; --\r\n  DECLARE\r\n    V_CustomerInsuranceID_1,\r\n    V_CustomerInsuranceID_2,\r\n    V_CustomerInsuranceID_3,\r\n    V_CustomerInsuranceID_4,\r\n    V_InsuranceCompanyID_1,\r\n    V_InsuranceCompanyID_2,\r\n    V_InsuranceCompanyID_3,\r\n    V_InsuranceCompanyID_4 INT; --\r\n  DECLARE\r\n    cur_TranAmount,\r\n    V_PaymentAmount_Insco_1,\r\n    V_PaymentAmount_Insco_2,\r\n    V_PaymentAmount_Insco_3,\r\n    V_PaymentAmount_Insco_4,\r\n    V_PaymentAmount_Patient,\r\n    V_PaymentAmount,\r\n    V_WriteoffAmount,\r\n    V_DeductibleAmount decimal(18,2); --\r\n  DECLARE\r\n    cur_Percent int; --\r\n  DECLARE\r\n    cur_Basis VARCHAR(7); --\r\n  DECLARE\r\n    cur_TranType VARCHAR(50); --\r\n  DECLARE\r\n    cur_TranOwner,\r\n    cur_Insurances,\r\n    V_ProposedPayer, -- modified by 'Change Current Payee' transaction\r\n    V_CurrentPayer,  -- used only to simplify evaluations\r\n    V_Insurances,    -- insurances available for current line\r\n    V_Pendings,\r\n    V_Submits,\r\n    V_ZeroPayments tinyint; --\r\n  DECLARE\r\n    cur_TranDate,\r\n    V_SubmitDate_1,\r\n    V_SubmitDate_2,\r\n    V_SubmitDate_3,\r\n    V_SubmitDate_4,\r\n    V_SubmitDate_P DATE; --\r\n\r\n  DECLARE F_Insco_1 tinyint DEFAULT 01; --\r\n  DECLARE F_Insco_2 tinyint DEFAULT 02; --\r\n  DECLARE F_Insco_3 tinyint DEFAULT 04; --\r\n  DECLARE F_Insco_4 tinyint DEFAULT 08; --\r\n  DECLARE F_Patient tinyint DEFAULT 16; --\r\n\r\n  DECLARE cur CURSOR FOR\r\n    SELECT\r\n      `detail`.CustomerID,\r\n      `detail`.InvoiceID,\r\n      `detail`.ID as InvoiceDetailsID,\r\n      `tran`.`ID` as TranID,\r\n      `trantype`.`Name` as TranType,\r\n      `tran`.`Amount` as TranAmount,\r\n      `tran`.`TransactionDate` as TranDate,\r\n      CASE WHEN `tran`.CustomerInsuranceID = `invoice`.CustomerInsurance1_ID THEN F_Insco_1\r\n           WHEN `tran`.CustomerInsuranceID = `invoice`.CustomerInsurance2_ID THEN F_Insco_2\r\n           WHEN `tran`.CustomerInsuranceID = `invoice`.CustomerInsurance3_ID THEN F_Insco_3\r\n           WHEN `tran`.CustomerInsuranceID = `invoice`.CustomerInsurance4_ID THEN F_Insco_4\r\n           WHEN `tran`.CustomerInsuranceID IS NULL                           THEN F_Patient\r\n           ELSE 0 END AS TranOwner,\r\n      IF((`insurance1`.ID IS NOT NULL) AND (`detail`.BillIns1 = 1) AND (`detail`.NopayIns1 = 0), F_Insco_1, 0) +\r\n      IF((`insurance2`.ID IS NOT NULL) AND (`detail`.BillIns2 = 1), F_Insco_2, 0) +\r\n      IF((`insurance3`.ID IS NOT NULL) AND (`detail`.BillIns3 = 1), F_Insco_3, 0) +\r\n      IF((`insurance4`.ID IS NOT NULL) AND (`detail`.BillIns4 = 1), F_Insco_4, 0) as Insurances,\r\n      `insurance1`.ID as CustomerInsuranceID_1,\r\n      `insurance2`.ID as CustomerInsuranceID_2,\r\n      `insurance3`.ID as CustomerInsuranceID_3,\r\n      `insurance4`.ID as CustomerInsuranceID_4,\r\n      `insurance1`.InsuranceCompanyID as InsuranceCompanyID_1,\r\n      `insurance2`.InsuranceCompanyID as InsuranceCompanyID_2,\r\n      `insurance3`.InsuranceCompanyID as InsuranceCompanyID_3,\r\n      `insurance4`.InsuranceCompanyID as InsuranceCompanyID_4,\r\n       CASE WHEN IFNULL(`insurance1`.PaymentPercent, 0) < 000 THEN 000\r\n            WHEN 100 < IFNULL(`insurance1`.PaymentPercent, 0) THEN 100\r\n            ELSE IFNULL(`insurance1`.PaymentPercent, 0) END as Percent,\r\n       IFNULL(`insurance1`.Basis, 'Bill') as Basis\r\n    FROM tbl_invoicedetails as `detail`\r\n         INNER JOIN tbl_invoice as `invoice` ON `invoice`.CustomerID = `detail`.CustomerID\r\n                                            AND `invoice`.ID         = `detail`.InvoiceID\r\n         LEFT JOIN `tbl_customer_insurance` as `insurance1` ON `insurance1`.ID         = `invoice`.CustomerInsurance1_ID\r\n                                                           AND `insurance1`.CustomerID = `invoice`.CustomerID\r\n         LEFT JOIN `tbl_customer_insurance` as `insurance2` ON `insurance2`.ID         = `invoice`.CustomerInsurance2_ID\r\n                                                           AND `insurance2`.CustomerID = `invoice`.CustomerID\r\n         LEFT JOIN `tbl_customer_insurance` as `insurance3` ON `insurance3`.ID         = `invoice`.CustomerInsurance3_ID\r\n                                                           AND `insurance3`.CustomerID = `invoice`.CustomerID\r\n         LEFT JOIN `tbl_customer_insurance` as `insurance4` ON `insurance4`.ID         = `invoice`.CustomerInsurance4_ID\r\n                                                           AND `insurance4`.CustomerID = `invoice`.CustomerID\r\n         LEFT JOIN tbl_invoice_transaction as `tran` ON `tran`.InvoiceDetailsID = `detail`.ID\r\n                                                    AND `tran`.InvoiceID        = `detail`.InvoiceID\r\n                                                    AND `tran`.CustomerID       = `detail`.CustomerID\r\n         LEFT JOIN tbl_invoice_transactiontype as `trantype` ON `trantype`.ID = `tran`.TransactionTypeID\r\n  WHERE CASE\r\n        WHEN (P_InvoiceID        IS NOT NULL) THEN 0 < FIND_IN_SET(`invoice`.ID, P_InvoiceID)\r\n        WHEN (P_InvoiceDetailsID IS NOT NULL) THEN 0 < FIND_IN_SET(`detail`.ID, P_InvoiceDetailsID)\r\n        ELSE 1 END\r\n  ORDER BY `detail`.CustomerID, `detail`.InvoiceID, `detail`.ID, `tran`.`ID`; --\r\n\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  SET V_PrevCustomerID = null; --\r\n  SET V_PrevInvoiceID  = null; --\r\n  SET V_PrevDetailsID  = null; --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO\r\n      cur_CustomerID,\r\n      cur_InvoiceID,\r\n      cur_DetailsID,\r\n      cur_TranID,\r\n      cur_TranType,\r\n      cur_TranAmount,\r\n      cur_TranDate,\r\n      cur_TranOwner,\r\n      cur_Insurances,\r\n      cur_CustomerInsuranceID_1,\r\n      cur_CustomerInsuranceID_2,\r\n      cur_CustomerInsuranceID_3,\r\n      cur_CustomerInsuranceID_4,\r\n      cur_InsuranceCompanyID_1,\r\n      cur_InsuranceCompanyID_2,\r\n      cur_InsuranceCompanyID_3,\r\n      cur_InsuranceCompanyID_4,\r\n      cur_Percent,\r\n      cur_Basis; --\r\n\r\n    IF (done != 0)\r\n    OR (V_PrevCustomerID IS NULL) OR (cur_CustomerID != V_PrevCustomerID)\r\n    OR (V_PrevInvoiceID  IS NULL) OR (cur_InvoiceID  != V_PrevInvoiceID)\r\n    OR (V_PrevDetailsID  IS NULL) OR (cur_DetailsID  != V_PrevDetailsID)\r\n    THEN\r\n      IF  (V_PrevCustomerID IS NOT NULL)\r\n      AND (V_PrevInvoiceID  IS NOT NULL)\r\n      AND (V_PrevDetailsID  IS NOT NULL)\r\n      THEN\r\n        -- we must allow changing payer regardless of the payments (zero payments and total amount paid)\r\n        SET V_CurrentPayer\r\n          = CASE WHEN (V_ProposedPayer = F_Insco_1) THEN F_Insco_1\r\n                 WHEN (V_ProposedPayer = F_Insco_2) THEN F_Insco_2\r\n                 WHEN (V_ProposedPayer = F_Insco_3) THEN F_Insco_3\r\n                 WHEN (V_ProposedPayer = F_Insco_4) THEN F_Insco_4\r\n                 WHEN (V_ProposedPayer = F_Patient) THEN F_Patient\r\n                 WHEN (V_Insurances & F_Insco_1 != 0) AND (V_PaymentAmount_Insco_1 < 0.01) AND (V_ZeroPayments & F_Insco_1 = 0) THEN F_Insco_1\r\n                 WHEN (V_Insurances & F_Insco_2 != 0) AND (V_PaymentAmount_Insco_2 < 0.01) AND (V_ZeroPayments & F_Insco_2 = 0) THEN F_Insco_2\r\n                 WHEN (V_Insurances & F_Insco_3 != 0) AND (V_PaymentAmount_Insco_3 < 0.01) AND (V_ZeroPayments & F_Insco_3 = 0) THEN F_Insco_3\r\n                 WHEN (V_Insurances & F_Insco_4 != 0) AND (V_PaymentAmount_Insco_4 < 0.01) AND (V_ZeroPayments & F_Insco_4 = 0) THEN F_Insco_4\r\n                 ELSE F_Patient END; -- we should never switch from patient - somebody must pay --\r\n\r\n        -- save into db\r\n        UPDATE tbl_invoicedetails\r\n        SET Balance = BillableAmount - V_PaymentAmount - V_WriteoffAmount,\r\n            PaymentAmount  = V_PaymentAmount,\r\n            WriteoffAmount = V_WriteoffAmount,\r\n            DeductibleAmount = V_DeductibleAmount,\r\n            CurrentPayer\r\n              = CASE WHEN BillableAmount - V_PaymentAmount - V_WriteoffAmount < 0.01 THEN 'None'\r\n                     WHEN V_CurrentPayer = F_Insco_1 THEN 'Ins1'\r\n                     WHEN V_CurrentPayer = F_Insco_2 THEN 'Ins2'\r\n                     WHEN V_CurrentPayer = F_Insco_3 THEN 'Ins3'\r\n                     WHEN V_CurrentPayer = F_Insco_4 THEN 'Ins4'\r\n                     WHEN V_CurrentPayer = F_Patient THEN 'Patient'\r\n                     ELSE 'None' END,\r\n            SubmittedDate\r\n              = CASE WHEN BillableAmount - V_PaymentAmount - V_WriteoffAmount < 0.01 THEN null\r\n                     WHEN V_CurrentPayer = F_Insco_1 THEN V_SubmitDate_1\r\n                     WHEN V_CurrentPayer = F_Insco_2 THEN V_SubmitDate_2\r\n                     WHEN V_CurrentPayer = F_Insco_3 THEN V_SubmitDate_3\r\n                     WHEN V_CurrentPayer = F_Insco_4 THEN V_SubmitDate_4\r\n                     WHEN V_CurrentPayer = F_Patient THEN V_SubmitDate_P\r\n                     ELSE null END,\r\n            Submitted\r\n              = CASE WHEN BillableAmount - V_PaymentAmount - V_WriteoffAmount < 0.01 THEN 1\r\n                     WHEN V_CurrentPayer = F_Insco_1 THEN IF(V_SubmitDate_1 IS NOT NULL, 1, 0)\r\n                     WHEN V_CurrentPayer = F_Insco_2 THEN IF(V_SubmitDate_2 IS NOT NULL, 1, 0)\r\n                     WHEN V_CurrentPayer = F_Insco_3 THEN IF(V_SubmitDate_3 IS NOT NULL, 1, 0)\r\n                     WHEN V_CurrentPayer = F_Insco_4 THEN IF(V_SubmitDate_4 IS NOT NULL, 1, 0)\r\n                     WHEN V_CurrentPayer = F_Patient THEN IF(V_SubmitDate_P IS NOT NULL, 1, 0)\r\n                     ELSE 1 END,\r\n            CurrentInsuranceCompanyID\r\n              = CASE WHEN BillableAmount - V_PaymentAmount - V_WriteoffAmount < 0.01 THEN null\r\n                     WHEN V_CurrentPayer = F_Insco_1 THEN V_InsuranceCompanyID_1\r\n                     WHEN V_CurrentPayer = F_Insco_2 THEN V_InsuranceCompanyID_2\r\n                     WHEN V_CurrentPayer = F_Insco_3 THEN V_InsuranceCompanyID_3\r\n                     WHEN V_CurrentPayer = F_Insco_4 THEN V_InsuranceCompanyID_4\r\n                     WHEN V_CurrentPayer = F_Patient THEN null\r\n                     ELSE null END,\r\n            CurrentCustomerInsuranceID\r\n              = CASE WHEN BillableAmount - V_PaymentAmount - V_WriteoffAmount < 0.01 THEN null\r\n                     WHEN V_CurrentPayer = F_Insco_1 THEN V_CustomerInsuranceID_1\r\n                     WHEN V_CurrentPayer = F_Insco_2 THEN V_CustomerInsuranceID_2\r\n                     WHEN V_CurrentPayer = F_Insco_3 THEN V_CustomerInsuranceID_3\r\n                     WHEN V_CurrentPayer = F_Insco_4 THEN V_CustomerInsuranceID_4\r\n                     WHEN V_CurrentPayer = F_Patient THEN null\r\n                     ELSE null END,\r\n            -- for debugging\r\n            Pendings    = V_Pendings,\r\n            Submits     = V_Submits,\r\n            Payments\r\n              = CASE WHEN 0.01 <= V_PaymentAmount_Insco_1 OR V_ZeroPayments & F_Insco_1 != 0 THEN F_Insco_1 ELSE 0 END\r\n              + CASE WHEN 0.01 <= V_PaymentAmount_Insco_2 OR V_ZeroPayments & F_Insco_2 != 0 THEN F_Insco_2 ELSE 0 END\r\n              + CASE WHEN 0.01 <= V_PaymentAmount_Insco_3 OR V_ZeroPayments & F_Insco_3 != 0 THEN F_Insco_3 ELSE 0 END\r\n              + CASE WHEN 0.01 <= V_PaymentAmount_Insco_4 OR V_ZeroPayments & F_Insco_4 != 0 THEN F_Insco_4 ELSE 0 END\r\n              + CASE WHEN 0.01 <= V_PaymentAmount_Patient THEN F_Patient ELSE 0 END\r\n        WHERE (CustomerID = V_PrevCustomerID) AND (InvoiceID = V_PrevInvoiceID) AND (ID = V_PrevDetailsID); --\r\n      END IF; --\r\n\r\n      -- init / reinit\r\n      SET V_PrevCustomerID = cur_CustomerID; --\r\n      SET V_PrevInvoiceID  = cur_InvoiceID; --\r\n      SET V_PrevDetailsID  = cur_DetailsID; --\r\n\r\n      SET V_PaymentAmount_Insco_1 = 0.0; --\r\n      SET V_PaymentAmount_Insco_2 = 0.0; --\r\n      SET V_PaymentAmount_Insco_3 = 0.0; --\r\n      SET V_PaymentAmount_Insco_4 = 0.0; --\r\n      SET V_PaymentAmount_Patient = 0.0; --\r\n      SET V_PaymentAmount  = 0.0; --\r\n      SET V_WriteoffAmount = 0.0; --\r\n      SET V_DeductibleAmount = 0.0; --\r\n      SET V_ProposedPayer = null; --\r\n      SET V_Insurances = cur_Insurances; -- snapshot of insurances available for current line\r\n      SET V_Pendings = 0; --\r\n      SET V_Submits  = 0; --\r\n      SET V_ZeroPayments = 0; --\r\n      SET V_SubmitDate_1 = null; --\r\n      SET V_SubmitDate_2 = null; --\r\n      SET V_SubmitDate_3 = null; --\r\n      SET V_SubmitDate_4 = null; --\r\n      SET V_SubmitDate_P = null; --\r\n      SET V_InsuranceCompanyID_1 = cur_InsuranceCompanyID_1; --\r\n      SET V_InsuranceCompanyID_2 = cur_InsuranceCompanyID_2; --\r\n      SET V_InsuranceCompanyID_3 = cur_InsuranceCompanyID_3; --\r\n      SET V_InsuranceCompanyID_4 = cur_InsuranceCompanyID_4; --\r\n      SET V_CustomerInsuranceID_1 = cur_CustomerInsuranceID_1; --\r\n      SET V_CustomerInsuranceID_2 = cur_CustomerInsuranceID_2; --\r\n      SET V_CustomerInsuranceID_3 = cur_CustomerInsuranceID_3; --\r\n      SET V_CustomerInsuranceID_4 = cur_CustomerInsuranceID_4; --\r\n    END IF; --\r\n\r\n    IF (done = 0)\r\n    AND (cur_TranID IS NOT NULL)\r\n    THEN\r\n      -- Only 'Payment' and 'Change Current Payee' changes current payer\r\n      IF (cur_TranType = 'Contractual Writeoff') OR (cur_TranType = 'Writeoff') THEN\r\n        SET V_WriteoffAmount = V_WriteoffAmount + IFNULL(cur_TranAmount, 0); --\r\n\r\n      ELSEIF (cur_TranType = 'Submit') OR (cur_TranType = 'Auto Submit') THEN\r\n        SET V_Submits = V_Submits | cur_TranOwner; --\r\n        IF     (cur_TranOwner = F_Insco_1) THEN\r\n          SET V_SubmitDate_1 = cur_TranDate; --\r\n        ELSEIF (cur_TranOwner = F_Insco_2) THEN\r\n          SET V_SubmitDate_2 = cur_TranDate; --\r\n        ELSEIF (cur_TranOwner = F_Insco_3) THEN\r\n          SET V_SubmitDate_3 = cur_TranDate; --\r\n        ELSEIF (cur_TranOwner = F_Insco_4) THEN\r\n          SET V_SubmitDate_4 = cur_TranDate; --\r\n        ELSEIF (cur_TranOwner = F_Patient) THEN\r\n          SET V_SubmitDate_P = cur_TranDate; --\r\n        END IF; --\r\n\r\n      ELSEIF (cur_TranType = 'Voided Submission') THEN\r\n        SET V_Submits = V_Submits & ~cur_TranOwner; --\r\n        IF     (cur_TranOwner = F_Insco_1) THEN\r\n          SET V_SubmitDate_1 = null; --\r\n        ELSEIF (cur_TranOwner = F_Insco_2) THEN\r\n          SET V_SubmitDate_2 = null; --\r\n        ELSEIF (cur_TranOwner = F_Insco_3) THEN\r\n          SET V_SubmitDate_3 = null; --\r\n        ELSEIF (cur_TranOwner = F_Insco_4) THEN\r\n          SET V_SubmitDate_4 = null; --\r\n        ELSEIF (cur_TranOwner = F_Patient) THEN\r\n          SET V_SubmitDate_P = null; --\r\n        END IF; --\r\n\r\n      ELSEIF (cur_TranType = 'Pending Submission') THEN\r\n        SET V_Pendings = V_Pendings | cur_TranOwner; --\r\n\r\n      ELSEIF (cur_TranType = 'Change Current Payee') THEN\r\n        IF (cur_TranOwner = F_Insco_1 and V_Insurances & F_Insco_1 != 0)\r\n        OR (cur_TranOwner = F_Insco_2 and V_Insurances & F_Insco_2 != 0)\r\n        OR (cur_TranOwner = F_Insco_3 and V_Insurances & F_Insco_3 != 0)\r\n        OR (cur_TranOwner = F_Insco_4 and V_Insurances & F_Insco_4 != 0)\r\n        OR (cur_TranOwner = F_Patient)\r\n        THEN\r\n          -- \"Change Current Payee\" transaction changes responsibility unconditionally\r\n          SET V_ProposedPayer = cur_TranOwner; --\r\n        END IF; --\r\n\r\n      ELSEIF (cur_TranType = 'Payment') THEN\r\n        IF (ABS(cur_TranAmount) < 0.01) THEN\r\n          SET V_ZeroPayments = V_ZeroPayments | cur_TranOwner; --\r\n        ELSE\r\n          SET V_ZeroPayments = V_ZeroPayments & ~cur_TranOwner; --\r\n        END IF; --\r\n\r\n        IF (cur_TranOwner = F_Insco_1) THEN\r\n          SET V_PaymentAmount_Insco_1 = V_PaymentAmount_Insco_1 + cur_TranAmount; --\r\n        ELSEIF (cur_TranOwner = F_Insco_2) THEN\r\n          SET V_PaymentAmount_Insco_2 = V_PaymentAmount_Insco_2 + cur_TranAmount; --\r\n        ELSEIF (cur_TranOwner = F_Insco_3) THEN\r\n          SET V_PaymentAmount_Insco_3 = V_PaymentAmount_Insco_3 + cur_TranAmount; --\r\n        ELSEIF (cur_TranOwner = F_Insco_4) THEN\r\n          SET V_PaymentAmount_Insco_4 = V_PaymentAmount_Insco_4 + cur_TranAmount; --\r\n        ELSEIF (cur_TranOwner = F_Patient) THEN\r\n          SET V_PaymentAmount_Patient = V_PaymentAmount_Patient + cur_TranAmount; --\r\n        END IF; --\r\n\r\n        SET V_PaymentAmount = V_PaymentAmount + cur_TranAmount; --\r\n\r\n        IF (cur_TranOwner = V_ProposedPayer)\r\n        AND (0.00 <= cur_TranAmount) THEN\r\n          -- \"Payment\" transaction (with positive or zero amount) advances responsibility to next payer\r\n          SET V_ProposedPayer = null; --\r\n        END IF; --\r\n\r\n      ELSEIF (cur_TranType = 'Deductible') THEN\r\n        -- I guess we should use deductible amount of first insurance only\r\n        IF (cur_TranOwner = F_Insco_1) THEN\r\n          SET V_DeductibleAmount = IFNULL(cur_TranAmount, 0.0); --\r\n        END IF; --\r\n\r\n      END IF; --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_RecalculateInternals_Single",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE\r\n    V_PrevCustomerID,\r\n    V_PrevInvoiceID,\r\n    V_PrevDetailsID,\r\n    cur_CustomerID,\r\n    cur_InvoiceID,\r\n    cur_DetailsID,\r\n    cur_TranID INT; --\r\n  -- cursor variables\r\n  DECLARE\r\n    cur_CustomerInsuranceID_1,\r\n    cur_CustomerInsuranceID_2,\r\n    cur_CustomerInsuranceID_3,\r\n    cur_CustomerInsuranceID_4,\r\n    cur_InsuranceCompanyID_1,\r\n    cur_InsuranceCompanyID_2,\r\n    cur_InsuranceCompanyID_3,\r\n    cur_InsuranceCompanyID_4 INT; --\r\n  DECLARE\r\n    V_CustomerInsuranceID_1,\r\n    V_CustomerInsuranceID_2,\r\n    V_CustomerInsuranceID_3,\r\n    V_CustomerInsuranceID_4,\r\n    V_InsuranceCompanyID_1,\r\n    V_InsuranceCompanyID_2,\r\n    V_InsuranceCompanyID_3,\r\n    V_InsuranceCompanyID_4 INT; --\r\n  DECLARE\r\n    cur_TranAmount,\r\n    V_PaymentAmount_Insco_1,\r\n    V_PaymentAmount_Insco_2,\r\n    V_PaymentAmount_Insco_3,\r\n    V_PaymentAmount_Insco_4,\r\n    V_PaymentAmount_Patient,\r\n    V_PaymentAmount,\r\n    V_WriteoffAmount,\r\n    V_DeductibleAmount decimal(18,2); --\r\n  DECLARE\r\n    cur_Percent int; --\r\n  DECLARE\r\n    cur_Basis VARCHAR(7); --\r\n  DECLARE\r\n    cur_TranType VARCHAR(50); --\r\n  DECLARE\r\n    cur_TranOwner,\r\n    cur_Insurances,\r\n    V_ProposedPayer, -- modified by 'Change Current Payee' transaction\r\n    V_CurrentPayer,  -- used only to simplify evaluations\r\n    V_Insurances,    -- insurances available for current line\r\n    V_Pendings,\r\n    V_Submits,\r\n    V_ZeroPayments tinyint; --\r\n  DECLARE\r\n    cur_TranDate,\r\n    V_SubmitDate_1,\r\n    V_SubmitDate_2,\r\n    V_SubmitDate_3,\r\n    V_SubmitDate_4,\r\n    V_SubmitDate_P DATE; --\r\n\r\n  DECLARE F_Insco_1 tinyint DEFAULT 01; --\r\n  DECLARE F_Insco_2 tinyint DEFAULT 02; --\r\n  DECLARE F_Insco_3 tinyint DEFAULT 04; --\r\n  DECLARE F_Insco_4 tinyint DEFAULT 08; --\r\n  DECLARE F_Patient tinyint DEFAULT 16; --\r\n\r\n  DECLARE cur CURSOR FOR\r\n    SELECT\r\n      `detail`.CustomerID,\r\n      `detail`.InvoiceID,\r\n      `detail`.ID as InvoiceDetailsID,\r\n      `tran`.`ID` as TranID,\r\n      `trantype`.`Name` as TranType,\r\n      `tran`.`Amount` as TranAmount,\r\n      `tran`.`TransactionDate` as TranDate,\r\n      CASE WHEN `tran`.CustomerInsuranceID = `invoice`.CustomerInsurance1_ID THEN F_Insco_1\r\n           WHEN `tran`.CustomerInsuranceID = `invoice`.CustomerInsurance2_ID THEN F_Insco_2\r\n           WHEN `tran`.CustomerInsuranceID = `invoice`.CustomerInsurance3_ID THEN F_Insco_3\r\n           WHEN `tran`.CustomerInsuranceID = `invoice`.CustomerInsurance4_ID THEN F_Insco_4\r\n           WHEN `tran`.CustomerInsuranceID IS NULL                           THEN F_Patient\r\n           ELSE 0 END AS TranOwner,\r\n      IF((`insurance1`.ID IS NOT NULL) AND (`detail`.BillIns1 = 1) AND (`detail`.NopayIns1 = 0), F_Insco_1, 0) +\r\n      IF((`insurance2`.ID IS NOT NULL) AND (`detail`.BillIns2 = 1), F_Insco_2, 0) +\r\n      IF((`insurance3`.ID IS NOT NULL) AND (`detail`.BillIns3 = 1), F_Insco_3, 0) +\r\n      IF((`insurance4`.ID IS NOT NULL) AND (`detail`.BillIns4 = 1), F_Insco_4, 0) as Insurances,\r\n      `insurance1`.ID as CustomerInsuranceID_1,\r\n      `insurance2`.ID as CustomerInsuranceID_2,\r\n      `insurance3`.ID as CustomerInsuranceID_3,\r\n      `insurance4`.ID as CustomerInsuranceID_4,\r\n      `insurance1`.InsuranceCompanyID as InsuranceCompanyID_1,\r\n      `insurance2`.InsuranceCompanyID as InsuranceCompanyID_2,\r\n      `insurance3`.InsuranceCompanyID as InsuranceCompanyID_3,\r\n      `insurance4`.InsuranceCompanyID as InsuranceCompanyID_4,\r\n       CASE WHEN IFNULL(`insurance1`.PaymentPercent, 0) < 000 THEN 000\r\n            WHEN 100 < IFNULL(`insurance1`.PaymentPercent, 0) THEN 100\r\n            ELSE IFNULL(`insurance1`.PaymentPercent, 0) END as Percent,\r\n       IFNULL(`insurance1`.Basis, 'Bill') as Basis\r\n    FROM tbl_invoicedetails as `detail`\r\n         INNER JOIN tbl_invoice as `invoice` ON `invoice`.CustomerID = `detail`.CustomerID\r\n                                            AND `invoice`.ID         = `detail`.InvoiceID\r\n         LEFT JOIN `tbl_customer_insurance` as `insurance1` ON `insurance1`.ID         = `invoice`.CustomerInsurance1_ID\r\n                                                           AND `insurance1`.CustomerID = `invoice`.CustomerID\r\n         LEFT JOIN `tbl_customer_insurance` as `insurance2` ON `insurance2`.ID         = `invoice`.CustomerInsurance2_ID\r\n                                                           AND `insurance2`.CustomerID = `invoice`.CustomerID\r\n         LEFT JOIN `tbl_customer_insurance` as `insurance3` ON `insurance3`.ID         = `invoice`.CustomerInsurance3_ID\r\n                                                           AND `insurance3`.CustomerID = `invoice`.CustomerID\r\n         LEFT JOIN `tbl_customer_insurance` as `insurance4` ON `insurance4`.ID         = `invoice`.CustomerInsurance4_ID\r\n                                                           AND `insurance4`.CustomerID = `invoice`.CustomerID\r\n         LEFT JOIN tbl_invoice_transaction as `tran` ON `tran`.InvoiceDetailsID = `detail`.ID\r\n                                                    AND `tran`.InvoiceID        = `detail`.InvoiceID\r\n                                                    AND `tran`.CustomerID       = `detail`.CustomerID\r\n         LEFT JOIN tbl_invoice_transactiontype as `trantype` ON `trantype`.ID = `tran`.TransactionTypeID\r\n  WHERE ((P_InvoiceID        IS NULL) OR (`invoice`.ID = P_InvoiceID       ))\r\n    AND ((P_InvoiceDetailsID IS NULL) OR (`detail`.ID  = P_InvoiceDetailsID))\r\n  ORDER BY `detail`.CustomerID, `detail`.InvoiceID, `detail`.ID, `tran`.`ID`; --\r\n\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  SET V_PrevCustomerID = null; --\r\n  SET V_PrevInvoiceID  = null; --\r\n  SET V_PrevDetailsID  = null; --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO\r\n      cur_CustomerID,\r\n      cur_InvoiceID,\r\n      cur_DetailsID,\r\n      cur_TranID,\r\n      cur_TranType,\r\n      cur_TranAmount,\r\n      cur_TranDate,\r\n      cur_TranOwner,\r\n      cur_Insurances,\r\n      cur_CustomerInsuranceID_1,\r\n      cur_CustomerInsuranceID_2,\r\n      cur_CustomerInsuranceID_3,\r\n      cur_CustomerInsuranceID_4,\r\n      cur_InsuranceCompanyID_1,\r\n      cur_InsuranceCompanyID_2,\r\n      cur_InsuranceCompanyID_3,\r\n      cur_InsuranceCompanyID_4,\r\n      cur_Percent,\r\n      cur_Basis; --\r\n\r\n    IF (done != 0)\r\n    OR (V_PrevCustomerID IS NULL) OR (cur_CustomerID != V_PrevCustomerID)\r\n    OR (V_PrevInvoiceID  IS NULL) OR (cur_InvoiceID  != V_PrevInvoiceID)\r\n    OR (V_PrevDetailsID  IS NULL) OR (cur_DetailsID  != V_PrevDetailsID)\r\n    THEN\r\n      IF  (V_PrevCustomerID IS NOT NULL)\r\n      AND (V_PrevInvoiceID  IS NOT NULL)\r\n      AND (V_PrevDetailsID  IS NOT NULL)\r\n      THEN\r\n        -- we must allow changing payer regardless of the payments (zero payments and total amount paid)\r\n        SET V_CurrentPayer\r\n          = CASE WHEN (V_ProposedPayer = F_Insco_1) THEN F_Insco_1\r\n                 WHEN (V_ProposedPayer = F_Insco_2) THEN F_Insco_2\r\n                 WHEN (V_ProposedPayer = F_Insco_3) THEN F_Insco_3\r\n                 WHEN (V_ProposedPayer = F_Insco_4) THEN F_Insco_4\r\n                 WHEN (V_ProposedPayer = F_Patient) THEN F_Patient\r\n                 WHEN (V_Insurances & F_Insco_1 != 0) AND (V_PaymentAmount_Insco_1 < 0.01) AND (V_ZeroPayments & F_Insco_1 = 0) THEN F_Insco_1\r\n                 WHEN (V_Insurances & F_Insco_2 != 0) AND (V_PaymentAmount_Insco_2 < 0.01) AND (V_ZeroPayments & F_Insco_2 = 0) THEN F_Insco_2\r\n                 WHEN (V_Insurances & F_Insco_3 != 0) AND (V_PaymentAmount_Insco_3 < 0.01) AND (V_ZeroPayments & F_Insco_3 = 0) THEN F_Insco_3\r\n                 WHEN (V_Insurances & F_Insco_4 != 0) AND (V_PaymentAmount_Insco_4 < 0.01) AND (V_ZeroPayments & F_Insco_4 = 0) THEN F_Insco_4\r\n                 ELSE F_Patient END; -- we should never switch from patient - somebody must pay --\r\n\r\n        -- save into db\r\n        UPDATE tbl_invoicedetails\r\n        SET Balance = BillableAmount - V_PaymentAmount - V_WriteoffAmount,\r\n            PaymentAmount  = V_PaymentAmount,\r\n            WriteoffAmount = V_WriteoffAmount,\r\n            DeductibleAmount = V_DeductibleAmount,\r\n            CurrentPayer\r\n              = CASE WHEN BillableAmount - V_PaymentAmount - V_WriteoffAmount < 0.01 THEN 'None'\r\n                     WHEN V_CurrentPayer = F_Insco_1 THEN 'Ins1'\r\n                     WHEN V_CurrentPayer = F_Insco_2 THEN 'Ins2'\r\n                     WHEN V_CurrentPayer = F_Insco_3 THEN 'Ins3'\r\n                     WHEN V_CurrentPayer = F_Insco_4 THEN 'Ins4'\r\n                     WHEN V_CurrentPayer = F_Patient THEN 'Patient'\r\n                     ELSE 'None' END,\r\n            SubmittedDate\r\n              = CASE WHEN BillableAmount - V_PaymentAmount - V_WriteoffAmount < 0.01 THEN null\r\n                     WHEN V_CurrentPayer = F_Insco_1 THEN V_SubmitDate_1\r\n                     WHEN V_CurrentPayer = F_Insco_2 THEN V_SubmitDate_2\r\n                     WHEN V_CurrentPayer = F_Insco_3 THEN V_SubmitDate_3\r\n                     WHEN V_CurrentPayer = F_Insco_4 THEN V_SubmitDate_4\r\n                     WHEN V_CurrentPayer = F_Patient THEN V_SubmitDate_P\r\n                     ELSE null END,\r\n            Submitted\r\n              = CASE WHEN BillableAmount - V_PaymentAmount - V_WriteoffAmount < 0.01 THEN 1\r\n                     WHEN V_CurrentPayer = F_Insco_1 THEN IF(V_SubmitDate_1 IS NOT NULL, 1, 0)\r\n                     WHEN V_CurrentPayer = F_Insco_2 THEN IF(V_SubmitDate_2 IS NOT NULL, 1, 0)\r\n                     WHEN V_CurrentPayer = F_Insco_3 THEN IF(V_SubmitDate_3 IS NOT NULL, 1, 0)\r\n                     WHEN V_CurrentPayer = F_Insco_4 THEN IF(V_SubmitDate_4 IS NOT NULL, 1, 0)\r\n                     WHEN V_CurrentPayer = F_Patient THEN IF(V_SubmitDate_P IS NOT NULL, 1, 0)\r\n                     ELSE 1 END,\r\n            CurrentInsuranceCompanyID\r\n              = CASE WHEN BillableAmount - V_PaymentAmount - V_WriteoffAmount < 0.01 THEN null\r\n                     WHEN V_CurrentPayer = F_Insco_1 THEN V_InsuranceCompanyID_1\r\n                     WHEN V_CurrentPayer = F_Insco_2 THEN V_InsuranceCompanyID_2\r\n                     WHEN V_CurrentPayer = F_Insco_3 THEN V_InsuranceCompanyID_3\r\n                     WHEN V_CurrentPayer = F_Insco_4 THEN V_InsuranceCompanyID_4\r\n                     WHEN V_CurrentPayer = F_Patient THEN null\r\n                     ELSE null END,\r\n            CurrentCustomerInsuranceID\r\n              = CASE WHEN BillableAmount - V_PaymentAmount - V_WriteoffAmount < 0.01 THEN null\r\n                     WHEN V_CurrentPayer = F_Insco_1 THEN V_CustomerInsuranceID_1\r\n                     WHEN V_CurrentPayer = F_Insco_2 THEN V_CustomerInsuranceID_2\r\n                     WHEN V_CurrentPayer = F_Insco_3 THEN V_CustomerInsuranceID_3\r\n                     WHEN V_CurrentPayer = F_Insco_4 THEN V_CustomerInsuranceID_4\r\n                     WHEN V_CurrentPayer = F_Patient THEN null\r\n                     ELSE null END,\r\n            -- for debugging\r\n            Pendings    = V_Pendings,\r\n            Submits     = V_Submits,\r\n            Payments\r\n              = CASE WHEN 0.01 <= V_PaymentAmount_Insco_1 OR V_ZeroPayments & F_Insco_1 != 0 THEN F_Insco_1 ELSE 0 END\r\n              + CASE WHEN 0.01 <= V_PaymentAmount_Insco_2 OR V_ZeroPayments & F_Insco_2 != 0 THEN F_Insco_2 ELSE 0 END\r\n              + CASE WHEN 0.01 <= V_PaymentAmount_Insco_3 OR V_ZeroPayments & F_Insco_3 != 0 THEN F_Insco_3 ELSE 0 END\r\n              + CASE WHEN 0.01 <= V_PaymentAmount_Insco_4 OR V_ZeroPayments & F_Insco_4 != 0 THEN F_Insco_4 ELSE 0 END\r\n              + CASE WHEN 0.01 <= V_PaymentAmount_Patient THEN F_Patient ELSE 0 END\r\n        WHERE (CustomerID = V_PrevCustomerID) AND (InvoiceID = V_PrevInvoiceID) AND (ID = V_PrevDetailsID); --\r\n      END IF; --\r\n\r\n      -- init / reinit\r\n      SET V_PrevCustomerID = cur_CustomerID; --\r\n      SET V_PrevInvoiceID  = cur_InvoiceID; --\r\n      SET V_PrevDetailsID  = cur_DetailsID; --\r\n\r\n      SET V_PaymentAmount_Insco_1 = 0.0; --\r\n      SET V_PaymentAmount_Insco_2 = 0.0; --\r\n      SET V_PaymentAmount_Insco_3 = 0.0; --\r\n      SET V_PaymentAmount_Insco_4 = 0.0; --\r\n      SET V_PaymentAmount_Patient = 0.0; --\r\n      SET V_PaymentAmount  = 0.0; --\r\n      SET V_WriteoffAmount = 0.0; --\r\n      SET V_DeductibleAmount = 0.0; --\r\n      SET V_ProposedPayer = null; --\r\n      SET V_Insurances = cur_Insurances; -- snapshot of insurances available for current line\r\n      SET V_Pendings = 0; --\r\n      SET V_Submits  = 0; --\r\n      SET V_ZeroPayments = 0; --\r\n      SET V_SubmitDate_1 = null; --\r\n      SET V_SubmitDate_2 = null; --\r\n      SET V_SubmitDate_3 = null; --\r\n      SET V_SubmitDate_4 = null; --\r\n      SET V_SubmitDate_P = null; --\r\n      SET V_InsuranceCompanyID_1 = cur_InsuranceCompanyID_1; --\r\n      SET V_InsuranceCompanyID_2 = cur_InsuranceCompanyID_2; --\r\n      SET V_InsuranceCompanyID_3 = cur_InsuranceCompanyID_3; --\r\n      SET V_InsuranceCompanyID_4 = cur_InsuranceCompanyID_4; --\r\n      SET V_CustomerInsuranceID_1 = cur_CustomerInsuranceID_1; --\r\n      SET V_CustomerInsuranceID_2 = cur_CustomerInsuranceID_2; --\r\n      SET V_CustomerInsuranceID_3 = cur_CustomerInsuranceID_3; --\r\n      SET V_CustomerInsuranceID_4 = cur_CustomerInsuranceID_4; --\r\n    END IF; --\r\n\r\n    IF (done = 0)\r\n    AND (cur_TranID IS NOT NULL)\r\n    THEN\r\n      -- Only 'Payment' and 'Change Current Payee' changes current payer\r\n      IF (cur_TranType = 'Contractual Writeoff') OR (cur_TranType = 'Writeoff') THEN\r\n        SET V_WriteoffAmount = V_WriteoffAmount + IFNULL(cur_TranAmount, 0); --\r\n\r\n      ELSEIF (cur_TranType = 'Submit') OR (cur_TranType = 'Auto Submit') THEN\r\n        SET V_Submits = V_Submits | cur_TranOwner; --\r\n        IF     (cur_TranOwner = F_Insco_1) THEN\r\n          SET V_SubmitDate_1 = cur_TranDate; --\r\n        ELSEIF (cur_TranOwner = F_Insco_2) THEN\r\n          SET V_SubmitDate_2 = cur_TranDate; --\r\n        ELSEIF (cur_TranOwner = F_Insco_3) THEN\r\n          SET V_SubmitDate_3 = cur_TranDate; --\r\n        ELSEIF (cur_TranOwner = F_Insco_4) THEN\r\n          SET V_SubmitDate_4 = cur_TranDate; --\r\n        ELSEIF (cur_TranOwner = F_Patient) THEN\r\n          SET V_SubmitDate_P = cur_TranDate; --\r\n        END IF; --\r\n\r\n      ELSEIF (cur_TranType = 'Voided Submission') THEN\r\n        SET V_Submits = V_Submits & ~cur_TranOwner; --\r\n        IF     (cur_TranOwner = F_Insco_1) THEN\r\n          SET V_SubmitDate_1 = null; --\r\n        ELSEIF (cur_TranOwner = F_Insco_2) THEN\r\n          SET V_SubmitDate_2 = null; --\r\n        ELSEIF (cur_TranOwner = F_Insco_3) THEN\r\n          SET V_SubmitDate_3 = null; --\r\n        ELSEIF (cur_TranOwner = F_Insco_4) THEN\r\n          SET V_SubmitDate_4 = null; --\r\n        ELSEIF (cur_TranOwner = F_Patient) THEN\r\n          SET V_SubmitDate_P = null; --\r\n        END IF; --\r\n\r\n      ELSEIF (cur_TranType = 'Pending Submission') THEN\r\n        SET V_Pendings = V_Pendings | cur_TranOwner; --\r\n\r\n      ELSEIF (cur_TranType = 'Change Current Payee') THEN\r\n        IF (cur_TranOwner = F_Insco_1 and V_Insurances & F_Insco_1 != 0)\r\n        OR (cur_TranOwner = F_Insco_2 and V_Insurances & F_Insco_2 != 0)\r\n        OR (cur_TranOwner = F_Insco_3 and V_Insurances & F_Insco_3 != 0)\r\n        OR (cur_TranOwner = F_Insco_4 and V_Insurances & F_Insco_4 != 0)\r\n        OR (cur_TranOwner = F_Patient)\r\n        THEN\r\n          -- \"Change Current Payee\" transaction changes responsibility unconditionally\r\n          SET V_ProposedPayer = cur_TranOwner; --\r\n        END IF; --\r\n\r\n      ELSEIF (cur_TranType = 'Payment') THEN\r\n        IF (ABS(cur_TranAmount) < 0.01) THEN\r\n          SET V_ZeroPayments = V_ZeroPayments | cur_TranOwner; --\r\n        ELSE\r\n          SET V_ZeroPayments = V_ZeroPayments & ~cur_TranOwner; --\r\n        END IF; --\r\n\r\n        IF (cur_TranOwner = F_Insco_1) THEN\r\n          SET V_PaymentAmount_Insco_1 = V_PaymentAmount_Insco_1 + cur_TranAmount; --\r\n        ELSEIF (cur_TranOwner = F_Insco_2) THEN\r\n          SET V_PaymentAmount_Insco_2 = V_PaymentAmount_Insco_2 + cur_TranAmount; --\r\n        ELSEIF (cur_TranOwner = F_Insco_3) THEN\r\n          SET V_PaymentAmount_Insco_3 = V_PaymentAmount_Insco_3 + cur_TranAmount; --\r\n        ELSEIF (cur_TranOwner = F_Insco_4) THEN\r\n          SET V_PaymentAmount_Insco_4 = V_PaymentAmount_Insco_4 + cur_TranAmount; --\r\n        ELSEIF (cur_TranOwner = F_Patient) THEN\r\n          SET V_PaymentAmount_Patient = V_PaymentAmount_Patient + cur_TranAmount; --\r\n        END IF; --\r\n\r\n        SET V_PaymentAmount = V_PaymentAmount + cur_TranAmount; --\r\n\r\n        IF (cur_TranOwner = V_ProposedPayer)\r\n        AND (0.00 <= cur_TranAmount) THEN\r\n          -- \"Payment\" transaction (with positive or zero amount) advances responsibility to next payer\r\n          SET V_ProposedPayer = null; --\r\n        END IF; --\r\n\r\n      ELSEIF (cur_TranType = 'Deductible') THEN\r\n        -- I guess we should use deductible amount of first insurance only\r\n        IF (cur_TranOwner = F_Insco_1) THEN\r\n          SET V_DeductibleAmount = IFNULL(cur_TranAmount, 0.0); --\r\n        END IF; --\r\n\r\n      END IF; --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_Reflag",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  CALL InvoiceDetails_RecalculateInternals(P_InvoiceID, P_InvoiceDetailsID); --\r\n  CALL InvoiceDetails_InternalReflag      (P_InvoiceID, P_InvoiceDetailsID, P_LastUpdateUserID); --\r\n  CALL InvoiceDetails_RecalculateInternals(P_InvoiceID, P_InvoiceDetailsID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "InvoiceDetails_WriteoffBalance",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  CALL InvoiceDetails_RecalculateInternals   (P_InvoiceID, P_InvoiceDetailsID); --\r\n  CALL InvoiceDetails_InternalWriteoffBalance(P_InvoiceID, P_InvoiceDetailsID, P_LastUpdateUserID); --\r\n  CALL InvoiceDetails_RecalculateInternals   (P_InvoiceID, P_InvoiceDetailsID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "InvoiceMustBeSkipped",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  -- means that we should not generate invoice\r\n  -- 'Capped rental' with delivery date after 2006-01-01 will be treated like 'Rent to Purchase'\r\n  IF P_BillingMonth <= 0 THEN\r\n    SET P_BillingMonth = 1; --\r\n  END IF; --\r\n\r\n  IF P_SaleRentType IN ('One Time Sale', 'Re-occurring Sale', 'One Time Rental') THEN\r\n    RETURN (1 < P_BillingMonth); --\r\n  ELSEIF P_SaleRentType = 'Medicare Oxygen Rental' THEN\r\n    IF P_DeliveryDate < '2006-01-01' THEN\r\n      RETURN ('2009-01-01' <= P_DosFrom) AND (36 < P_BillingMonth); --\r\n    ELSE\r\n      RETURN (36 < P_BillingMonth); --\r\n    END IF; --\r\n  ELSEIF P_SaleRentType = 'Monthly Rental' THEN\r\n    RETURN 0; --\r\n  ELSEIF P_SaleRentType = 'Rent to Purchase' THEN\r\n    RETURN (10 < P_BillingMonth); --\r\n  ELSEIF P_SaleRentType = 'Capped Rental' OR P_SaleRentType = 'Parental Capped Rental' THEN\r\n    IF P_DeliveryDate < '2006-01-01' THEN\r\n      IF (P_BillingMonth <= 15) THEN\r\n        RETURN 0; --\r\n      ELSEIF (P_BillingMonth < 22) THEN\r\n        RETURN 1; --\r\n      ELSE\r\n        RETURN ((P_BillingMonth - 22) mod 6 != 0); --\r\n      END IF; --\r\n    ELSE\r\n      RETURN (13 < P_BillingMonth); --\r\n    END IF; --\r\n  END IF; --\r\n\r\n  RETURN 0; --\r\nEND",
    "DATA_TYPE": "bit",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "Invoice_AddAutoSubmit",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE V_InvoiceDetailsID INT; --\r\n  DECLARE V_Result VARCHAR(50); --\r\n  DECLARE cur CURSOR FOR SELECT ID FROM tbl_invoicedetails WHERE (InvoiceID = P_InvoiceID); --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  CALL InvoiceDetails_RecalculateInternals_Single(P_InvoiceID, null); --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO V_InvoiceDetailsID; --\r\n    IF NOT done THEN\r\n      CALL InvoiceDetails_InternalAddAutoSubmit(V_InvoiceDetailsID, P_AutoSubmittedTo, P_LastUpdateUserID, V_Result); --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\n\r\n  CALL InvoiceDetails_RecalculateInternals_Single(P_InvoiceID, null); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "Invoice_AddSubmitted",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE V_InvoiceDetailsID INT; --\r\n  DECLARE cur CURSOR FOR SELECT ID FROM tbl_invoicedetails WHERE (InvoiceID = P_InvoiceID) AND (CurrentPayer = P_SubmittedTo); --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  CALL InvoiceDetails_RecalculateInternals_Single(P_InvoiceID, null); --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO V_InvoiceDetailsID; --\r\n    IF NOT done THEN\r\n      CALL InvoiceDetails_AddSubmitted(V_InvoiceDetailsID, 0.00, P_SubmittedTo, P_SubmittedBy, P_SubmittedBatch, P_LastUpdateUserID); --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\n\r\n  CALL InvoiceDetails_RecalculateInternals_Single(P_InvoiceID, null); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "Invoice_InternalReflag",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE F_Insco_1 tinyint DEFAULT 01; --\r\n  DECLARE F_Insco_2 tinyint DEFAULT 02; --\r\n  DECLARE F_Insco_3 tinyint DEFAULT 04; --\r\n  DECLARE F_Insco_4 tinyint DEFAULT 08; --\r\n  DECLARE F_Patient tinyint DEFAULT 16; --\r\n\r\n  DECLARE V_TransactionTypeID int DEFAULT 0; --\r\n  DECLARE V_Username VARCHAR(50); --\r\n\r\n  SET V_TransactionTypeID = NULL; --\r\n  SELECT ID\r\n  INTO V_TransactionTypeID\r\n  FROM tbl_invoice_transactiontype\r\n  WHERE (Name = 'Voided Submission'); --\r\n\r\n  SET V_Username = ''; --\r\n  SELECT Login\r\n  INTO V_Username\r\n  FROM tbl_user\r\n  WHERE (ID = P_LastUpdateUserID); --\r\n\r\n  IF P_Extra NOT LIKE '<values>%</values>'\r\n  AND P_Extra NOT LIKE '<values%/>'\r\n  THEN\r\n    SET P_Extra = NULL; --\r\n  END IF; --\r\n\r\n  INSERT INTO tbl_invoice_transaction\r\n  ( InvoiceDetailsID\r\n  , InvoiceID\r\n  , CustomerID\r\n  , InsuranceCompanyID\r\n  , CustomerInsuranceID\r\n  , TransactionTypeID\r\n  , Amount\r\n  , Quantity\r\n  , TransactionDate\r\n  , BatchNumber\r\n  , Comments\r\n  , Extra\r\n  , LastUpdateUserID)\r\n  SELECT\r\n    InvoiceDetailsID\r\n  , InvoiceID\r\n  , CustomerID\r\n  , CASE CurrentPayer WHEN 'Patient' THEN null\r\n                      WHEN 'Ins4'    THEN InsuranceCompany4_ID\r\n                      WHEN 'Ins3'    THEN InsuranceCompany3_ID\r\n                      WHEN 'Ins2'    THEN InsuranceCompany2_ID\r\n                      WHEN 'Ins1'    THEN InsuranceCompany1_ID\r\n                      ELSE null END as InsuranceCompanyID\r\n  , CASE CurrentPayer WHEN 'Patient' THEN null\r\n                      WHEN 'Ins4'    THEN Insurance4_ID\r\n                      WHEN 'Ins3'    THEN Insurance3_ID\r\n                      WHEN 'Ins2'    THEN Insurance2_ID\r\n                      WHEN 'Ins1'    THEN Insurance1_ID\r\n                      ELSE null END as CustomerInsuranceID\r\n  , V_TransactionTypeID as TransactionTypeID\r\n  , BillableAmount\r\n  , Quantity\r\n  , CURRENT_DATE()\r\n  , null as BatchNumber\r\n  , Concat('Reflagged by ', V_Username) as Comments\r\n  , P_Extra\r\n  , P_LastUpdateUserID as LastUpdateUserID\r\n  FROM view_invoicetransaction_statistics\r\n  WHERE (InvoiceID = P_InvoiceID)\r\n    AND ((CurrentPayer = 'Patient' AND Submits & F_Patient != 0) OR\r\n         (CurrentPayer = 'Ins4'    AND Submits & F_Insco_4 != 0) OR\r\n         (CurrentPayer = 'Ins3'    AND Submits & F_Insco_3 != 0) OR\r\n         (CurrentPayer = 'Ins2'    AND Submits & F_Insco_2 != 0) OR\r\n         (CurrentPayer = 'Ins1'    AND Submits & F_Insco_1 != 0)); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "Invoice_InternalUpdateBalance",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  UPDATE tbl_invoice as i\r\n  LEFT JOIN (SELECT tbl_invoicedetails.InvoiceID, Sum(tbl_invoicedetails.Balance) as Balance\r\n             FROM tbl_invoice\r\n                  INNER JOIN tbl_invoicedetails ON tbl_invoicedetails.CustomerID = tbl_invoice.CustomerID\r\n                                               AND tbl_invoicedetails.InvoiceID  = tbl_invoice.ID\r\n             WHERE (tbl_invoice.ID = P_InvoiceID)\r\n             GROUP BY tbl_invoicedetails.InvoiceID) as b\r\n         ON b.InvoiceID = i.ID\r\n  SET i.InvoiceBalance = IFNULL(b.Balance, 0)\r\n  WHERE (i.ID = P_InvoiceID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "Invoice_InternalUpdatePendingSubmissions",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE\r\n    V_CustomerID,\r\n    V_InvoiceID,\r\n    V_InvoiceDetailsID,\r\n    V_Insurance1_ID,\r\n    V_Insurance2_ID,\r\n    V_Insurance3_ID,\r\n    V_Insurance4_ID,\r\n    V_Company1_ID,\r\n    V_Company2_ID,\r\n    V_Company3_ID,\r\n    V_Company4_ID,\r\n    V_Insurances,\r\n    V_PendingSubmissions,\r\n    V_Payments INT; --\r\n  DECLARE\r\n    V_CurrentPayer VARCHAR(10); --\r\n  DECLARE\r\n    V_PendingSubmissionID,\r\n    V_WriteoffID INT; --\r\n  DECLARE\r\n    V_PaymentAmount,\r\n    V_WriteoffAmount,\r\n    V_BillableAmount DECIMAL(18, 2); --\r\n  DECLARE\r\n    V_Quantity DOUBLE; --\r\n  DECLARE\r\n    V_Hardship TINYINT(1); --\r\n  DECLARE cur CURSOR FOR\r\n    SELECT\r\n      CustomerID,\r\n      InvoiceID,\r\n      InvoiceDetailsID,\r\n      PaymentAmount,\r\n      WriteoffAmount,\r\n      BillableAmount,\r\n      IFNULL(Quantity, 0.0) as Quantity,\r\n      Insurance1_ID,\r\n      Insurance2_ID,\r\n      Insurance3_ID,\r\n      Insurance4_ID,\r\n      InsuranceCompany1_ID,\r\n      InsuranceCompany2_ID,\r\n      InsuranceCompany3_ID,\r\n      InsuranceCompany4_ID,\r\n      Insurances,\r\n      PendingSubmissions,\r\n      Payments,\r\n      CurrentPayer\r\n  FROM view_invoicetransaction_statistics\r\n  WHERE (InvoiceID = P_InvoiceID) OR (P_InvoiceID IS NULL); --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  SET V_PendingSubmissionID = NULL; --\r\n\r\n  SELECT ID\r\n  INTO V_PendingSubmissionID\r\n  FROM tbl_invoice_transactiontype\r\n  WHERE (Name = 'Pending Submission'); --\r\n\r\n  SET V_WriteoffID = NULL; --\r\n\r\n  SELECT ID\r\n  INTO V_WriteoffID\r\n  FROM tbl_invoice_transactiontype\r\n  WHERE (Name = 'Writeoff'); --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO\r\n      V_CustomerID,\r\n      V_InvoiceID,\r\n      V_InvoiceDetailsID,\r\n      V_PaymentAmount,\r\n      V_WriteoffAmount,\r\n      V_BillableAmount,\r\n      V_Quantity,\r\n      V_Insurance1_ID,\r\n      V_Insurance2_ID,\r\n      V_Insurance3_ID,\r\n      V_Insurance4_ID,\r\n      V_Company1_ID,\r\n      V_Company2_ID,\r\n      V_Company3_ID,\r\n      V_Company4_ID,\r\n      V_Insurances,\r\n      V_PendingSubmissions,\r\n      V_Payments,\r\n      V_CurrentPayer; --\r\n\r\n    IF NOT done THEN\r\n      IF (V_CurrentPayer = 'Ins1') AND (V_Insurance1_ID IS NOT NULL) AND (V_PendingSubmissions & 01 = 00) THEN -- first insurance requires billing but do not have 'pending submission'\r\n        INSERT INTO `tbl_invoice_transaction`\r\n          (`InvoiceDetailsID`, `InvoiceID`, `CustomerID`, `InsuranceCompanyID`, `CustomerInsuranceID`, `TransactionTypeID`, `TransactionDate`, `Comments`, `Amount`, `Quantity`)\r\n        VALUES\r\n          (V_InvoiceDetailsID, V_InvoiceID, V_CustomerID,        V_Company1_ID,       V_Insurance1_ID, V_PendingSubmissionID,    CURRENT_DATE(), 'Ins1',\r\n           V_BillableAmount, V_Quantity); --\r\n\r\n      ELSEIF (V_CurrentPayer = 'Ins2') AND (V_Insurance2_ID IS NOT NULL) AND (V_PendingSubmissions & 02 = 00) THEN -- second insurance requires billing but do not have 'pending submission'\r\n        INSERT INTO `tbl_invoice_transaction`\r\n          (`InvoiceDetailsID`, `InvoiceID`, `CustomerID`, `InsuranceCompanyID`, `CustomerInsuranceID`, `TransactionTypeID`, `TransactionDate`, `Comments`, `Amount`, `Quantity`)\r\n        VALUES\r\n          (V_InvoiceDetailsID, V_InvoiceID, V_CustomerID,        V_Company2_ID,       V_Insurance2_ID, V_PendingSubmissionID,    CURRENT_DATE(), 'Ins2',\r\n           V_BillableAmount - V_PaymentAmount - V_WriteoffAmount, V_Quantity); --\r\n\r\n      ELSEIF (V_CurrentPayer = 'Ins3') AND (V_Insurance3_ID IS NOT NULL) AND (V_PendingSubmissions & 04 = 00) THEN -- third insurance requires billing but do not have 'pending submission'\r\n        INSERT INTO `tbl_invoice_transaction`\r\n          (`InvoiceDetailsID`, `InvoiceID`, `CustomerID`, `InsuranceCompanyID`, `CustomerInsuranceID`, `TransactionTypeID`, `TransactionDate`, `Comments`, `Amount`, `Quantity`)\r\n        VALUES\r\n          (V_InvoiceDetailsID, V_InvoiceID, V_CustomerID,        V_Company3_ID,       V_Insurance3_ID, V_PendingSubmissionID,    CURRENT_DATE(), 'Ins3',\r\n           V_BillableAmount - V_PaymentAmount - V_WriteoffAmount, V_Quantity); --\r\n\r\n      ELSEIF (V_CurrentPayer = 'Ins4') AND (V_Insurance4_ID IS NOT NULL) AND (V_PendingSubmissions & 08 = 00) THEN -- fourth insurance requires billing but do not have 'pending submission'\r\n        INSERT INTO `tbl_invoice_transaction`\r\n          (`InvoiceDetailsID`, `InvoiceID`, `CustomerID`, `InsuranceCompanyID`, `CustomerInsuranceID`, `TransactionTypeID`, `TransactionDate`, `Comments`, `Amount`, `Quantity`)\r\n        VALUES\r\n          (V_InvoiceDetailsID, V_InvoiceID, V_CustomerID,        V_Company4_ID,       V_Insurance4_ID, V_PendingSubmissionID,    CURRENT_DATE(), 'Ins4',\r\n           V_BillableAmount - V_PaymentAmount - V_WriteoffAmount, V_Quantity); --\r\n\r\n      ELSEIF (V_CurrentPayer = 'Patient') AND (V_PendingSubmissions & 16 = 00) THEN -- patient requires billing but do not have 'pending submission'\r\n        INSERT INTO `tbl_invoice_transaction`\r\n          (`InvoiceDetailsID`, `InvoiceID`, `CustomerID`, `InsuranceCompanyID`, `CustomerInsuranceID`, `TransactionTypeID`, `TransactionDate`, `Comments`, `Amount`, `Quantity`)\r\n        VALUES\r\n          (V_InvoiceDetailsID, V_InvoiceID, V_CustomerID,                 null,                  null, V_PendingSubmissionID,    CURRENT_DATE(), 'Patient',\r\n           V_BillableAmount - V_PaymentAmount - V_WriteoffAmount, V_Quantity); --\r\n\r\n      END IF; --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "Invoice_Reflag",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  CALL InvoiceDetails_RecalculateInternals_Single(P_InvoiceID, NULL); --\r\n  CALL Invoice_InternalReflag                    (P_InvoiceID, P_Extra, P_LastUpdateUserID); --\r\n  CALL InvoiceDetails_RecalculateInternals_Single(P_InvoiceID, NULL); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "Invoice_UpdateBalance",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  IF P_Recursive THEN\r\n    CALL `InvoiceDetails_RecalculateInternals_Single`(P_InvoiceID, null); --\r\n  END IF; --\r\n\r\n  CALL `Invoice_InternalUpdateBalance`(P_InvoiceID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "Invoice_UpdatePendingSubmissions",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  CALL InvoiceDetails_RecalculateInternals_Single(P_InvoiceID, null); --\r\n  CALL Invoice_InternalUpdatePendingSubmissions  (P_InvoiceID); --\r\n  CALL InvoiceDetails_RecalculateInternals_Single(P_InvoiceID, null); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "mir_update",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  CALL mir_update_facility(null); --\r\n  CALL mir_update_insurancecompany(null); --\r\n  CALL mir_update_customer_insurance(null); --\r\n  CALL mir_update_doctor(null); --\r\n  CALL mir_update_customer(null); --\r\n  CALL mir_update_cmnform(null); --\r\n  CALL mir_update_orderdetails('ActiveOnly'); --\r\n  CALL mir_update_order('ActiveOnly'); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "mir_update_cmnform",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_customer as tbl_customer ON tbl_cmnform.CustomerID = tbl_customer.ID\r\n         LEFT JOIN tbl_doctor   as tbl_doctor   ON tbl_cmnform.DoctorID   = tbl_doctor  .ID\r\n         LEFT JOIN tbl_facility as tbl_facility ON tbl_cmnform.FacilityID = tbl_facility.ID\r\n  SET tbl_cmnform.`MIR` =\r\n      CONCAT_WS(',',\r\n          IF(IFNULL(tbl_cmnform.CMNType              , '') = '', 'CMNType'              , null),\r\n          IF(IFNULL(tbl_cmnform.Signature_Name       , '') = '', 'Signature_Name'       , null),\r\n          IF(tbl_cmnform.InitialDate    is null, 'InitialDate'   , null),\r\n          IF(tbl_cmnform.POSTypeID      is null, 'POSTypeID'     , null),\r\n          IF(tbl_cmnform.Signature_Date is null, 'Signature_Date', null),\r\n          CASE WHEN tbl_cmnform.EstimatedLengthOfNeed is null THEN 'EstimatedLengthOfNeed'\r\n               WHEN tbl_cmnform.EstimatedLengthOfNeed <= 0    THEN 'EstimatedLengthOfNeed'\r\n               ELSE null END,\r\n          IF(tbl_customer.ID IS NULL, 'CustomerID', null),\r\n          IF(tbl_customer.MIR != '' , 'Customer'  , null),\r\n          IF(tbl_doctor  .ID IS NULL, 'DoctorID'  , null),\r\n          IF(tbl_doctor  .MIR != '' , 'Doctor'    , null))\r\n  WHERE (tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_icd9 as icd_1 ON tbl_cmnform.Customer_ICD9_1 = icd_1.Code\r\n         LEFT JOIN tbl_icd9 as icd_2 ON tbl_cmnform.Customer_ICD9_2 = icd_2.Code\r\n         LEFT JOIN tbl_icd9 as icd_3 ON tbl_cmnform.Customer_ICD9_3 = icd_3.Code\r\n         LEFT JOIN tbl_icd9 as icd_4 ON tbl_cmnform.Customer_ICD9_4 = icd_4.Code\r\n  SET tbl_cmnform.`MIR` =\r\n      CONCAT_WS(',',\r\n          tbl_cmnform.`MIR`,\r\n          CASE WHEN IFNULL(tbl_cmnform.Customer_ICD9_1, '') = ''  THEN 'ICD9_1.Required'\r\n               WHEN icd_1.Code is null                            THEN 'ICD9_1.Unknown'\r\n               WHEN icd_1.InactiveDate <= tbl_cmnform.InitialDate THEN 'ICD9_1.Inactive'\r\n               ELSE null END,\r\n          CASE WHEN IFNULL(tbl_cmnform.Customer_ICD9_2, '') = ''  THEN null\r\n               WHEN icd_2.Code is null                            THEN 'ICD9_2.Unknown'\r\n               WHEN icd_2.InactiveDate <= tbl_cmnform.InitialDate THEN 'ICD9_2.Inactive'\r\n               ELSE null END,\r\n          CASE WHEN IFNULL(tbl_cmnform.Customer_ICD9_3, '') = ''  THEN null\r\n               WHEN icd_3.Code is null                            THEN 'ICD9_3.Unknown'\r\n               WHEN icd_3.InactiveDate <= tbl_cmnform.InitialDate THEN 'ICD9_3.Inactive'\r\n               ELSE null END,\r\n          CASE WHEN IFNULL(tbl_cmnform.Customer_ICD9_4, '') = ''  THEN null\r\n               WHEN icd_4.Code is null                            THEN 'ICD9_4.Unknown'\r\n               WHEN icd_4.InactiveDate <= tbl_cmnform.InitialDate THEN 'ICD9_4.Inactive'\r\n               ELSE null END)\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.Customer_UsingICD10 != 1 OR tbl_cmnform.Customer_UsingICD10 IS NULL); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_icd10 as icd_1 ON tbl_cmnform.Customer_ICD9_1 = icd_1.Code\r\n         LEFT JOIN tbl_icd10 as icd_2 ON tbl_cmnform.Customer_ICD9_2 = icd_2.Code\r\n         LEFT JOIN tbl_icd10 as icd_3 ON tbl_cmnform.Customer_ICD9_3 = icd_3.Code\r\n         LEFT JOIN tbl_icd10 as icd_4 ON tbl_cmnform.Customer_ICD9_4 = icd_4.Code\r\n  SET tbl_cmnform.`MIR` =\r\n      CONCAT_WS(',',\r\n          tbl_cmnform.`MIR`,\r\n          CASE WHEN IFNULL(tbl_cmnform.Customer_ICD9_1, '') = ''  THEN 'ICD9_1.Required'\r\n               WHEN icd_1.Code is null                            THEN 'ICD9_1.Unknown'\r\n               WHEN icd_1.InactiveDate <= tbl_cmnform.InitialDate THEN 'ICD9_1.Inactive'\r\n               ELSE null END,\r\n          CASE WHEN IFNULL(tbl_cmnform.Customer_ICD9_2, '') = ''  THEN null\r\n               WHEN icd_2.Code is null                            THEN 'ICD9_2.Unknown'\r\n               WHEN icd_2.InactiveDate <= tbl_cmnform.InitialDate THEN 'ICD9_2.Inactive'\r\n               ELSE null END,\r\n          CASE WHEN IFNULL(tbl_cmnform.Customer_ICD9_3, '') = ''  THEN null\r\n               WHEN icd_3.Code is null                            THEN 'ICD9_3.Unknown'\r\n               WHEN icd_3.InactiveDate <= tbl_cmnform.InitialDate THEN 'ICD9_3.Inactive'\r\n               ELSE null END,\r\n          CASE WHEN IFNULL(tbl_cmnform.Customer_ICD9_4, '') = ''  THEN null\r\n               WHEN icd_4.Code is null                            THEN 'ICD9_4.Unknown'\r\n               WHEN icd_4.InactiveDate <= tbl_cmnform.InitialDate THEN 'ICD9_4.Inactive'\r\n               ELSE null END)\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.Customer_UsingICD10 = 1); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0102a ON tbl_cmnform.ID = tbl_cmnform_0102a.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 01.02A')\r\n    AND (IFNULL(tbl_cmnform_0102a.Answer1, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102a.Answer3, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102a.Answer4, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102a.Answer5, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102a.Answer6, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102a.Answer7, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0102b ON tbl_cmnform.ID = tbl_cmnform_0102b.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 01.02B')\r\n    AND (IFNULL(tbl_cmnform_0102b.Answer12, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102b.Answer13, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102b.Answer14, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102b.Answer15, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102b.Answer16, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102b.Answer19, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102b.Answer20, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0102b.Answer22, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0203a ON tbl_cmnform.ID = tbl_cmnform_0203a.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 02.03A')\r\n    AND (IFNULL(tbl_cmnform_0203a.Answer1, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0203a.Answer2, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0203a.Answer3, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0203a.Answer4, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0203a.Answer6, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0203a.Answer7, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0203b ON tbl_cmnform.ID = tbl_cmnform_0203b.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 02.03B')\r\n    AND (IFNULL(tbl_cmnform_0203b.Answer1, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0203b.Answer2, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0203b.Answer3, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0203b.Answer4, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0203b.Answer8, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0203b.Answer9, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0302 ON tbl_cmnform.ID = tbl_cmnform_0302.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 03.02')\r\n    AND (IFNULL(tbl_cmnform_0302.Answer14, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0403b ON tbl_cmnform.ID = tbl_cmnform_0403b.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 04.03B')\r\n    AND (IFNULL(tbl_cmnform_0403b.Answer1, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0403b.Answer2, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0403b.Answer3, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0403b.Answer4, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0403b.Answer5, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0403c ON tbl_cmnform.ID = tbl_cmnform_0403c.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 04.03C')\r\n    AND (IFNULL(tbl_cmnform_0403c.Answer6a , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0403c.Answer7a , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0403c.Answer8  , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0403c.Answer9a , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0403c.Answer10a, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0403c.Answer11a, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0602b ON tbl_cmnform.ID = tbl_cmnform_0602b.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 06.02B')\r\n    AND (IFNULL(tbl_cmnform_0602b.Answer1 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0602b.Answer3 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0602b.Answer6 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0602b.Answer7 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0602b.Answer11, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0702a ON tbl_cmnform.ID = tbl_cmnform_0702a.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 07.02A')\r\n    AND (IFNULL(tbl_cmnform_0702a.Answer1, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0702a.Answer2, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0702a.Answer3, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0702a.Answer4, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0702a.Answer5, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0702b ON tbl_cmnform.ID = tbl_cmnform_0702b.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 07.02B')\r\n    AND (IFNULL(tbl_cmnform_0702b.Answer6 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0702b.Answer7 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0702b.Answer8 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0702b.Answer12, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0702b.Answer13, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0702b.Answer14, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0902 ON tbl_cmnform.ID = tbl_cmnform_0902.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 09.02')\r\n    AND (IFNULL(tbl_cmnform_0902.Answer7, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_1002a ON tbl_cmnform.ID = tbl_cmnform_1002a.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 10.02A')\r\n    AND (IFNULL(tbl_cmnform_1002a.Answer1, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_1002b ON tbl_cmnform.ID = tbl_cmnform_1002b.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 10.02B')\r\n    AND (IFNULL(tbl_cmnform_1002b.Answer7 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_1002b.Answer8 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_1002b.Answer14, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_4842 ON tbl_cmnform.ID = tbl_cmnform_4842.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DMERC 484.2')\r\n    AND (IFNULL(tbl_cmnform_4842.Answer2 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_4842.Answer5 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_4842.Answer8 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_4842.Answer9 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_4842.Answer10, '') != 'Y'); --\r\n\r\n  -- new forms\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0404b ON tbl_cmnform.ID = tbl_cmnform_0404b.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DME 04.04B')\r\n    AND (IFNULL(tbl_cmnform_0404b.Answer1, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0404b.Answer2, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0404b.Answer3, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0404b.Answer4, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0404b.Answer5, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0404c ON tbl_cmnform.ID = tbl_cmnform_0404c.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DME 04.04C')\r\n    AND (IFNULL(tbl_cmnform_0404c.Answer6  , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0404c.Answer7a , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0404c.Answer8  , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0404c.Answer9a , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0404c.Answer10a, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0404c.Answer11 , '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0404c.Answer12 , '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0603b ON tbl_cmnform.ID = tbl_cmnform_0603b.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DME 06.03B')\r\n    AND (IFNULL(tbl_cmnform_0603b.Answer1, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0603b.Answer4, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0603b.Answer5, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_0703a ON tbl_cmnform.ID = tbl_cmnform_0703a.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DME 07.03A')\r\n    AND (IFNULL(tbl_cmnform_0703a.Answer1, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0703a.Answer2, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0703a.Answer3, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0703a.Answer4, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_0703a.Answer5, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_1003 ON tbl_cmnform.ID = tbl_cmnform_1003.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DME 10.03')\r\n    AND (IFNULL(tbl_cmnform_1003.Answer1, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_1003.Answer2, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_1003.Answer7, '') != 'Y'); --\r\n\r\n  UPDATE tbl_cmnform\r\n         LEFT JOIN tbl_cmnform_48403 ON tbl_cmnform.ID = tbl_cmnform_48403.CMNFormID\r\n  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n    AND (tbl_cmnform.CMNType = 'DME 484.03')\r\n    AND ((tbl_cmnform_48403.Answer1a is null) OR\r\n         (tbl_cmnform_48403.Answer1b is null) OR\r\n         (IFNULL(tbl_cmnform_48403.Answer1c, '0000-00-00') = '0000-00-00'))\r\n    AND (IFNULL(tbl_cmnform_48403.Answer2, '')  = '')\r\n    AND (IFNULL(tbl_cmnform_48403.Answer3, '')  = '')\r\n    AND (IFNULL(tbl_cmnform_48403.Answer4, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_48403.Answer7, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_48403.Answer8, '') != 'Y')\r\n    AND (IFNULL(tbl_cmnform_48403.Answer9, '') != 'Y'); --\r\n\r\n--  `Answer1a` int(11) default NULL,\r\n--  `Answer1b` int(11) default NULL,\r\n--  `Answer1c` date default NULL,\r\n--  `Answer2` enum('1','2','3') NOT NULL default '1',\r\n--  `Answer3` enum('1','2','3') NOT NULL default '1',\r\n--  `Answer4` enum('Y','N','D') NOT NULL default 'D',\r\n--  `Answer5` varchar(10) default NULL,\r\n--  `Answer6a` int(11) default NULL,\r\n--  `Answer6b` int(11) default NULL,\r\n--  `Answer6c` date default NULL,\r\n--  `Answer7` enum('Y','N') NOT NULL default 'Y',\r\n--  `Answer8` enum('Y','N') NOT NULL default 'Y',\r\n--  `Answer9` enum('Y','N') NOT NULL default 'Y',\r\n\r\n--  UPDATE tbl_cmnform\r\n--         LEFT JOIN tbl_cmnform_drorder ON tbl_cmnform.ID = tbl_cmnform_drorder.CMNFormID\r\n--  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n--  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n--    AND (tbl_cmnform.CMNType = 'DMERC DRORDER')\r\n--    AND  (1 != 1); --\r\n\r\n--  UPDATE tbl_cmnform\r\n--         LEFT JOIN tbl_cmnform_uro ON tbl_cmnform.ID = tbl_cmnform_uro.CMNFormID\r\n--  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n--  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n--    AND (tbl_cmnform.CMNType = 'DMERC URO')\r\n--    AND  (1 != 1); --\r\n\r\n--  UPDATE tbl_cmnform\r\n--         LEFT JOIN tbl_cmnform_0903 ON tbl_cmnform.ID = tbl_cmnform_0903.CMNFormID\r\n--  SET tbl_cmnform.MIR = CONCAT_WS(',', 'Answers', IF(tbl_cmnform.MIR != '', tbl_cmnform.MIR, null))\r\n--  WHERE ((tbl_cmnform.ID = P_CMNFormID) OR (P_CMNFormID IS NULL))\r\n--    AND (tbl_cmnform.CMNType = 'DME 09.03')\r\n--    AND (1 != 1); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "mir_update_customer",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  UPDATE tbl_customer\r\n         LEFT JOIN tbl_doctor ON tbl_customer.Doctor1_ID = tbl_doctor.ID\r\n  SET tbl_customer.`MIR` =\r\n      IF(tbl_customer.CommercialAccount = 0\r\n        ,CONCAT_WS(','\r\n                  ,IF(IFNULL(tbl_customer.AccountNumber   , '') = '', 'AccountNumber'   , null)\r\n                  ,IF(IFNULL(tbl_customer.FirstName       , '') = '', 'FirstName'       , null)\r\n                  ,IF(IFNULL(tbl_customer.LastName        , '') = '', 'LastName'        , null)\r\n                  ,IF(IFNULL(tbl_customer.Address1        , '') = '', 'Address1'        , null)\r\n                  ,IF(IFNULL(tbl_customer.City            , '') = '', 'City'            , null)\r\n                  ,IF(IFNULL(tbl_customer.State           , '') = '', 'State'           , null)\r\n                  ,IF(IFNULL(tbl_customer.Zip             , '') = '', 'Zip'             , null)\r\n                  ,IF(IFNULL(tbl_customer.EmploymentStatus, '') = '', 'EmploymentStatus', null)\r\n                  ,IF(IFNULL(tbl_customer.Gender          , '') = '', 'Gender'          , null)\r\n                  ,IF(IFNULL(tbl_customer.MaritalStatus   , '') = '', 'MaritalStatus'   , null)\r\n                  ,IF(IFNULL(tbl_customer.MilitaryBranch  , '') = '', 'MilitaryBranch'  , null)\r\n                  ,IF(IFNULL(tbl_customer.MilitaryStatus  , '') = '', 'MilitaryStatus'  , null)\r\n                  ,IF(IFNULL(tbl_customer.StudentStatus   , '') = '', 'StudentStatus'   , null)\r\n                  ,IF(IFNULL(tbl_customer.MonthsValid     ,  0) =  0, 'MonthsValid'     , null)\r\n                  ,IF(tbl_customer.DateofBirth     IS NULL, 'DateofBirth'    , null)\r\n                  ,IF(tbl_customer.SignatureOnFile IS NULL, 'SignatureOnFile', null)\r\n                  ,IF(tbl_doctor.ID IS NULL, 'Doctor1_ID', null)\r\n                  ,IF(tbl_doctor.MIR != '' , 'Doctor1'   , null)\r\n                  )\r\n        ,'')\r\n  WHERE (tbl_customer.ID = P_CustomerID) OR (P_CustomerID IS NULL); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "mir_update_customer_insurance",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  UPDATE tbl_customer_insurance as policy\r\n         LEFT JOIN tbl_customer ON policy.CustomerID = tbl_customer.ID\r\n         LEFT JOIN tbl_insurancecompany ON policy.InsuranceCompanyID = tbl_insurancecompany.ID\r\n  SET policy.`MIR` =\r\n      IF(tbl_customer.CommercialAccount = 0\r\n        ,CONCAT_WS(','\r\n                  ,IF((policy.RelationshipCode != '18') AND (IFNULL(policy.FirstName, '') = ''), 'FirstName'  , null)\r\n                  ,IF((policy.RelationshipCode != '18') AND (IFNULL(policy.LastName , '') = ''), 'LastName'   , null)\r\n                  ,IF((policy.RelationshipCode != '18') AND (IFNULL(policy.Address1 , '') = ''), 'Address1'   , null)\r\n                  ,IF((policy.RelationshipCode != '18') AND (IFNULL(policy.City     , '') = ''), 'City'       , null)\r\n                  ,IF((policy.RelationshipCode != '18') AND (IFNULL(policy.State    , '') = ''), 'State'      , null)\r\n                  ,IF((policy.RelationshipCode != '18') AND (IFNULL(policy.Zip      , '') = ''), 'Zip'        , null)\r\n                  ,IF((policy.RelationshipCode != '18') AND (IFNULL(policy.Gender   , '') = ''), 'Gender'     , null)\r\n                  ,IF((policy.RelationshipCode != '18') AND (policy.DateofBirth IS NULL       ), 'DateofBirth', null)\r\n                  ,IF(IFNULL(policy.InsuranceType   , '') = '', 'InsuranceType'   , null)\r\n                  ,IF(IFNULL(policy.PolicyNumber    , '') = '', 'PolicyNumber'    , null)\r\n                  ,IF(IFNULL(policy.RelationshipCode, '') = '', 'RelationshipCode', null)\r\n                  ,IF(tbl_insurancecompany.ID IS NULL, 'InsuranceCompanyID', null)\r\n                  ,IF(tbl_insurancecompany.MIR != '' , 'InsuranceCompany'  , null)\r\n                  )\r\n        ,'')\r\n  WHERE (policy.CustomerID = P_CustomerID) OR (P_CustomerID IS NULL); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "mir_update_doctor",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  CALL `dmeworks`.`mir_update_doctor`(P_DoctorID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "mir_update_facility",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  UPDATE tbl_facility\r\n  SET `MIR` =\r\n      CONCAT_WS(',',\r\n          IF(IFNULL(Name      , '') = '', 'Name'      , null),\r\n          IF(IFNULL(Address1  , '') = '', 'Address1'  , null),\r\n          IF(IFNULL(City      , '') = '', 'City'      , null),\r\n          IF(IFNULL(State     , '') = '', 'State'     , null),\r\n          IF(IFNULL(Zip       , '') = '', 'Zip'       , null),\r\n          IF(IFNULL(POSTypeID , '') = '', 'POSTypeID' , null),\r\n          IF(NPI REGEXP '[[:digit:]]{10}[[:blank:]]*', null, 'NPI')\r\n               )\r\n  WHERE (ID = P_FacilityID) OR (P_FacilityID IS NULL); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "mir_update_insurancecompany",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  CALL `dmeworks`.`mir_update_insurancecompany`(P_InsuranceCompanyID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "mir_update_order",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_OrderID INT; --\r\n  DECLARE V_ActiveOnly BIT; --\r\n\r\n  -- P_OrderID\r\n  -- 'ActiveOnly' - all orders that have details with State != 'Closed'\r\n  -- number - just one\r\n  -- all details regardless of state\r\n\r\n  IF (P_OrderID = 'ActiveOnly') THEN\r\n    SET V_OrderID = null; --\r\n    SET V_ActiveOnly = 1; --\r\n  ELSEIF (P_OrderID REGEXP '^(\\-|\\+){0,1}([0-9]+)$') THEN\r\n    SET V_OrderID = CAST(P_OrderID as signed); --\r\n    SET V_ActiveOnly = 0; --\r\n  ELSE\r\n    SET V_OrderID = null; --\r\n    SET V_ActiveOnly = 0; --\r\n  END IF; --\r\n\r\n  IF (V_OrderID IS NOT NULL) THEN\r\n    UPDATE tbl_order\r\n    SET `MIR` =\r\n      CONCAT_WS(','\r\n      ,IF(CustomerID   IS NULL, 'CustomerID'  , null)\r\n      ,IF(DeliveryDate IS NULL, 'DeliveryDate', null)\r\n      ,IF(BillDate     IS NULL, 'BillDate'    , null)\r\n      )\r\n    WHERE (ID = V_OrderID); --\r\n  ELSEIF (V_ActiveOnly != 1) THEN\r\n    UPDATE tbl_order\r\n    SET `MIR` =\r\n      CONCAT_WS(','\r\n      ,IF(CustomerID   IS NULL, 'CustomerID'  , null)\r\n      ,IF(DeliveryDate IS NULL, 'DeliveryDate', null)\r\n      ,IF(BillDate     IS NULL, 'BillDate'    , null)\r\n      ); --\r\n  ELSE\r\n    UPDATE tbl_order as o\r\n    INNER JOIN\r\n           (SELECT DISTINCT CustomerID, OrderID\r\n            FROM view_orderdetails\r\n            WHERE (IsActive = 1)\r\n           ) as d on d.CustomerID = o.CustomerID and d.OrderID = o.ID\r\n    SET o.`MIR` =\r\n      CONCAT_WS(','\r\n      ,IF(o.CustomerID   IS NULL, 'CustomerID'  , null)\r\n      ,IF(o.DeliveryDate IS NULL, 'DeliveryDate', null)\r\n      ,IF(o.BillDate     IS NULL, 'BillDate'    , null)\r\n      ); --\r\n  END IF; --\r\n\r\n  UPDATE tbl_order as o\r\n  INNER JOIN\r\n         (SELECT CustomerID, OrderID\r\n          , SUM(0 < FIND_IN_SET('Customer.Inactive', `MIR.ORDER`)) AS `Customer.Inactive`\r\n          , SUM(0 < FIND_IN_SET('Customer.MIR'     , `MIR.ORDER`)) AS `Customer.MIR`\r\n          , SUM(0 < FIND_IN_SET('Policy1.Required' , `MIR.ORDER`)) AS `Policy1.Required`\r\n          , SUM(0 < FIND_IN_SET('Policy1.MIR'      , `MIR.ORDER`)) AS `Policy1.MIR`\r\n          , SUM(0 < FIND_IN_SET('Policy2.Required' , `MIR.ORDER`)) AS `Policy2.Required`\r\n          , SUM(0 < FIND_IN_SET('Policy2.MIR'      , `MIR.ORDER`)) AS `Policy2.MIR`\r\n          , SUM(0 < FIND_IN_SET('Facility.MIR'     , `MIR.ORDER`)) AS `Facility.MIR`\r\n          , SUM(0 < FIND_IN_SET('PosType.Required' , `MIR.ORDER`)) AS `PosType.Required`\r\n          , SUM(0 < FIND_IN_SET('ICD9.Required'    , `MIR.ORDER`)) AS `ICD9.Required`\r\n          , SUM(0 < FIND_IN_SET('ICD9.1.Unknown'   , `MIR.ORDER`)) AS `ICD9.1.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD9.1.Inactive'  , `MIR.ORDER`)) AS `ICD9.1.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD9.2.Unknown'   , `MIR.ORDER`)) AS `ICD9.2.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD9.2.Inactive'  , `MIR.ORDER`)) AS `ICD9.2.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD9.3.Unknown'   , `MIR.ORDER`)) AS `ICD9.3.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD9.3.Inactive'  , `MIR.ORDER`)) AS `ICD9.3.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD9.4.Unknown'   , `MIR.ORDER`)) AS `ICD9.4.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD9.4.Inactive'  , `MIR.ORDER`)) AS `ICD9.4.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.Required'   , `MIR.ORDER`)) AS `ICD10.Required`\r\n          , SUM(0 < FIND_IN_SET('ICD10.01.Unknown' , `MIR.ORDER`)) AS `ICD10.01.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.01.Inactive', `MIR.ORDER`)) AS `ICD10.01.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.02.Unknown' , `MIR.ORDER`)) AS `ICD10.02.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.02.Inactive', `MIR.ORDER`)) AS `ICD10.02.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.03.Unknown' , `MIR.ORDER`)) AS `ICD10.03.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.03.Inactive', `MIR.ORDER`)) AS `ICD10.03.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.04.Unknown' , `MIR.ORDER`)) AS `ICD10.04.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.04.Inactive', `MIR.ORDER`)) AS `ICD10.04.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.05.Unknown' , `MIR.ORDER`)) AS `ICD10.05.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.05.Inactive', `MIR.ORDER`)) AS `ICD10.05.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.06.Unknown' , `MIR.ORDER`)) AS `ICD10.06.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.06.Inactive', `MIR.ORDER`)) AS `ICD10.06.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.07.Unknown' , `MIR.ORDER`)) AS `ICD10.07.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.07.Inactive', `MIR.ORDER`)) AS `ICD10.07.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.08.Unknown' , `MIR.ORDER`)) AS `ICD10.08.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.08.Inactive', `MIR.ORDER`)) AS `ICD10.08.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.09.Unknown' , `MIR.ORDER`)) AS `ICD10.09.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.09.Inactive', `MIR.ORDER`)) AS `ICD10.09.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.10.Unknown' , `MIR.ORDER`)) AS `ICD10.10.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.10.Inactive', `MIR.ORDER`)) AS `ICD10.10.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.11.Unknown' , `MIR.ORDER`)) AS `ICD10.11.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.11.Inactive', `MIR.ORDER`)) AS `ICD10.11.Inactive`\r\n          , SUM(0 < FIND_IN_SET('ICD10.12.Unknown' , `MIR.ORDER`)) AS `ICD10.12.Unknown`\r\n          , SUM(0 < FIND_IN_SET('ICD10.12.Inactive', `MIR.ORDER`)) AS `ICD10.12.Inactive`\r\n          FROM view_orderdetails\r\n          WHERE IF(V_OrderID IS NOT NULL, OrderID = V_OrderID, V_ActiveOnly != 1 or IsActive = 1)\r\n            AND (0 < FIND_IN_SET('Customer.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('Customer.MIR'     , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('Policy1.Required' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('Policy1.MIR'      , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('Policy2.Required' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('Policy2.MIR'      , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('Facility.MIR'     , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('PosType.Required' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD9.Required'    , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD9.1.Unknown'   , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD9.1.Inactive'  , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD9.2.Unknown'   , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD9.2.Inactive'  , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD9.3.Unknown'   , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD9.3.Inactive'  , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD9.4.Unknown'   , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD9.4.Inactive'  , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.Required'   , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.01.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.01.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.02.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.02.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.03.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.03.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.04.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.04.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.05.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.05.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.06.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.06.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.07.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.07.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.08.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.08.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.09.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.09.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.10.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.10.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.11.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.11.Inactive', `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.12.Unknown' , `MIR.ORDER`)\r\n              OR 0 < FIND_IN_SET('ICD10.12.Inactive', `MIR.ORDER`))\r\n          GROUP BY CustomerID, OrderID\r\n         ) as d on d.CustomerID = o.CustomerID and d.OrderID = o.ID\r\n  SET o.`MIR` = CONCAT_WS(','\r\n    ,o.MIR\r\n    ,IF(0 < d.`Customer.Inactive`, 'Customer.Inactive', NULL)\r\n    ,IF(0 < d.`Customer.MIR`     , 'Customer.MIR'     , NULL)\r\n    ,IF(0 < d.`Policy1.Required` , 'Policy1.Required' , NULL)\r\n    ,IF(0 < d.`Policy1.MIR`      , 'Policy1.MIR'      , NULL)\r\n    ,IF(0 < d.`Policy2.Required` , 'Policy2.Required' , NULL)\r\n    ,IF(0 < d.`Policy2.MIR`      , 'Policy2.MIR'      , NULL)\r\n    ,IF(0 < d.`Facility.MIR`     , 'Facility.MIR'     , NULL)\r\n    ,IF(0 < d.`PosType.Required` , 'PosType.Required' , NULL)\r\n    ,IF(0 < d.`ICD9.Required`    , 'ICD9.Required'    , NULL)\r\n    ,IF(0 < d.`ICD9.1.Unknown`   , 'ICD9.1.Unknown'   , NULL)\r\n    ,IF(0 < d.`ICD9.1.Inactive`  , 'ICD9.1.Inactive'  , NULL)\r\n    ,IF(0 < d.`ICD9.2.Unknown`   , 'ICD9.2.Unknown'   , NULL)\r\n    ,IF(0 < d.`ICD9.2.Inactive`  , 'ICD9.2.Inactive'  , NULL)\r\n    ,IF(0 < d.`ICD9.3.Unknown`   , 'ICD9.3.Unknown'   , NULL)\r\n    ,IF(0 < d.`ICD9.3.Inactive`  , 'ICD9.3.Inactive'  , NULL)\r\n    ,IF(0 < d.`ICD9.4.Unknown`   , 'ICD9.4.Unknown'   , NULL)\r\n    ,IF(0 < d.`ICD9.4.Inactive`  , 'ICD9.4.Inactive'  , NULL)\r\n    ,IF(0 < d.`ICD10.Required`   , 'ICD10.Required'   , NULL)\r\n    ,IF(0 < d.`ICD10.01.Unknown` , 'ICD10.01.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.01.Inactive`, 'ICD10.01.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.02.Unknown` , 'ICD10.02.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.02.Inactive`, 'ICD10.02.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.03.Unknown` , 'ICD10.03.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.03.Inactive`, 'ICD10.03.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.04.Unknown` , 'ICD10.04.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.04.Inactive`, 'ICD10.04.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.05.Unknown` , 'ICD10.05.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.05.Inactive`, 'ICD10.05.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.06.Unknown` , 'ICD10.06.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.06.Inactive`, 'ICD10.06.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.07.Unknown` , 'ICD10.07.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.07.Inactive`, 'ICD10.07.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.08.Unknown` , 'ICD10.08.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.08.Inactive`, 'ICD10.08.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.09.Unknown` , 'ICD10.09.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.09.Inactive`, 'ICD10.09.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.10.Unknown` , 'ICD10.10.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.10.Inactive`, 'ICD10.10.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.11.Unknown` , 'ICD10.11.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.11.Inactive`, 'ICD10.11.Inactive', NULL)\r\n    ,IF(0 < d.`ICD10.12.Unknown` , 'ICD10.12.Unknown' , NULL)\r\n    ,IF(0 < d.`ICD10.12.Inactive`, 'ICD10.12.Inactive', NULL)\r\n    ); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "mir_update_orderdetails",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_OrderID INT; --\r\n  DECLARE V_ActiveOnly BIT; --\r\n\r\n  --  now we make field tbl_order.SaleType informative only\r\n  --  now we make field view_orderdetails.IsRetail informative only -\r\n  --  user should use BillIns1 .. BillIns4 for the same purpose\r\n\r\n  -- P_OrderID\r\n  -- 'ActiveOnly' - all details with State != 'Closed'\r\n  -- number - just one\r\n  -- all details regardless of state\r\n\r\n  IF (P_OrderID = 'ActiveOnly') THEN\r\n    SET V_OrderID = null; --\r\n    SET V_ActiveOnly = 1; --\r\n  ELSEIF (P_OrderID REGEXP '^(\\-|\\+){0,1}([0-9]+)$') THEN\r\n    SET V_OrderID = CAST(P_OrderID as signed); --\r\n    SET V_ActiveOnly = 0; --\r\n  ELSE\r\n    SET V_OrderID = null; --\r\n    SET V_ActiveOnly = 0; --\r\n  END IF; --\r\n\r\n  UPDATE view_orderdetails_core as details\r\n         INNER JOIN tbl_order as _order ON details.OrderID    = _order.ID\r\n                                       AND details.CustomerID = _order.CustomerID\r\n         LEFT JOIN tbl_pricecode_item as pricing ON pricing.InventoryItemID = details.InventoryItemID\r\n                                                AND pricing.PriceCodeID     = details.PriceCodeID\r\n         LEFT JOIN tbl_inventoryitem as item ON details.InventoryItemID = item.ID\r\n  SET details.`MIR` = CONCAT_WS(','\r\n    , IF(item.ID IS NULL, 'InventoryItemID', null)\r\n    , IF(pricing.ID IS NULL, 'PriceCodeID', null)\r\n    , CASE WHEN details.SaleRentType = 'Medicare Oxygen Rental' AND details.IsOxygen != 1\r\n           THEN 'SaleRentType'\r\n           WHEN details.ActualSaleRentType = '' THEN 'SaleRentType' ELSE null END\r\n    , CASE WHEN details.ActualBillItemOn   = '' THEN 'BillItemOn'   ELSE null END\r\n    , CASE WHEN details.ActualBilledWhen   = '' THEN 'BilledWhen'   ELSE null END\r\n    , CASE WHEN details.ActualOrderedWhen  = '' THEN 'OrderedWhen'  ELSE null END\r\n    , IF((details.IsActive = 1) AND (details.EndDate < _order.BillDate), 'EndDate.Invalid', null)\r\n    , IF((details.State = 'Pickup') AND (details.EndDate IS NULL), 'EndDate.Unconfirmed', null)\r\n    , IF((details.SaleRentType IN ('Capped Rental', 'Parental Capped Rental')) AND (IFNULL(details.Modifier1, '') = ''), 'Modifier1', null)\r\n    , IF((details.SaleRentType IN ('Capped Rental', 'Parental Capped Rental')) AND (_order.DeliveryDate < '2006-01-01') AND (details.BillingMonth BETWEEN 12 AND 13) AND (details.Modifier3 NOT IN ('BP', 'BR', 'BU')), 'Modifier3', null)\r\n    , IF((details.SaleRentType IN ('Capped Rental', 'Parental Capped Rental')) AND (_order.DeliveryDate < '2006-01-01') AND (details.BillingMonth BETWEEN 14 AND 15) AND (details.Modifier3 NOT IN ('BR', 'BU')), 'Modifier3', null)\r\n    , null)\r\n  , details.`MIR.ORDER` = ''\r\n  WHERE IF(V_OrderID IS NOT NULL, _order.ID = V_OrderID, V_ActiveOnly != 1 or details.IsActive = 1); --\r\n\r\n  -- common part, no ICD9 or ICD10\r\n  UPDATE view_orderdetails_core as details\r\n         INNER JOIN tbl_order as _order ON details.OrderID    = _order.ID\r\n                                       AND details.CustomerID = _order.CustomerID\r\n         INNER JOIN tbl_customer as customer ON customer.ID = _order.CustomerID\r\n         INNER JOIN tbl_pricecode_item as pricing ON pricing.InventoryItemID = details.InventoryItemID\r\n                                                 AND pricing.PriceCodeID     = details.PriceCodeID\r\n         LEFT JOIN tbl_customer_insurance as policy1 ON _order.CustomerInsurance1_ID = policy1.ID\r\n                                                    AND _order.CustomerID            = policy1.CustomerID\r\n         LEFT JOIN tbl_customer_insurance as policy2 ON _order.CustomerInsurance2_ID = policy2.ID\r\n                                                    AND _order.CustomerID            = policy2.CustomerID\r\n         LEFT JOIN tbl_cmnform as cmnform ON cmnform.ID         = details.CMNFormID\r\n                                         AND cmnform.CustomerID = details.CustomerID\r\n         LEFT JOIN tbl_facility as facility ON _order.FacilityID = facility.ID\r\n         LEFT JOIN tbl_postype as postype ON _order.POSTypeID = postype.ID\r\n  SET details.`MIR` = CONCAT_WS(','\r\n    , details.`MIR`\r\n    , IF(IFNULL(details.OrderedQuantity  ,  0) =  0, 'OrderedQuantity'  , null)\r\n    , IF(IFNULL(details.OrderedUnits     , '') = '', 'OrderedUnits'     , null)\r\n    , IF(IFNULL(details.OrderedConverter ,  0) =  0, 'OrderedConverter' , null)\r\n    , IF(IFNULL(details.BilledQuantity   ,  0) =  0, 'BilledQuantity'   , null)\r\n    , IF(IFNULL(details.BilledUnits      , '') = '', 'BilledUnits'      , null)\r\n    , IF(IFNULL(details.BilledConverter  ,  0) =  0, 'BilledConverter'  , null)\r\n    , IF(IFNULL(details.DeliveryQuantity ,  0) =  0, 'DeliveryQuantity' , null)\r\n    , IF(IFNULL(details.DeliveryUnits    , '') = '', 'DeliveryUnits'    , null)\r\n    , IF(IFNULL(details.DeliveryConverter,  0) =  0, 'DeliveryConverter', null)\r\n    , IF(IFNULL(details.BillingCode      , '') = '', 'BillingCode'      , null)\r\n    , CASE WHEN '2015-10-01' <= details.DOSFrom THEN null\r\n           WHEN IFNULL(details.DXPointer  , '') REGEXP '[1-4](,[1-4])*' THEN null\r\n           ELSE 'DXPointer9' END\r\n    , CASE WHEN details.DOSFrom < '2015-10-01' THEN null\r\n           WHEN IFNULL(details.DXPointer10, '') REGEXP '([1-9]|1[0-2])(,([1-9]|1[0-2]))*' THEN null\r\n           ELSE 'DXPointer10' END\r\n    , IF((IFNULL(pricing.DefaultCMNType, '') != '') AND (cmnform.ID IS NULL), 'CMNForm.Required', null)\r\n    , IF((IFNULL(pricing.DefaultCMNType, '') != '') AND (cmnform.MIR != '' ), 'CMNForm.MIR'     , null)\r\n    , IF((cmnform.CmnType = 'DMERC DRORDER') AND (cmnform.MIR != ''), 'CMNForm.MIR', null)\r\n    , CASE WHEN cmnform.InitialDate           is null THEN null\r\n           WHEN cmnform.EstimatedLengthOfNeed is null THEN null\r\n           WHEN cmnform.EstimatedLengthOfNeed < 0     THEN null\r\n           WHEN 99 <= cmnform.EstimatedLengthOfNeed   THEN null -- 99 = LIFETIME\r\n           WHEN (cmnform.CMNType     IN ('DMERC 484.2', 'DME 484.03'))\r\n            AND (DATE_ADD(cmnform.InitialDate, INTERVAL 12 MONTH) <= details.DOSFrom)\r\n            AND (cmnform.RecertificationDate is null)\r\n           THEN 'CMNForm.RecertificationDate'\r\n           WHEN (cmnform.CMNType     IN ('DMERC 484.2', 'DME 484.03'))\r\n            AND (DATE_ADD(cmnform.InitialDate, INTERVAL 12 MONTH) <= details.DOSFrom)\r\n            AND (DATE_ADD(cmnform.RecertificationDate, INTERVAL 12 MONTH) <= details.DOSFrom)\r\n           THEN 'CMNForm.FormExpired'\r\n           WHEN (cmnform.CMNType NOT IN ('DMERC 484.2', 'DME 484.03'))\r\n            AND (DATE_ADD(cmnform.InitialDate, INTERVAL cmnform.EstimatedLengthOfNeed MONTH) <= details.DOSFrom)\r\n           THEN 'CMNForm.FormExpired'\r\n           ELSE null END\r\n    , CASE WHEN details.AuthorizationNumber is null THEN null\r\n           WHEN details.AuthorizationNumber = ''    THEN null\r\n           WHEN details.AuthorizationExpirationDate < details.DOSFrom THEN 'AuthorizationNumber.Expired'\r\n           WHEN details.AuthorizationExpirationDate <= details.DOSTo  THEN 'AuthorizationNumber.Expires'\r\n           ELSE null END\r\n    , null) -- MIR\r\n  , details.`MIR.ORDER` = CONCAT_WS(','\r\n    , IF((details.BillIns1 = 1) AND (policy1.ID IS NULL), 'Policy1.Required', null)\r\n    , IF((details.BillIns1 = 1) AND (policy1.MIR != '' ), 'Policy1.MIR'     , null)\r\n    , IF((details.BillIns1 = 2) AND (policy2.MIR != '' ), 'Policy2.MIR'     , null)\r\n    , IF(customer.InactiveDate < Now(), 'Customer.Inactive', null)\r\n    , IF(customer.MIR != '', 'Customer.MIR', null)\r\n    , IF(facility.MIR != '', 'Facility.MIR', null)\r\n    , IF(postype.ID IS NULL, 'PosType.Required', null)\r\n    , null)\r\n  WHERE IF(V_OrderID IS NOT NULL, _order.ID = V_OrderID, V_ActiveOnly != 1 or details.IsActive = 1)\r\n    AND (customer.CommercialAccount = 0)\r\n    AND (details.IsZeroAmount = 0)\r\n    AND ((details.BillIns1 = 1) OR (details.BillIns2 = 1) OR (details.BillIns3 = 1) OR (details.BillIns4 = 1)); --\r\n\r\n  -- ICD9 is only for orders before 2015-10-01\r\n  UPDATE view_orderdetails_core as details\r\n         INNER JOIN tbl_order as _order ON details.OrderID    = _order.ID\r\n                                       AND details.CustomerID = _order.CustomerID\r\n         INNER JOIN tbl_customer as customer ON customer.ID = _order.CustomerID\r\n         LEFT JOIN tbl_icd9 as icd9_1 ON _order.ICD9_1 = icd9_1.Code\r\n         LEFT JOIN tbl_icd9 as icd9_2 ON _order.ICD9_2 = icd9_2.Code\r\n         LEFT JOIN tbl_icd9 as icd9_3 ON _order.ICD9_3 = icd9_3.Code\r\n         LEFT JOIN tbl_icd9 as icd9_4 ON _order.ICD9_4 = icd9_4.Code\r\n  SET details.`MIR.ORDER` = CONCAT_WS(','\r\n    , details.`MIR.ORDER`\r\n    , CASE WHEN _order.ICD9_1 != ''                THEN null\r\n           WHEN _order.ICD9_2 != ''                THEN null\r\n           WHEN _order.ICD9_3 != ''                THEN null\r\n           WHEN _order.ICD9_4 != ''                THEN null\r\n           ELSE 'ICD9.Required' END\r\n    , CASE WHEN IFNULL(_order.ICD9_1, '') = ''          THEN null\r\n           WHEN icd9_1.Code IS NULL                     THEN 'ICD9.1.Unknown'\r\n           WHEN icd9_1.InactiveDate <= _order.OrderDate THEN 'ICD9.1.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD9_2, '') = ''          THEN null\r\n           WHEN icd9_2.Code IS NULL                     THEN 'ICD9.2.Unknown'\r\n           WHEN icd9_2.InactiveDate <= _order.OrderDate THEN 'ICD9.2.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD9_3, '') = ''          THEN null\r\n           WHEN icd9_3.Code IS NULL                     THEN 'ICD9.3.Unknown'\r\n           WHEN icd9_3.InactiveDate <= _order.OrderDate THEN 'ICD9.3.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD9_4, '') = ''          THEN null\r\n           WHEN icd9_4.Code IS NULL                     THEN 'ICD9.4.Unknown'\r\n           WHEN icd9_4.InactiveDate <= _order.OrderDate THEN 'ICD9.4.Inactive'\r\n           ELSE null END\r\n    , null)\r\n  WHERE IF(V_OrderID IS NOT NULL, _order.ID = V_OrderID, V_ActiveOnly != 1 or details.IsActive = 1)\r\n    AND (customer.CommercialAccount = 0)\r\n    AND (details.IsZeroAmount = 0)\r\n    AND (details.DOSFrom < '2015-10-01')\r\n    AND (details.DXPointer != '')\r\n    AND ((details.BillIns1 = 1) OR (details.BillIns2 = 1) OR (details.BillIns3 = 1) OR (details.BillIns4 = 1)); --\r\n\r\n  -- ICD10 is only for orders after 2015-10-01\r\n  UPDATE view_orderdetails_core as details\r\n         INNER JOIN tbl_order as _order ON details.OrderID    = _order.ID\r\n                                       AND details.CustomerID = _order.CustomerID\r\n         INNER JOIN tbl_customer as customer ON customer.ID = _order.CustomerID\r\n         LEFT JOIN tbl_icd10 as icd10_01 ON _order.ICD10_01 = icd10_01.Code\r\n         LEFT JOIN tbl_icd10 as icd10_02 ON _order.ICD10_02 = icd10_02.Code\r\n         LEFT JOIN tbl_icd10 as icd10_03 ON _order.ICD10_03 = icd10_03.Code\r\n         LEFT JOIN tbl_icd10 as icd10_04 ON _order.ICD10_04 = icd10_04.Code\r\n         LEFT JOIN tbl_icd10 as icd10_05 ON _order.ICD10_05 = icd10_05.Code\r\n         LEFT JOIN tbl_icd10 as icd10_06 ON _order.ICD10_06 = icd10_06.Code\r\n         LEFT JOIN tbl_icd10 as icd10_07 ON _order.ICD10_07 = icd10_07.Code\r\n         LEFT JOIN tbl_icd10 as icd10_08 ON _order.ICD10_08 = icd10_08.Code\r\n         LEFT JOIN tbl_icd10 as icd10_09 ON _order.ICD10_09 = icd10_09.Code\r\n         LEFT JOIN tbl_icd10 as icd10_10 ON _order.ICD10_10 = icd10_10.Code\r\n         LEFT JOIN tbl_icd10 as icd10_11 ON _order.ICD10_11 = icd10_11.Code\r\n         LEFT JOIN tbl_icd10 as icd10_12 ON _order.ICD10_12 = icd10_12.Code\r\n  SET details.`MIR.ORDER` = CONCAT_WS(','\r\n    , details.`MIR.ORDER`\r\n    , CASE WHEN _order.ICD10_01 != '' THEN null\r\n           WHEN _order.ICD10_02 != '' THEN null\r\n           WHEN _order.ICD10_03 != '' THEN null\r\n           WHEN _order.ICD10_04 != '' THEN null\r\n           WHEN _order.ICD10_05 != '' THEN null\r\n           WHEN _order.ICD10_06 != '' THEN null\r\n           WHEN _order.ICD10_07 != '' THEN null\r\n           WHEN _order.ICD10_08 != '' THEN null\r\n           WHEN _order.ICD10_09 != '' THEN null\r\n           WHEN _order.ICD10_10 != '' THEN null\r\n           WHEN _order.ICD10_11 != '' THEN null\r\n           WHEN _order.ICD10_12 != '' THEN null\r\n           ELSE 'ICD10.Required' END\r\n    , CASE WHEN IFNULL(_order.ICD10_01, '') = ''          THEN null\r\n           WHEN icd10_01.Code IS NULL                     THEN 'ICD10.01.Unknown'\r\n           WHEN icd10_01.InactiveDate <= _order.OrderDate THEN 'ICD10.01.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_02, '') = ''          THEN null\r\n           WHEN icd10_02.Code IS NULL                     THEN 'ICD10.02.Unknown'\r\n           WHEN icd10_02.InactiveDate <= _order.OrderDate THEN 'ICD10.02.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_03, '') = ''          THEN null\r\n           WHEN icd10_03.Code IS NULL                     THEN 'ICD10.03.Unknown'\r\n           WHEN icd10_03.InactiveDate <= _order.OrderDate THEN 'ICD10.03.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_04, '') = ''          THEN null\r\n           WHEN icd10_04.Code IS NULL                     THEN 'ICD10.04.Unknown'\r\n           WHEN icd10_04.InactiveDate <= _order.OrderDate THEN 'ICD10.04.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_05, '') = ''          THEN null\r\n           WHEN icd10_05.Code IS NULL                     THEN 'ICD10.05.Unknown'\r\n           WHEN icd10_05.InactiveDate <= _order.OrderDate THEN 'ICD10.05.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_06, '') = ''          THEN null\r\n           WHEN icd10_06.Code IS NULL                     THEN 'ICD10.06.Unknown'\r\n           WHEN icd10_06.InactiveDate <= _order.OrderDate THEN 'ICD10.06.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_07, '') = ''          THEN null\r\n           WHEN icd10_07.Code IS NULL                     THEN 'ICD10.07.Unknown'\r\n           WHEN icd10_07.InactiveDate <= _order.OrderDate THEN 'ICD10.07.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_08, '') = ''          THEN null\r\n           WHEN icd10_08.Code IS NULL                     THEN 'ICD10.08.Unknown'\r\n           WHEN icd10_08.InactiveDate <= _order.OrderDate THEN 'ICD10.08.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_09, '') = ''          THEN null\r\n           WHEN icd10_09.Code IS NULL                     THEN 'ICD10.09.Unknown'\r\n           WHEN icd10_09.InactiveDate <= _order.OrderDate THEN 'ICD10.09.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_10, '') = ''          THEN null\r\n           WHEN icd10_10.Code IS NULL                     THEN 'ICD10.10.Unknown'\r\n           WHEN icd10_10.InactiveDate <= _order.OrderDate THEN 'ICD10.10.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_11, '') = ''          THEN null\r\n           WHEN icd10_11.Code IS NULL                     THEN 'ICD10.11.Unknown'\r\n           WHEN icd10_11.InactiveDate <= _order.OrderDate THEN 'ICD10.11.Inactive'\r\n           ELSE null END\r\n    , CASE WHEN IFNULL(_order.ICD10_12, '') = ''          THEN null\r\n           WHEN icd10_12.Code IS NULL                     THEN 'ICD10.12.Unknown'\r\n           WHEN icd10_12.InactiveDate <= _order.OrderDate THEN 'ICD10.12.Inactive'\r\n           ELSE null END\r\n    , null)\r\n  WHERE IF(V_OrderID IS NOT NULL, _order.ID = V_OrderID, V_ActiveOnly != 1 or details.IsActive = 1)\r\n    AND (customer.CommercialAccount = 0)\r\n    AND (details.IsZeroAmount = 0)\r\n    AND ('2015-10-01' <= details.DOSFrom)\r\n    AND (details.DXPointer10 != '')\r\n    AND ((details.BillIns1 = 1) OR (details.BillIns2 = 1) OR (details.BillIns3 = 1) OR (details.BillIns4 = 1)); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "move_serial_on_hand",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n\r\n  -- cursor variables\r\n  DECLARE cur_SerialID    INT(11); --\r\n  DECLARE cur_WarehouseID INT(11); --\r\n  DECLARE cur_TranType    VARCHAR(50); --\r\n\r\n  DECLARE cur CURSOR FOR\r\n  SELECT\r\n    st2.SerialID\r\n  , st2.WarehouseId\r\n  , stt2.Name as TranType\r\n  FROM (SELECT *\r\n        FROM tbl_serial_transaction\r\n        WHERE ID IN (SELECT Max(ID) FROM tbl_serial_transaction GROUP BY SerialID)) AS st\r\n  INNER JOIN tbl_serial_transaction_type as stt ON stt.ID   = st.TypeID\r\n                                               AND stt.Name = 'Returned'\r\n  INNER JOIN (SELECT *\r\n              FROM tbl_serial_transaction\r\n              WHERE ID IN (SELECT Max(ID) FROM tbl_serial_transaction WHERE WarehouseId IS NOT NULL GROUP BY SerialID)) AS st2\r\n          ON st2.SerialID = st.SerialID\r\n  INNER JOIN tbl_serial_transaction_type AS stt2 ON stt2.Name = 'In from Maintenance'\r\n  WHERE (P_SerialID IS NULL OR st2.SerialID = P_SerialID); --\r\n\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO\r\n      cur_SerialID\r\n    , cur_WarehouseID\r\n    , cur_TranType; --\r\n\r\n    IF (done = 0) THEN\r\n      CALL serial_add_transaction(\r\n        cur_TranType       -- P_TranType         VARCHAR(50)\r\n      , NOW()              -- P_TranTime         DATETIME\r\n      , cur_SerialID       -- P_SerialID         INT,\r\n      , cur_WarehouseID    -- P_WarehouseID      INT,\r\n      , null               -- P_VendorID         INT,\r\n      , null               -- P_CustomerID       INT,\r\n      , null               -- P_OrderID          INT,\r\n      , null               -- P_OrderDetailsID   INT,\r\n      , null               -- P_LotNumber        VARCHAR(50),\r\n      , 1                  -- P_LastUpdateUserID INT\r\n      ); --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "OrderedQty2BilledQty",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_Multiplier INT; --\r\n\r\n  IF P_OrderedConverter < 0.000000001 THEN\r\n    RETURN 0; /* Parameter OrderedConverter must be greater tha zero */\r\n  END IF; --\r\n\r\n  IF P_DeliveryConverter < 0.000000001 THEN\r\n    RETURN 0; /* Paramater DeliveryConverter must be greater tha zero */\r\n  END IF; --\r\n\r\n  IF P_BilledConverter < 0.000000001 THEN\r\n    RETURN 0; /* Parameter BilledConverter must be greater tha zero */\r\n  END IF; --\r\n\r\n  SET V_Multiplier = GetMultiplier(P_FromDate, P_ToDate, P_OrderedWhen, P_BilledWhen); --\r\n\r\n  RETURN CEILING(P_OrderedQty * V_Multiplier * P_OrderedConverter / P_DeliveryConverter) * P_DeliveryConverter / P_BilledConverter; --\r\nEND",
    "DATA_TYPE": "double",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "OrderedQty2DeliveryQty",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_Multiplier INT; --\r\n\r\n  IF P_OrderedConverter < 0.000000001 THEN\r\n    RETURN 0; /* Parameter OrderedConverter must be greater than zero */\r\n  END IF; --\r\n\r\n  IF P_DeliveryConverter < 0.000000001 THEN\r\n    RETURN 0; /* Paramater DeliveryConverter must be greater than zero */\r\n  END IF; --\r\n\r\n  SET V_Multiplier = GetMultiplier(P_FromDate, P_ToDate, P_OrderedWhen, P_BilledWhen); --\r\n\r\n  RETURN CEILING(P_OrderedQty * V_Multiplier * P_OrderedConverter / P_DeliveryConverter); --\r\nEND",
    "DATA_TYPE": "double",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "OrderMustBeClosed",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  -- means that we should stop billing (that is we should set EndDate = InvoiceDate and State = 'Closed')\r\n  IF P_BillingMonth <= 0 THEN\r\n    SET P_BillingMonth = 1; --\r\n  END IF; --\r\n\r\n  IF P_SaleRentType IN ('One Time Sale', 'Re-occurring Sale', 'One Time Rental') THEN\r\n    RETURN (1 <= P_BillingMonth); --\r\n  ELSEIF P_SaleRentType = 'Medicare Oxygent Rental' THEN\r\n    IF P_DeliveryDate < '2006-01-01' THEN\r\n      RETURN ('2009-01-01' <= P_DosFrom) AND (36 <= P_BillingMonth); --\r\n    ELSE\r\n      -- we bill only 36 monthes but contract is 60 monthes\r\n      RETURN (60 <= P_BillingMonth); --\r\n    END IF; --\r\n  ELSEIF P_SaleRentType = 'Monthly Rental' THEN\r\n    RETURN 0; --\r\n  ELSEIF P_SaleRentType = 'Rent to Purchase' THEN\r\n    RETURN (10 <= P_BillingMonth); --\r\n  ELSEIF P_SaleRentType = 'Capped Rental' OR P_SaleRentType = 'Parental Capped Rental' THEN\r\n    IF P_DeliveryDate < '2006-01-01' THEN\r\n      RETURN (12 <= P_BillingMonth) and (P_BillingMonth <= 13) and (P_Modifier3 = 'BP'); --\r\n    ELSE\r\n      RETURN (13 <= P_BillingMonth); --\r\n    END IF; --\r\n  END IF; --\r\n\r\n  RETURN 0; --\r\nEND",
    "DATA_TYPE": "bit",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "OrderMustBeSkipped",
    "ROUTINE_TYPE": "FUNCTION",
    "ROUTINE_DEFINITION": "BEGIN\r\n  -- means that we should not process order\r\n  IF P_BillingMonth <= 0 THEN\r\n    SET P_BillingMonth = 1; --\r\n  END IF; --\r\n\r\n  IF P_SaleRentType IN ('One Time Sale', 'Re-occurring Sale', 'One Time Rental') THEN\r\n    RETURN (1 < P_BillingMonth); --\r\n  ELSEIF P_SaleRentType = 'Medicare Oxygen Rental' THEN\r\n    IF P_DeliveryDate < '2006-01-01' THEN\r\n      RETURN ('2009-01-01' <= P_DosFrom) AND (36 < P_BillingMonth); --\r\n    ELSE\r\n      -- we bill only 36 monthes but contract is 60 monthes\r\n      RETURN (60 < P_BillingMonth); --\r\n    END IF; --\r\n  ELSEIF P_SaleRentType = 'Monthly Rental' THEN\r\n    RETURN 0; --\r\n  ELSEIF P_SaleRentType = 'Rent to Purchase' THEN\r\n    RETURN (10 < P_BillingMonth); --\r\n  ELSEIF P_SaleRentType = 'Capped Rental' OR P_SaleRentType = 'Parental Capped Rental' THEN\r\n    IF P_DeliveryDate < '2006-01-01' THEN\r\n      IF (12 <= P_BillingMonth) AND (P_BillingMonth <= 15) THEN\r\n        RETURN (P_Modifier3 NOT IN ('BP', 'BR', 'BU')); --\r\n      ELSE\r\n        RETURN 0; --\r\n      END IF; --\r\n    ELSE\r\n      RETURN (13 < P_BillingMonth); --\r\n    END IF; --\r\n  END IF; --\r\n\r\n  RETURN 0; --\r\nEND",
    "DATA_TYPE": "bit",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "Order_ConvertDepositsIntoPayments",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  -- for given OrderId we select all order lines with deposits that have invoice lines without \"deposit\" payments\r\n  DECLARE V_InvoiceDetailsID INT; --\r\n  DECLARE V_Amount, V_Billable DECIMAL(18, 2); --\r\n  DECLARE V_Date DATE; --\r\n  DECLARE V_PaymentMethod VARCHAR(20); --\r\n  DECLARE V_Template, V_Extra TEXT; --\r\n  DECLARE V_Element VARCHAR(100); --\r\n  DECLARE V_Result VARCHAR(50); --\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE cur CURSOR FOR\r\n    SELECT il.ID, dd.Amount, d.Date, d.PaymentMethod, il.BillableAmount\r\n    FROM tbl_order AS o\r\n         INNER JOIN tbl_orderdetails AS od ON od.CustomerID = o.CustomerID\r\n                                          AND od.OrderID    = o.ID\r\n         INNER JOIN tbl_deposits AS d ON d.CustomerID = od.CustomerID\r\n                                     AND d.OrderID    = od.OrderID\r\n         INNER JOIN tbl_depositdetails AS dd ON dd.CustomerID     = od.CustomerID\r\n                                            AND dd.OrderID        = od.OrderID\r\n                                            AND dd.OrderDetailsID = od.ID\r\n         INNER JOIN tbl_invoice AS i ON i.CustomerID = o.CustomerID\r\n                                    AND i.OrderID    = o.ID\r\n         INNER JOIN tbl_invoicedetails AS il ON il.CustomerID     = i.CustomerID\r\n                                            AND il.InvoiceID      = i.ID\r\n                                            AND il.BillingMonth   = 1 -- only first billing month\r\n                                            AND il.OrderID        = od.OrderID\r\n                                            AND il.OrderDetailsID = od.ID\r\n         INNER JOIN tbl_invoice_transactiontype as tt ON tt.Name = 'Payment'\r\n         LEFT JOIN tbl_invoice_transaction as p ON p.CustomerID       = il.CustomerID\r\n                                               AND p.InvoiceID        = il.InvoiceID\r\n                                               AND p.InvoiceDetailsID = il.ID\r\n                                               AND p.InsuranceCompanyID IS NULL\r\n                                               AND p.CustomerInsuranceID IS NULL\r\n                                               AND p.TransactionTypeID = tt.ID\r\n                                               AND p.TransactionDate   = d.Date\r\n                                               AND p.Amount            = dd.Amount\r\n    WHERE (o.ID = P_OrderID)\r\n      AND (p.ID is null); --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  SET V_Template = '<values>\r\n  <v n=\"Billable\">0.00</v>\r\n  <v n=\"CheckDate\">00/00/0000</v>\r\n  <v n=\"Paid\">0.00</v>\r\n  <v n=\"PaymentMethod\">Check</v>\r\n</values>'; --\r\n\r\n  OPEN cur; --\r\n\r\n  DEPOSITS_LOOP: LOOP\r\n    FETCH cur INTO V_InvoiceDetailsID, V_Amount, V_Date, V_PaymentMethod, V_Billable; --\r\n\r\n    IF done THEN\r\n      LEAVE DEPOSITS_LOOP; --\r\n    END IF; --\r\n\r\n    SET V_Extra = V_Template; --\r\n    SET V_Element = CONCAT('<v n=\"Billable\">', IFNULL(CAST(V_Billable as CHAR), ''), '</v>'); --\r\n    SET V_Extra = UpdateXML(V_Extra, 'values/v[@n=\"Billable\"]' COLLATE latin1_general_ci, V_Element COLLATE latin1_general_ci); --\r\n    SET V_Element = CONCAT('<v n=\"CheckDate\">', IFNULL(DATE_FORMAT(V_Date, '%m/%d/%Y'), ''), '</v>'); --\r\n    SET V_Extra = UpdateXML(V_Extra, 'values/v[@n=\"CheckDate\"]' COLLATE latin1_general_ci, V_Element COLLATE latin1_general_ci); --\r\n    SET V_Element = CONCAT('<v n=\"Paid\">', IFNULL(CAST(V_Amount as CHAR), ''), '</v>'); --\r\n    SET V_Extra = UpdateXML(V_Extra, 'values/v[@n=\"Paid\"]' COLLATE latin1_general_ci, V_Element COLLATE latin1_general_ci); --\r\n    SET V_Element = CONCAT('<v n=\"PaymentMethod\">', IFNULL(CAST(V_PaymentMethod as CHAR), 'Check'), '</v>'); --\r\n    SET V_Extra = UpdateXML(V_Extra, 'values/v[@n=\"PaymentMethod\"]' COLLATE latin1_general_ci, V_Element COLLATE latin1_general_ci); --\r\n\r\n    CALL `InvoiceDetails_AddPayment`\r\n    ( V_InvoiceDetailsID\r\n    , NULL -- P_InsuranceCompanyID\r\n    , V_Date\r\n    , V_Extra\r\n    , 'Deposit' -- P_Comments\r\n    , '' -- P_Options\r\n    , IFNULL(@UserId, 1)\r\n    , V_Result); --\r\n  END LOOP DEPOSITS_LOOP; --\r\n\r\n  CLOSE cur; --\r\n\r\n  CALL `Order_InternalUpdateBalance`(P_OrderID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "MODIFIES SQL DATA"
  },
  {
    "ROUTINE_NAME": "Order_InternalProcess",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_DetailsCount, V_ICD10Count INT; --\r\n\r\n  SET P_InvoiceID = NULL; --\r\n\r\n  SELECT COUNT(*), SUM(CASE WHEN '2015-10-01' <= details.DosFrom THEN 1 ELSE 0 END)\r\n  INTO V_DetailsCount, V_ICD10Count\r\n  FROM tbl_order\r\n       INNER JOIN view_orderdetails_core as details ON tbl_order.ID = details.OrderID\r\n                                                   AND tbl_order.CustomerID = details.CustomerID\r\n       INNER JOIN tbl_pricecode_item as pricecode ON details.PriceCodeID = pricecode.PriceCodeID\r\n                                                 AND details.InventoryItemID = pricecode.InventoryItemID\r\n  WHERE (details.OrderID = P_OrderID)\r\n    AND (details.IsActive = 1)\r\n    -- we should generate invoices before end date and should not generate invoices after end date\r\n    AND ((details.EndDate IS NULL) OR (details.DosFrom <= details.EndDate))\r\n    AND (IF(details.BillingMonth <= 0, 1, details.BillingMonth) = P_BillingMonth)\r\n    AND ((IF((tbl_order.CustomerInsurance1_ID IS NOT NULL) AND (details.BillIns1 = 1), 1, 0) +\r\n          IF((tbl_order.CustomerInsurance2_ID IS NOT NULL) AND (details.BillIns2 = 1), 2, 0) +\r\n          IF((tbl_order.CustomerInsurance3_ID IS NOT NULL) AND (details.BillIns3 = 1), 4, 0) +\r\n          IF((tbl_order.CustomerInsurance4_ID IS NOT NULL) AND (details.BillIns4 = 1), 8, 0) +\r\n          IF((details.EndDate IS NOT NULL), 32, 0) +\r\n          IF((details.AcceptAssignment = 1), 16, 0)) = P_BillingFlags)\r\n    AND (IFNULL(details.MIR, '') = '')\r\n    AND (OrderMustBeSkipped  (tbl_order.DeliveryDate, details.DosFrom, details.ActualSaleRentType, details.BillingMonth, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4) = 0)\r\n    AND (InvoiceMustBeSkipped(tbl_order.DeliveryDate, details.DosFrom, details.ActualSaleRentType, details.BillingMonth, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4) = 0)\r\n    -- check for zero amount was moved out of function InvoiceMustBeSkipped\r\n    AND (details.IsZeroAmount = 0); --\r\n\r\n  IF 0 < V_DetailsCount THEN\r\n    -- create invoice\r\n    INSERT INTO tbl_invoice\r\n    ( CustomerID\r\n    , OrderID\r\n    , Approved\r\n    , AcceptAssignment\r\n    , ClaimNote\r\n    , InvoiceDate\r\n    , DoctorID\r\n    , POSTypeID\r\n    , FacilityID\r\n    , ReferralID\r\n    , SalesrepID\r\n    , CustomerInsurance1_ID\r\n    , CustomerInsurance2_ID\r\n    , CustomerInsurance3_ID\r\n    , CustomerInsurance4_ID\r\n    , ICD9_1\r\n    , ICD9_2\r\n    , ICD9_3\r\n    , ICD9_4\r\n    , ICD10_01\r\n    , ICD10_02\r\n    , ICD10_03\r\n    , ICD10_04\r\n    , ICD10_05\r\n    , ICD10_06\r\n    , ICD10_07\r\n    , ICD10_08\r\n    , ICD10_09\r\n    , ICD10_10\r\n    , ICD10_11\r\n    , ICD10_12\r\n    , TaxRateID\r\n    , TaxRatePercent\r\n    , Discount\r\n    , LastUpdateUserID)\r\n    SELECT\r\n      tbl_order.CustomerID\r\n    , tbl_order.ID\r\n    , tbl_order.Approved\r\n    , IF(P_BillingFlags & 16 = 16, 1, 0) as AcceptAssignment\r\n    , ClaimNote\r\n    , P_InvoiceDate as InvoiceDate\r\n    , tbl_order.DoctorID\r\n    , tbl_order.POSTypeID\r\n    , tbl_order.FacilityID\r\n    , tbl_order.ReferralID\r\n    , tbl_order.SalesrepID\r\n    , tbl_order.CustomerInsurance1_ID\r\n    , tbl_order.CustomerInsurance2_ID\r\n    , tbl_order.CustomerInsurance3_ID\r\n    , tbl_order.CustomerInsurance4_ID\r\n    , IF(V_ICD10Count = V_DetailsCount, '', tbl_order.ICD9_1) as ICD9_1\r\n    , IF(V_ICD10Count = V_DetailsCount, '', tbl_order.ICD9_2) as ICD9_2\r\n    , IF(V_ICD10Count = V_DetailsCount, '', tbl_order.ICD9_3) as ICD9_3\r\n    , IF(V_ICD10Count = V_DetailsCount, '', tbl_order.ICD9_4) as ICD9_4\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_01) as ICD10_01\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_02) as ICD10_02\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_03) as ICD10_03\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_04) as ICD10_04\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_05) as ICD10_05\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_06) as ICD10_06\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_07) as ICD10_07\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_08) as ICD10_08\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_09) as ICD10_09\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_10) as ICD10_10\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_11) as ICD10_11\r\n    , IF(V_ICD10Count = 0, '', tbl_order.ICD10_12) as ICD10_12\r\n    , view_taxrate.ID\r\n    , view_taxrate.TotalTax\r\n    , tbl_order.Discount\r\n    , IFNULL(@UserId, 1) as LastUpdateUserID\r\n    FROM tbl_order\r\n         LEFT JOIN tbl_customer ON tbl_order.CustomerID = tbl_customer.ID\r\n         LEFT JOIN tbl_company ON tbl_company.ID = 1\r\n         LEFT JOIN view_taxrate ON IFNULL(tbl_customer.TaxRateID, tbl_company.TaxRateID) = view_taxrate.ID\r\n    WHERE (tbl_order.ID = P_OrderID); --\r\n\r\n    SELECT LAST_INSERT_ID() INTO P_InvoiceID; --\r\n\r\n    -- add line items to invoice\r\n    INSERT INTO tbl_invoicedetails\r\n    ( CustomerID\r\n    , InvoiceID\r\n    , InventoryItemID\r\n    , PriceCodeID\r\n    , OrderID\r\n    , OrderDetailsID\r\n    , Balance\r\n    , BillableAmount\r\n    , AllowableAmount\r\n    , Taxes\r\n    , Quantity\r\n    , Hardship\r\n    , AcceptAssignment\r\n    , InvoiceDate\r\n    , DOSFrom\r\n    , DOSTo\r\n    , ShowSpanDates\r\n    , BillingCode\r\n    , Modifier1\r\n    , Modifier2\r\n    , Modifier3\r\n    , Modifier4\r\n    , DXPointer\r\n    , DXPointer10\r\n    , DrugNoteField\r\n    , DrugControlNumber\r\n    , BillingMonth\r\n    , SendCMN_RX_w_invoice\r\n    , SpecialCode\r\n    , ReviewCode\r\n    , MedicallyUnnecessary\r\n    , BillIns1\r\n    , BillIns2\r\n    , BillIns3\r\n    , BillIns4\r\n    , NopayIns1\r\n    , CMNFormID\r\n    , AuthorizationTypeID\r\n    , AuthorizationNumber\r\n    , HaoDescription)\r\n    SELECT\r\n      details.CustomerID\r\n    , P_InvoiceID\r\n    , details.InventoryItemID\r\n    , details.PriceCodeID\r\n    , details.OrderID\r\n    , details.ID\r\n    , (1 - IFNULL(tbl_order.Discount, 0) / 100) *\r\n      GetAmountMultiplier(details.DOSFrom, details.DOSTo, details.EndDate, details.ActualSaleRentType, details.ActualOrderedWhen, details.ActualBilledWhen) *\r\n      IF((details.Taxable = 1) AND (view_taxrate.ID IS NOT NULL)\r\n        ,GetAllowableAmount(details.ActualSaleRentType, details.BillingMonth, details.AllowablePrice, details.BilledQuantity, pricecode.Sale_AllowablePrice, details.FlatRate) * (1 + IFNULL(view_taxrate.TotalTax, 0) / 100)\r\n        ,GetBillableAmount (details.ActualSaleRentType, details.BillingMonth, details.BillablePrice , details.BilledQuantity, pricecode.Sale_BillablePrice, details.FlatRate))\r\n      as Balance\r\n    , (1 - IFNULL(tbl_order.Discount, 0) / 100) *\r\n      GetAmountMultiplier(details.DOSFrom, details.DOSTo, details.EndDate, details.ActualSaleRentType, details.ActualOrderedWhen, details.ActualBilledWhen) *\r\n      IF((details.Taxable = 1) AND (view_taxrate.ID IS NOT NULL)\r\n        ,GetAllowableAmount(details.ActualSaleRentType, details.BillingMonth, details.AllowablePrice, details.BilledQuantity, pricecode.Sale_AllowablePrice, details.FlatRate) * (1 + IFNULL(view_taxrate.TotalTax, 0) / 100)\r\n        ,GetBillableAmount (details.ActualSaleRentType, details.BillingMonth, details.BillablePrice , details.BilledQuantity, pricecode.Sale_BillablePrice, details.FlatRate))\r\n      as BillableAmount\r\n    , (1 - IFNULL(tbl_order.Discount, 0) / 100) *\r\n      GetAmountMultiplier(details.DOSFrom, details.DOSTo, details.EndDate, details.ActualSaleRentType, details.ActualOrderedWhen, details.ActualBilledWhen) *\r\n      GetAllowableAmount(details.ActualSaleRentType, details.BillingMonth, details.AllowablePrice, details.BilledQuantity, pricecode.Sale_AllowablePrice, details.FlatRate)\r\n      as AllowableAmount\r\n    , (1 - IFNULL(tbl_order.Discount, 0) / 100) *\r\n      GetAmountMultiplier(details.DOSFrom, details.DOSTo, details.EndDate, details.ActualSaleRentType, details.ActualOrderedWhen, details.ActualBilledWhen) *\r\n      IF((details.Taxable = 1) AND (view_taxrate.ID IS NOT NULL)\r\n        ,GetAllowableAmount(details.ActualSaleRentType, details.BillingMonth, details.AllowablePrice, details.BilledQuantity, pricecode.Sale_AllowablePrice, details.FlatRate) * (0 + IFNULL(view_taxrate.TotalTax, 0) / 100)\r\n        ,0.00) as Taxes\r\n    , details.BilledQuantity *\r\n      GetQuantityMultiplier(details.DOSFrom, details.DOSTo, details.EndDate, details.ActualSaleRentType, details.ActualOrderedWhen, details.ActualBilledWhen)\r\n      as Quantity\r\n    , IFNULL(tbl_customer.Hardship, 0)\r\n    , IFNULL(details.AcceptAssignment, 0) as AcceptAssignment\r\n    , P_InvoiceDate\r\n    , details.DOSFrom\r\n    , details.ActualDosTo as DOSTo\r\n    , details.ShowSpanDates\r\n    , details.BillingCode\r\n    , GetInvoiceModifier(tbl_order.DeliveryDate, details.ActualSaleRentType, details.BillingMonth, 1, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4)\r\n    , GetInvoiceModifier(tbl_order.DeliveryDate, details.ActualSaleRentType, details.BillingMonth, 2, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4)\r\n    , GetInvoiceModifier(tbl_order.DeliveryDate, details.ActualSaleRentType, details.BillingMonth, 3, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4)\r\n    , GetInvoiceModifier(tbl_order.DeliveryDate, details.ActualSaleRentType, details.BillingMonth, 4, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4)\r\n    , details.DXPointer\r\n    , details.DXPointer10\r\n    , details.DrugNoteField\r\n    , details.DrugControlNumber\r\n    , IF(details.BillingMonth <= 0, 1, details.BillingMonth)\r\n    , IF(details.BillingMonth <= 1, details.SendCMN_RX_w_invoice, 0)\r\n    , details.SpecialCode\r\n    , details.ReviewCode\r\n    , details.MedicallyUnnecessary\r\n    , details.BillIns1\r\n    , details.BillIns2\r\n    , details.BillIns3\r\n    , details.BillIns4\r\n    , details.NopayIns1\r\n    , details.CMNFormID\r\n    , details.AuthorizationTypeID\r\n    , details.AuthorizationNumber\r\n    , details.HaoDescription\r\n    FROM tbl_order\r\n         INNER JOIN view_orderdetails_core as details ON tbl_order.ID = details.OrderID\r\n                                                     AND tbl_order.CustomerID = details.CustomerID\r\n         INNER JOIN tbl_pricecode_item as pricecode ON details.PriceCodeID = pricecode.PriceCodeID\r\n                                                   AND details.InventoryItemID = pricecode.InventoryItemID\r\n         LEFT JOIN tbl_customer ON tbl_order.CustomerID = tbl_customer.ID\r\n         LEFT JOIN tbl_company ON tbl_company.ID = 1\r\n         LEFT JOIN view_taxrate ON IFNULL(tbl_customer.TaxRateID, tbl_company.TaxRateID) = view_taxrate.ID\r\n    WHERE (details.OrderID = P_OrderID)\r\n      AND (details.IsActive = 1)\r\n      -- we should generate invoices before end date and should not generate invoices after end date\r\n      AND ((details.EndDate IS NULL) OR (details.DosFrom <= details.EndDate))\r\n      AND (IF(details.BillingMonth <= 0, 1, details.BillingMonth) = P_BillingMonth)\r\n      AND ((IF((tbl_order.CustomerInsurance1_ID IS NOT NULL) AND (details.BillIns1 = 1), 1, 0) +\r\n            IF((tbl_order.CustomerInsurance2_ID IS NOT NULL) AND (details.BillIns2 = 1), 2, 0) +\r\n            IF((tbl_order.CustomerInsurance3_ID IS NOT NULL) AND (details.BillIns3 = 1), 4, 0) +\r\n            IF((tbl_order.CustomerInsurance4_ID IS NOT NULL) AND (details.BillIns4 = 1), 8, 0) +\r\n            IF((details.EndDate IS NOT NULL), 32, 0) +\r\n            IF((details.AcceptAssignment = 1), 16, 0)) = P_BillingFlags)\r\n      AND (IFNULL(details.MIR, '') = '')\r\n      AND (OrderMustBeSkipped  (tbl_order.DeliveryDate, details.DosFrom, details.ActualSaleRentType, details.BillingMonth, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4) = 0)\r\n      AND (InvoiceMustBeSkipped(tbl_order.DeliveryDate, details.DosFrom, details.ActualSaleRentType, details.BillingMonth, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4) = 0)\r\n      -- check for zero amount was moved out of function InvoiceMustBeSkipped\r\n      AND (details.IsZeroAmount = 0); --\r\n  END IF; --\r\n\r\n  -- update order line items\r\n  UPDATE tbl_order\r\n         INNER JOIN view_orderdetails_core as details ON tbl_order.ID = details.OrderID\r\n                                                     AND tbl_order.CustomerID = details.CustomerID\r\n  SET\r\n    tbl_order.BillDate = details.DOSFrom\r\n  , details.DOSTo   = GetNextDosTo  (details.DOSFrom, details.DOSTo, details.ActualBilledWhen)\r\n  , details.DOSFrom = GetNextDosFrom(details.DOSFrom, details.DOSTo, details.ActualBilledWhen)\r\n  , details.Modifier1 = GetInvoiceModifier(tbl_order.DeliveryDate, details.ActualSaleRentType, details.BillingMonth, 1, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4)\r\n  , details.Modifier2 = GetInvoiceModifier(tbl_order.DeliveryDate, details.ActualSaleRentType, details.BillingMonth, 2, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4)\r\n  , details.State   = CASE WHEN (details.EndDate IS NOT NULL) AND (details.EndDate < details.InvoiceDate)\r\n                           THEN 'Closed'\r\n                           WHEN OrderMustBeClosed(tbl_order.DeliveryDate, details.DOSFrom, details.ActualSaleRentType, details.BillingMonth, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4) = 1\r\n                           THEN 'Closed'\r\n                           ELSE details.State END\r\n  , details.EndDate = CASE WHEN details.EndDate IS NOT NULL\r\n                           THEN details.EndDate\r\n                           WHEN OrderMustBeClosed(tbl_order.DeliveryDate, details.DOSFrom, details.ActualSaleRentType, details.BillingMonth, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4) = 1\r\n                           THEN P_InvoiceDate\r\n                           ELSE details.EndDate END\r\n  , details.BillingMonth = IF(details.BillingMonth <= 0, 1, details.BillingMonth) + 1\r\n  WHERE (details.OrderID = P_OrderID)\r\n    AND (details.IsActive = 1)\r\n    AND (IF(details.BillingMonth <= 0, 1, details.BillingMonth) = P_BillingMonth)\r\n    AND ((IF((tbl_order.CustomerInsurance1_ID IS NOT NULL) AND (details.BillIns1 = 1), 1, 0) +\r\n          IF((tbl_order.CustomerInsurance2_ID IS NOT NULL) AND (details.BillIns2 = 1), 2, 0) +\r\n          IF((tbl_order.CustomerInsurance3_ID IS NOT NULL) AND (details.BillIns3 = 1), 4, 0) +\r\n          IF((tbl_order.CustomerInsurance4_ID IS NOT NULL) AND (details.BillIns4 = 1), 8, 0) +\r\n          IF((details.EndDate IS NOT NULL), 32, 0) +\r\n          IF((details.AcceptAssignment = 1), 16, 0)) = P_BillingFlags)\r\n    AND (IFNULL(details.MIR, '') = '')\r\n    AND (OrderMustBeSkipped(tbl_order.DeliveryDate, details.DosFrom, details.ActualSaleRentType, details.BillingMonth, details.Modifier1, details.Modifier2, details.Modifier3, details.Modifier4) = 0); --\r\n\r\n  IF P_BillingMonth = 1 THEN\r\n    CALL Order_ConvertDepositsIntoPayments(P_OrderID); --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "Order_InternalUpdateBalance",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  UPDATE tbl_invoice as i\r\n  INNER JOIN tbl_order as o ON i.CustomerID = o.CustomerID\r\n                           AND i.OrderID    = o.ID\r\n  LEFT JOIN (SELECT tbl_invoicedetails.InvoiceID, Sum(tbl_invoicedetails.Balance) as Balance\r\n             FROM tbl_order\r\n                  INNER JOIN tbl_invoice ON tbl_invoice.CustomerID = tbl_order.CustomerID\r\n                                        AND tbl_invoice.OrderID    = tbl_order.ID\r\n                  INNER JOIN tbl_invoicedetails ON tbl_invoicedetails.CustomerID = tbl_invoice.CustomerID\r\n                                               AND tbl_invoicedetails.InvoiceID  = tbl_invoice.ID\r\n             WHERE (tbl_order.ID = P_OrderID)\r\n             GROUP BY tbl_invoicedetails.InvoiceID) as b\r\n         ON b.InvoiceID = i.ID\r\n  SET i.InvoiceBalance = IFNULL(b.Balance, 0)\r\n  WHERE (o.ID = P_OrderID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "order_process",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  CALL `Order_InternalProcess`(P_OrderID, P_BillingMonth, P_BillingFlags, P_InvoiceDate, P_InvoiceID); --\r\n  IF (P_InvoiceID IS NOT NULL) THEN\r\n    CALL `InvoiceDetails_RecalculateInternals_Single`(P_InvoiceID, null); --\r\n    CALL `Invoice_InternalUpdatePendingSubmissions`  (P_InvoiceID); --\r\n    CALL `InvoiceDetails_RecalculateInternals_Single`(P_InvoiceID, null); --\r\n    CALL `Invoice_InternalUpdateBalance`             (P_InvoiceID); --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "order_process_2",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_InvoiceID INT; --\r\n  SET V_InvoiceID = null; --\r\n\r\n  CALL `Order_InternalProcess`(P_OrderID, P_BillingMonth, P_BillingFlags, P_InvoiceDate, V_InvoiceID); --\r\n  IF (V_InvoiceID IS NOT NULL) THEN\r\n    CALL `InvoiceDetails_RecalculateInternals_Single`(V_InvoiceID, null); --\r\n    CALL `Invoice_InternalUpdatePendingSubmissions`  (V_InvoiceID); --\r\n    CALL `InvoiceDetails_RecalculateInternals_Single`(V_InvoiceID, null); --\r\n    CALL `Invoice_InternalUpdateBalance`             (V_InvoiceID); --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "order_update_dos",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  IF P_DOSFrom IS NOT NULL THEN\r\n    UPDATE view_orderdetails as details\r\n           INNER JOIN tbl_order ON details.CustomerID = tbl_order.CustomerID\r\n                               AND details.OrderID    = tbl_order.ID\r\n    SET\r\n      details.DosFrom = P_DOSFrom\r\n    , details.DosTo   = GetNewDosTo(P_DOSFrom, details.DosFrom, details.DosTo, details.ActualBilledWhen)\r\n    -- ordered quantity will not change\r\n    , details.BilledQuantity = OrderedQty2BilledQty(P_DOSFrom, GetNewDosTo(P_DOSFrom, details.DosFrom, details.DosTo, details.ActualBilledWhen),\r\n        details.OrderedQuantity, details.OrderedWhen, details.BilledWhen,\r\n        details.OrderedConverter, details.DeliveryConverter, details.BilledConverter)\r\n    , details.DeliveryQuantity = OrderedQty2DeliveryQty(P_DOSFrom, GetNewDosTo(P_DOSFrom, details.DosFrom, details.DosTo, details.ActualBilledWhen),\r\n        details.OrderedQuantity, details.OrderedWhen, details.BilledWhen,\r\n        details.OrderedConverter, details.DeliveryConverter, details.BilledConverter)\r\n    WHERE (tbl_order.ID = P_OrderID)\r\n      AND (tbl_order.Approved = 0); --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "process_reoccuring_order",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  -- reoccuring sales support\r\n  -- tbl_orderdetails.ReoccuringID - source line item\r\n  DECLARE V_DetailsCount INT; --\r\n  DECLARE V_NewOrderID INT; --\r\n  DECLARE V_NewOrderDate DATETIME; --\r\n\r\n  SELECT\r\n     Count(*) as `Count`\r\n    ,MAX(IF(details.BillingMonth <= 1, GetNextDosFrom(details.DosFrom, details.DosTo, details.ActualBilledWhen), details.DosFrom)) as NewOrderDate\r\n  INTO\r\n     V_DetailsCount\r\n    ,V_NewOrderDate\r\n  FROM view_orderdetails AS details\r\n       INNER JOIN tbl_order ON details.CustomerID = tbl_order.CustomerID\r\n                           AND details.OrderID    = tbl_order.ID\r\n  WHERE (details.OrderID = P_OrderID)\r\n    AND (details.BilledWhen = P_BilledWhen)\r\n    AND (details.BilledWhen != 'One Time')\r\n    AND (details.ActualBillItemOn = P_BillItemOn)\r\n    AND (details.SaleRentType = 'Re-occurring Sale'); --\r\n\r\n  IF 0 < V_DetailsCount THEN\r\n    -- create order\r\n    INSERT INTO tbl_order\r\n    (CustomerID\r\n    ,Approved\r\n    ,OrderDate\r\n    ,DeliveryDate\r\n    ,BillDate\r\n    ,EndDate\r\n    ,TakenBy\r\n    ,ShippingMethodID\r\n    ,SpecialInstructions\r\n    ,CustomerInsurance1_ID\r\n    ,CustomerInsurance2_ID\r\n    ,CustomerInsurance3_ID\r\n    ,CustomerInsurance4_ID\r\n    ,ICD9_1\r\n    ,ICD9_2\r\n    ,ICD9_3\r\n    ,ICD9_4\r\n    ,ICD10_01\r\n    ,ICD10_02\r\n    ,ICD10_03\r\n    ,ICD10_04\r\n    ,ICD10_05\r\n    ,ICD10_06\r\n    ,ICD10_07\r\n    ,ICD10_08\r\n    ,ICD10_09\r\n    ,ICD10_10\r\n    ,ICD10_11\r\n    ,ICD10_12\r\n    ,DoctorID\r\n    ,POSTypeID\r\n    ,FacilityID\r\n    ,ReferralID\r\n    ,SalesrepID\r\n    ,LocationID\r\n    ,ClaimNote\r\n    ,UserField1\r\n    ,UserField2\r\n    ,LastUpdateUserID)\r\n    SELECT\r\n     CustomerID\r\n    ,0 as Approved\r\n    ,V_NewOrderDate\r\n    ,null as DeliveryDate\r\n    ,null as BillDate\r\n    ,null as EndDate\r\n    ,'AutoGenerated' as TakenBy\r\n    ,ShippingMethodID\r\n    ,SpecialInstructions\r\n    ,CustomerInsurance1_ID\r\n    ,CustomerInsurance2_ID\r\n    ,CustomerInsurance3_ID\r\n    ,CustomerInsurance4_ID\r\n    ,ICD9_1\r\n    ,ICD9_2\r\n    ,ICD9_3\r\n    ,ICD9_4\r\n    ,ICD10_01\r\n    ,ICD10_02\r\n    ,ICD10_03\r\n    ,ICD10_04\r\n    ,ICD10_05\r\n    ,ICD10_06\r\n    ,ICD10_07\r\n    ,ICD10_08\r\n    ,ICD10_09\r\n    ,ICD10_10\r\n    ,ICD10_11\r\n    ,ICD10_12\r\n    ,DoctorID\r\n    ,POSTypeID\r\n    ,FacilityID\r\n    ,ReferralID\r\n    ,SalesrepID\r\n    ,LocationID\r\n    ,ClaimNote\r\n    ,UserField1\r\n    ,UserField2\r\n    ,1 as LastUpdateUserID\r\n    FROM tbl_order\r\n    WHERE (ID = P_OrderID); --\r\n\r\n    SELECT LAST_INSERT_ID() INTO V_NewOrderID; --\r\n\r\n    -- add line items to order\r\n    INSERT INTO tbl_orderdetails\r\n    (CustomerID\r\n    ,OrderID\r\n    ,InventoryItemID\r\n    ,PriceCodeID\r\n    ,SaleRentType\r\n    ,BillablePrice\r\n    ,AllowablePrice\r\n    ,Taxable\r\n    ,FlatRate\r\n    ,DOSFrom\r\n    ,DOSTo\r\n    ,SerialNumber\r\n    ,PickupDate\r\n    ,ShowSpanDates\r\n    -- ordered\r\n    ,OrderedQuantity\r\n    ,OrderedUnits\r\n    ,OrderedWhen\r\n    ,OrderedConverter\r\n    -- billed\r\n    ,BilledQuantity\r\n    ,BilledUnits\r\n    ,BilledWhen\r\n    ,BilledConverter\r\n    -- delivery\r\n    ,DeliveryQuantity\r\n    ,DeliveryUnits\r\n    ,DeliveryConverter\r\n    -- other\r\n    ,BillingMonth\r\n    ,BillingCode\r\n    ,Modifier1\r\n    ,Modifier2\r\n    ,Modifier3\r\n    ,Modifier4\r\n    ,DXPointer\r\n    ,DXPointer10\r\n    ,DrugNoteField\r\n    ,DrugControlNumber\r\n    ,BillItemOn\r\n    ,AuthorizationNumber\r\n    ,AuthorizationTypeID\r\n    ,AuthorizationExpirationDate\r\n    ,ReasonForPickup\r\n    ,SendCMN_RX_w_invoice\r\n    ,MedicallyUnnecessary\r\n    ,SpecialCode\r\n    ,ReviewCode\r\n    ,ReoccuringID\r\n    ,HaoDescription\r\n    ,CMNFormID\r\n    ,WarehouseID\r\n    ,BillIns1\r\n    ,BillIns2\r\n    ,BillIns3\r\n    ,BillIns4\r\n    ,NopayIns1\r\n    ,AcceptAssignment\r\n    ,UserField1\r\n    ,UserField2)\r\n    SELECT\r\n     CustomerID\r\n    ,OrderID\r\n    ,InventoryItemID\r\n    ,PriceCodeID\r\n    ,SaleRentType\r\n    ,BillablePrice\r\n    ,AllowablePrice\r\n    ,Taxable\r\n    ,FlatRate\r\n    ,DOSFrom\r\n    ,DOSTo\r\n    ,SerialNumber\r\n    ,PickupDate\r\n    ,ShowSpanDates\r\n    -- ordered\r\n    ,OrderedQuantity\r\n    ,OrderedUnits\r\n    ,OrderedWhen\r\n    ,OrderedConverter\r\n    -- billed\r\n    ,BilledQuantity\r\n    ,BilledUnits\r\n    ,BilledWhen\r\n    ,BilledConverter\r\n    -- delivery\r\n    ,DeliveryQuantity\r\n    ,DeliveryUnits\r\n    ,DeliveryConverter\r\n    -- other\r\n    ,BillingMonth\r\n    ,BillingCode\r\n    ,Modifier1\r\n    ,Modifier2\r\n    ,Modifier3\r\n    ,Modifier4\r\n    ,DXPointer\r\n    ,DXPointer10\r\n    ,DrugNoteField\r\n    ,DrugControlNumber\r\n    ,BillItemOn\r\n    ,AuthorizationNumber\r\n    ,AuthorizationTypeID\r\n    ,AuthorizationExpirationDate\r\n    ,ReasonForPickup\r\n    ,SendCMN_RX_w_invoice\r\n    ,MedicallyUnnecessary\r\n    ,SpecialCode\r\n    ,ReviewCode\r\n    ,ReoccuringID\r\n    ,HaoDescription\r\n    ,CMNFormID\r\n    ,WarehouseID\r\n    ,BillIns1\r\n    ,BillIns2\r\n    ,BillIns3\r\n    ,BillIns4\r\n    ,NopayIns1\r\n    ,AcceptAssignment\r\n    ,UserField1\r\n    ,UserField2\r\n    FROM (\r\n        SELECT\r\n         details.CustomerID\r\n        ,V_NewOrderID as OrderID\r\n        ,details.InventoryItemID\r\n        ,details.PriceCodeID\r\n        ,'Re-occurring Sale' as SaleRentType\r\n        ,details.BillablePrice\r\n        ,details.AllowablePrice\r\n        ,details.Taxable\r\n        ,details.FlatRate\r\n        ,IF(details.BillingMonth <= 1, GetNextDosFrom(details.DosFrom, details.DosTo, details.ActualBilledWhen), details.DosFrom) as DOSFrom\r\n        ,IF(details.BillingMonth <= 1, GetNextDosTo  (details.DosFrom, details.DosTo, details.ActualBilledWhen), details.DosTo  ) as DOSTo\r\n        ,null as SerialNumber\r\n        ,null as PickupDate\r\n        ,details.ShowSpanDates\r\n        -- ordered\r\n        ,details.OrderedQuantity\r\n        ,details.OrderedUnits\r\n        ,details.OrderedWhen\r\n        ,details.OrderedConverter\r\n        -- billed\r\n        -- ,details.BilledQuantity\r\n        ,OrderedQty2BilledQty(\r\n            IF(details.BillingMonth <= 1, GetNextDosFrom(details.DosFrom, details.DosTo, details.ActualBilledWhen), details.DosFrom),\r\n            IF(details.BillingMonth <= 1, GetNextDosTo  (details.DosFrom, details.DosTo, details.ActualBilledWhen), details.DosTo  ),\r\n            details.OrderedQuantity, details.OrderedWhen, details.BilledWhen,\r\n            details.OrderedConverter, details.DeliveryConverter, details.BilledConverter) as BilledQuantity\r\n        ,details.BilledUnits\r\n        ,details.BilledWhen\r\n        ,details.BilledConverter\r\n        -- delivery\r\n        -- ,details.DeliveryQuantity\r\n        ,OrderedQty2DeliveryQty(\r\n            IF(details.BillingMonth <= 1, GetNextDosFrom(details.DosFrom, details.DosTo, details.ActualBilledWhen), details.DosFrom),\r\n            IF(details.BillingMonth <= 1, GetNextDosTo  (details.DosFrom, details.DosTo, details.ActualBilledWhen), details.DosTo  ),\r\n            details.OrderedQuantity, details.OrderedWhen, details.BilledWhen,\r\n            details.OrderedConverter, details.DeliveryConverter, details.BilledConverter) as DeliveryQuantity\r\n        ,details.DeliveryUnits\r\n        ,details.DeliveryConverter\r\n        -- other\r\n        ,1 as BillingMonth\r\n        ,details.BillingCode\r\n        ,details.Modifier1\r\n        ,details.Modifier2\r\n        ,details.Modifier3\r\n        ,details.Modifier4\r\n        ,details.DXPointer\r\n        ,details.DXPointer10\r\n        ,details.DrugNoteField\r\n        ,details.DrugControlNumber\r\n        ,details.BillItemOn\r\n        ,details.AuthorizationNumber\r\n        ,details.AuthorizationTypeID\r\n        ,details.AuthorizationExpirationDate\r\n        ,null as ReasonForPickup\r\n        ,details.SendCMN_RX_w_invoice\r\n        ,details.MedicallyUnnecessary\r\n        ,details.SpecialCode\r\n        ,details.ReviewCode\r\n        ,details.ID as ReoccuringID\r\n        ,details.HaoDescription\r\n        ,details.CMNFormID\r\n        ,details.WarehouseID\r\n        ,details.BillIns1\r\n        ,details.BillIns2\r\n        ,details.BillIns3\r\n        ,details.BillIns4\r\n        ,details.NopayIns1\r\n        ,details.AcceptAssignment\r\n        ,details.UserField1\r\n        ,details.UserField2\r\n        FROM view_orderdetails as details\r\n             INNER JOIN tbl_order ON details.CustomerID = tbl_order.CustomerID\r\n                                 AND details.OrderID    = tbl_order.ID\r\n        WHERE (details.OrderID = P_OrderID)\r\n          AND (details.BilledWhen = P_BilledWhen)\r\n          AND (details.BilledWhen != 'One Time')\r\n          AND (details.ActualBillItemOn = P_BillItemOn)\r\n          AND (details.SaleRentType = 'Re-occurring Sale')\r\n    ) as `tmp`; --\r\n  END IF; --\r\n\r\n  -- update source line items -- mark them as one time sales\r\n  UPDATE view_orderdetails as details\r\n         INNER JOIN tbl_order ON details.CustomerID = tbl_order.CustomerID\r\n                             AND details.OrderID    = tbl_order.ID\r\n  SET details.SaleRentType = 'One Time Sale'\r\n  WHERE (details.OrderID = P_OrderID)\r\n    AND (details.BilledWhen = P_BilledWhen)\r\n    AND (details.ActualBillItemOn = P_BillItemOn)\r\n    AND (details.SaleRentType = 'Re-occurring Sale'); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "process_reoccuring_purchaseorder",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n    -- reoccuring purchase order support\r\n    DECLARE V_NewOrderID INT; --\r\n\r\n    -- create order\r\n    INSERT INTO tbl_purchaseorder\r\n      (Approved\r\n      ,Reoccuring\r\n      ,Cost\r\n      ,Freight\r\n      ,Tax\r\n      ,TotalDue\r\n      ,VendorID\r\n      ,ShipToName\r\n      ,ShipToAddress1\r\n      ,ShipToAddress2\r\n      ,ShipToCity\r\n      ,ShipToState\r\n      ,ShipToZip\r\n      ,ShipToPhone\r\n      ,OrderDate\r\n      ,CompanyName\r\n      ,CompanyAddress1\r\n      ,CompanyAddress2\r\n      ,CompanyCity\r\n      ,CompanyState\r\n      ,CompanyZip\r\n      ,ShipVia\r\n      ,FOB\r\n      ,VendorSalesRep\r\n      ,Terms\r\n      ,CompanyPhone\r\n      ,TaxRateID\r\n      ,LastUpdateUserID)\r\n    SELECT\r\n       Approved\r\n      ,Reoccuring\r\n      ,Cost\r\n      ,Freight\r\n      ,Tax\r\n      ,TotalDue\r\n      ,VendorID\r\n      ,ShipToName\r\n      ,ShipToAddress1\r\n      ,ShipToAddress2\r\n      ,ShipToCity\r\n      ,ShipToState\r\n      ,ShipToZip\r\n      ,ShipToPhone\r\n      ,OrderDate\r\n      ,CompanyName\r\n      ,CompanyAddress1\r\n      ,CompanyAddress2\r\n      ,CompanyCity\r\n      ,CompanyState\r\n      ,CompanyZip\r\n      ,ShipVia\r\n      ,FOB\r\n      ,VendorSalesRep\r\n      ,Terms\r\n      ,CompanyPhone\r\n      ,TaxRateID\r\n      ,LastUpdateUserID\r\n    FROM\r\n    (\r\n        SELECT\r\n             0 as Approved\r\n            ,1 as Reoccuring\r\n            ,Cost\r\n            ,Freight\r\n            ,Tax\r\n            ,TotalDue\r\n            ,VendorID\r\n            ,ShipToName\r\n            ,ShipToAddress1\r\n            ,ShipToAddress2\r\n            ,ShipToCity\r\n            ,ShipToState\r\n            ,ShipToZip\r\n            ,ShipToPhone\r\n            ,DATE_ADD(OrderDate, INTERVAL 1 MONTH) as OrderDate\r\n            ,CompanyName\r\n            ,CompanyAddress1\r\n            ,CompanyAddress2\r\n            ,CompanyCity\r\n            ,CompanyState\r\n            ,CompanyZip\r\n            ,ShipVia\r\n            ,FOB\r\n            ,VendorSalesRep\r\n            ,Terms\r\n            ,CompanyPhone\r\n            ,TaxRateID\r\n            ,0 as LastUpdateUserID\r\n        FROM tbl_purchaseorder\r\n        WHERE (Reoccuring = 1)\r\n          AND (ID = P_PurchaseOrderID)\r\n    ) as `tmp`; --\r\n\r\n    SELECT LAST_INSERT_ID() INTO V_NewOrderID; --\r\n\r\n  IF V_NewOrderID <> 0 THEN\r\n    -- add line items to order\r\n    INSERT INTO tbl_purchaseorderdetails\r\n      (BackOrder\r\n      ,Ordered\r\n      ,Received\r\n      ,Price\r\n      ,Customer\r\n      ,DatePromised\r\n      ,DateReceived\r\n      ,DropShipToCustomer\r\n      ,InventoryItemID\r\n      ,PurchaseOrderID\r\n      ,WarehouseID\r\n      ,LastUpdateUserID\r\n      ,LastUpdateDatetime\r\n      ,VendorSTKNumber\r\n      ,ReferenceNumber)\r\n    SELECT\r\n       BackOrder\r\n      ,Ordered\r\n      ,Received\r\n      ,Price\r\n      ,Customer\r\n      ,DatePromised\r\n      ,DateReceived\r\n      ,DropShipToCustomer\r\n      ,InventoryItemID\r\n      ,PurchaseOrderID\r\n      ,WarehouseID\r\n      ,LastUpdateUserID\r\n      ,LastUpdateDatetime\r\n      ,VendorSTKNumber\r\n      ,ReferenceNumber\r\n    FROM (\r\n        SELECT\r\n           0 as BackOrder\r\n          ,Ordered as Ordered\r\n          ,0 as Received\r\n          ,Price\r\n          ,Customer\r\n          ,DATE_ADD(DatePromised, INTERVAL 1 MONTH) as DatePromised\r\n          ,null as DateReceived\r\n          ,DropShipToCustomer\r\n          ,InventoryItemID\r\n          ,V_NewOrderID as PurchaseOrderID\r\n          ,WarehouseID\r\n          ,LastUpdateUserID\r\n          ,CURRENT_DATE as LastUpdateDatetime\r\n          ,VendorSTKNumber\r\n          ,ReferenceNumber\r\n        FROM tbl_purchaseorderdetails\r\n        WHERE (PurchaseOrderID = P_PurchaseOrderID)\r\n    ) as `tmp`; --\r\n\r\n    -- update source -- mark them as one time sales\r\n    UPDATE tbl_purchaseorder\r\n    SET Reoccuring = 0\r\n    WHERE (Reoccuring = 1)\r\n      AND (ID = P_PurchaseOrderID); --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "PurchaseOrder_UpdateTotals",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_Cost double; --\r\n\r\n  SELECT Sum(Price * Ordered)\r\n  INTO V_Cost\r\n  FROM tbl_purchaseorderdetails\r\n  WHERE (PurchaseOrderID = P_PurchaseOrderID); --\r\n\r\n  UPDATE tbl_purchaseorder\r\n  SET Cost = IfNull(V_Cost, 0),\r\n      TotalDue = IfNull(V_Cost, 0) + IfNull(Freight, 0) + IfNull(Tax, 0)\r\n  WHERE (ID = P_PurchaseOrderID); --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "retailinvoice_addpayments",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_InvoiceDetailsID INT; --\r\n  DECLARE V_Amount DECIMAL(18, 2); --\r\n  DECLARE V_Extra TEXT; --\r\n  DECLARE V_NewXml VARCHAR(50); --\r\n  DECLARE V_Result VARCHAR(50); --\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE cur CURSOR FOR\r\n    SELECT ID, BillableAmount FROM tbl_invoicedetails WHERE (InvoiceID = P_InvoiceID); --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  OPEN cur; --\r\n\r\n  DETAILS_LOOP: LOOP\r\n    FETCH cur INTO V_InvoiceDetailsID, V_Amount; --\r\n\r\n    IF done THEN\r\n      LEAVE DETAILS_LOOP; --\r\n    END IF; --\r\n\r\n    SET V_NewXml = CONCAT('<v n=\"Paid\">', CAST(V_Amount as CHAR), '</v>'); --\r\n    SET V_Extra = UpdateXML(P_Extra, 'values/v[@n=\"Paid\"]' COLLATE latin1_general_ci, V_NewXml COLLATE latin1_general_ci); --\r\n\r\n    CALL `InvoiceDetails_AddPayment`\r\n    ( V_InvoiceDetailsID\r\n    , NULL -- P_InsuranceCompanyID\r\n    , P_TransactionDate\r\n    , V_Extra\r\n    , '' -- P_Comments\r\n    , '' -- P_Options\r\n    , P_LastUpdateUserID\r\n    , V_Result); --\r\n  END LOOP DETAILS_LOOP; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "serials_fix",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_Count, V_WarehouseID INT; --\r\n  DECLARE cur_ID, cur_WarehouseID INT; --\r\n  DECLARE done INT DEFAULT 0; --\r\n\r\n  DECLARE cur CURSOR FOR\r\n    SELECT\r\n      tbl_serial.ID\r\n    , tbl_warehouse.ID as WarehouseID\r\n    FROM tbl_serial\r\n         LEFT JOIN tbl_warehouse ON tbl_serial.WarehouseID = tbl_warehouse.ID\r\n    WHERE tbl_serial.ID NOT IN (SELECT SerialID FROM tbl_serial_transaction); --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  SELECT Count(*), Min(ID)\r\n  INTO V_Count, V_WarehouseID\r\n  FROM tbl_warehouse; --\r\n\r\n  IF V_Count = 0 THEN\r\n    INSERT INTO tbl_warehouse SET\r\n      `Address1` = '',\r\n      `Address2` = '',\r\n      `City`     = '',\r\n      `Contact`  = '',\r\n      `Fax`      = '',\r\n      `Name`     = 'Default warehouse',\r\n      `Phone`    = '',\r\n      `Phone2`   = '',\r\n      `State`    = '',\r\n      `Zip`      = '',\r\n      `LastUpdateUserID` = 1; --\r\n\r\n    SELECT LAST_INSERT_ID()\r\n    INTO V_WarehouseID; --\r\n  END IF; --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur\r\n    INTO cur_ID, cur_WarehouseID; --\r\n\r\n    IF NOT done THEN\r\n      SET cur_WarehouseID = IFNULL(cur_WarehouseID, V_WarehouseID); --\r\n\r\n      CALL serial_add_transaction(\r\n         'Transferred In' -- P_TranType         VARCHAR(50),\r\n        ,Now()            -- P_TranTime         DATETIME,\r\n        ,cur_ID           -- P_SerialID         INT,\r\n        ,cur_WarehouseID  -- P_WarehouseID      INT,\r\n        ,null             -- P_VendorID         INT,\r\n        ,null             -- P_CustomerID       INT,\r\n        ,null             -- P_OrderID          INT,\r\n        ,null             -- P_OrderDetailsID   INT,\r\n        ,null             -- P_LotNumber        VARCHAR(50),\r\n        ,null             -- P_LastUpdateUserID INT\r\n        ); --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "serials_po_refresh",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n  DECLARE V_SerialID, V_VendorID, V_InventoryItemID, V_WarehouseID INT; --\r\n  DECLARE V_ReceivedDate DATETIME; --\r\n  DECLARE V_ReceivedQuantity, V_SerialCount INT; --\r\n  DECLARE V_PurchasePrice decimal(18, 2); --\r\n  DECLARE cur CURSOR FOR\r\n      SELECT\r\n        tbl_purchaseorder.VendorID,\r\n        tbl_purchaseorderdetails.InventoryItemID,\r\n        tbl_purchaseorderdetails.WarehouseID,\r\n        MAX(tbl_purchaseorderdetails.DateReceived) as ReceivedDate,\r\n        SUM(tbl_purchaseorderdetails.Received) as ReceivedQuantity,\r\n        tbl_purchaseorderdetails.Price as PurchasePrice\r\n      FROM tbl_purchaseorder\r\n           INNER JOIN tbl_purchaseorderdetails ON tbl_purchaseorder.ID = tbl_purchaseorderdetails.PurchaseOrderID\r\n           INNER JOIN tbl_inventoryitem ON tbl_purchaseorderdetails.InventoryItemID = tbl_inventoryitem.ID\r\n      WHERE (tbl_purchaseorder.ID = P_PurchaseOrderID)\r\n        AND (tbl_inventoryitem.Serialized = 1)\r\n      GROUP BY tbl_purchaseorder.VendorID, tbl_purchaseorderdetails.InventoryItemID, tbl_purchaseorderdetails.WarehouseID; --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  DROP TABLE IF EXISTS `{A890A925-A355-44AA-AA99-D28A52F7DF0D}`; --\r\n\r\n  CREATE TEMPORARY TABLE `{A890A925-A355-44AA-AA99-D28A52F7DF0D}` (SerialID INT); --\r\n\r\n  IF EXISTS (SELECT * FROM tbl_purchaseorder WHERE Approved = 1 AND ID = P_PurchaseOrderID) THEN\r\n    OPEN cur; --\r\n\r\n    REPEAT\r\n      FETCH cur INTO\r\n        V_VendorID,\r\n        V_InventoryItemID,\r\n        V_WarehouseID,\r\n        V_ReceivedDate,\r\n        V_ReceivedQuantity,\r\n        V_PurchasePrice; --\r\n\r\n      IF NOT done THEN\r\n        SET V_SerialCount = V_ReceivedQuantity; --\r\n\r\n        SELECT Count(*)\r\n        INTO V_SerialCount\r\n        FROM tbl_serial\r\n        WHERE (WarehouseID = V_WarehouseID)\r\n          AND (InventoryItemID = V_InventoryItemID)\r\n          AND (VendorID = V_VendorID)\r\n          AND (PurchaseOrderID = P_PurchaseOrderID); --\r\n\r\n        WHILE (V_SerialCount < V_ReceivedQuantity) DO\r\n          INSERT INTO tbl_serial (WarehouseID, InventoryItemID, VendorID, PurchaseOrderID, PurchaseDate, PurchaseAmount, Status)\r\n          VALUES (V_WarehouseID, V_InventoryItemID, V_VendorID, P_PurchaseOrderID, V_ReceivedDate, V_PurchasePrice, 'On Hand'); --\r\n\r\n          SELECT LAST_INSERT_ID() INTO V_SerialID; --\r\n\r\n          INSERT INTO `{A890A925-A355-44AA-AA99-D28A52F7DF0D}` (SerialID) VALUES (V_SerialID); --\r\n\r\n          SET V_SerialCount = V_SerialCount + 1; --\r\n        END WHILE; --\r\n      END IF; --\r\n    UNTIL done END REPEAT; --\r\n\r\n    CLOSE cur; --\r\n  END IF; --\r\n\r\n  SELECT SerialID FROM `{A890A925-A355-44AA-AA99-D28A52F7DF0D}`; --\r\n\r\n  DROP TABLE `{A890A925-A355-44AA-AA99-D28A52F7DF0D}`; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "serials_refresh",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_SerialID INT; --\r\n  DECLARE done INT DEFAULT 0; --\r\n\r\n  DECLARE cur CURSOR FOR\r\n    SELECT ID\r\n    FROM tbl_serial\r\n    WHERE ((P_SerialID        IS NULL) OR (ID              = P_SerialID       ))\r\n      AND ((P_WarehouseID     IS NULL) OR (WarehouseID     = P_WarehouseID    ))\r\n      AND ((P_InventoryItemID IS NULL) OR (InventoryItemID = P_InventoryItemID)); --\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO\r\n      V_SerialID; --\r\n\r\n    IF NOT done THEN\r\n      CALL serial_add_transaction(\r\n         null -- P_TranType         VARCHAR(50),\r\n        ,null -- P_TranTime         DATETIME,\r\n        ,V_SerialID -- P_SerialID         INT,\r\n        ,null -- P_WarehouseID      INT,\r\n        ,null -- P_VendorID         INT,\r\n        ,null -- P_CustomerID       INT,\r\n        ,null -- P_OrderID          INT,\r\n        ,null -- P_OrderDetailsID   INT,\r\n        ,null -- P_LotNumber        VARCHAR(50),\r\n        ,null -- P_LastUpdateUserID INT\r\n        ); --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "serial_add_transaction",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n\r\n  -- cursor variables\r\n  DECLARE cur_TranID             int(11); --\r\n  DECLARE cur_TranExists         int(11); --\r\n  DECLARE cur_TranTypeID         int(11); --\r\n  DECLARE cur_TranType           varchar(50); --\r\n  DECLARE cur_TranTime           datetime; --\r\n  DECLARE cur_VendorID           int(11); --\r\n  DECLARE cur_WarehouseID        int(11); --\r\n  DECLARE cur_CustomerID         int(11); --\r\n  DECLARE cur_OrderID            int(11); --\r\n  DECLARE cur_OrderDetailsID     int(11); --\r\n  DECLARE cur_LotNumber          varchar(50); --\r\n  DECLARE cur_LastUpdateUserID   smallint(6); --\r\n  DECLARE cur_LastUpdateDatetime timestamp; --\r\n\r\n  -- variables for update\r\n  DECLARE V_Status            varchar(20); --\r\n  DECLARE V_VendorID          int(11); --\r\n  DECLARE V_WarehouseID       int(11); --\r\n  DECLARE V_LotNumber         varchar(50); --\r\n  DECLARE V_SoldDate          date; --\r\n  DECLARE V_CurrentCustomerID int(11); --\r\n  DECLARE V_LastCustomerID    int(11); --\r\n  DECLARE V_LastUpdateUserID  smallint(6); --\r\n  DECLARE V_AcceptableTran    bool; --\r\n\r\n  DECLARE cur CURSOR FOR\r\n   (SELECT\r\n     tbl_serial_transaction.ID        as TranID\r\n    ,1                                as TranExists\r\n    ,tbl_serial_transaction_type.ID   as TranTypeID\r\n    ,tbl_serial_transaction_type.Name as TranType\r\n    ,tbl_serial_transaction.TransactionDatetime\r\n    ,tbl_serial_transaction.VendorID\r\n    ,tbl_serial_transaction.WarehouseID\r\n    ,tbl_serial_transaction.CustomerID\r\n    ,tbl_serial_transaction.OrderID\r\n    ,tbl_serial_transaction.OrderDetailsID\r\n    ,tbl_serial_transaction.LotNumber\r\n    ,tbl_serial_transaction.LastUpdateUserID\r\n    ,tbl_serial_transaction.LastUpdateDatetime\r\n    FROM tbl_serial\r\n         INNER JOIN tbl_serial_transaction ON tbl_serial.ID = tbl_serial_transaction.SerialID\r\n         INNER JOIN tbl_serial_transaction_type ON tbl_serial_transaction.TypeID = tbl_serial_transaction_type.ID\r\n    WHERE (tbl_serial.ID = P_SerialID))\r\n   UNION ALL\r\n   (SELECT\r\n     NULL                             as TranID\r\n    ,0                                as TranExists\r\n    ,tbl_serial_transaction_type.ID   as TranTypeID\r\n    ,tbl_serial_transaction_type.Name as TranType\r\n    ,IFNULL(P_TranTime, Now())        as TransactionDatetime\r\n    ,P_VendorID         as VendorID\r\n    ,P_WarehouseID      as WarehouseID\r\n    ,P_CustomerID       as CustomerID\r\n    ,P_OrderID          as OrderID\r\n    ,P_OrderDetailsID   as OrderDetailsID\r\n    ,P_LotNumber        as LotNumber\r\n    ,P_LastUpdateUserID as LastUpdateUserID\r\n    ,Now()              as LastUpdateDatetime\r\n    FROM tbl_serial_transaction_type\r\n    WHERE (tbl_serial_transaction_type.Name = P_TranType))\r\n   ORDER BY TranExists desc, TranID asc; --\r\n\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  IF (P_SerialID IS NOT NULL) THEN\r\n    -- init / reinit\r\n    SET V_Status            = 'Unknown'; --\r\n    SET V_VendorID          = null; --\r\n    SET V_WarehouseID       = null; --\r\n    SET V_LotNumber         = null; --\r\n    SET V_SoldDate          = null; --\r\n    SET V_LastCustomerID    = null; --\r\n    SET V_CurrentCustomerID = null; --\r\n    SET V_LastUpdateUserID  = null; --\r\n\r\n    OPEN cur; --\r\n\r\n    REPEAT\r\n      FETCH cur INTO\r\n       cur_TranID\r\n      ,cur_TranExists\r\n      ,cur_TranTypeID\r\n      ,cur_TranType\r\n      ,cur_TranTime\r\n      ,cur_VendorID\r\n      ,cur_WarehouseID\r\n      ,cur_CustomerID\r\n      ,cur_OrderID\r\n      ,cur_OrderDetailsID\r\n      ,cur_LotNumber\r\n      ,cur_LastUpdateUserID\r\n      ,cur_LastUpdateDatetime; --\r\n\r\n      IF (done = 0)\r\n      AND (cur_TranTypeID IS NOT NULL)\r\n      THEN\r\n        SET V_AcceptableTran = 1; --\r\n\r\n        IF (V_Status IN ('Unknown', 'On Hand')) AND (cur_TranType = 'Reserved') THEN\r\n          -- ( 1, 'Reserved'                ), -- means that we added serial to not approved order\r\n          SET cur_VendorID        = null; --\r\n          SET cur_WarehouseID     = null; --\r\n          -- SET cur_CustomerID      = null; -- we need to know for whom did we reserved that serial\r\n          -- SET cur_OrderID         = null; --\r\n          -- SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'Reserved'; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status IN ('Unknown', 'Reserved')) AND (cur_TranType = 'Reserve Cancelled') THEN\r\n          -- ( 2, 'Reserve Cancelled'       ), -- means that we removed serial from not approved order\r\n          SET cur_VendorID        = null; --\r\n          SET cur_WarehouseID     = null; --\r\n          SET cur_CustomerID      = null; --\r\n          SET cur_OrderID         = null; --\r\n          SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'On Hand'; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status IN ('Unknown', 'On Hand', 'Reserved') AND cur_TranType IN ('Rented', 'Sold'))\r\n            OR (V_Status IN ('Rented') AND cur_TranType IN ('Sold')) THEN\r\n          -- ( 3, 'Rented'                  ), -- means that RENT order was approved\r\n          -- ( 4, 'Sold'                    ), -- means that SALE order or RENT-TO-PURCHASE order was approved\r\n          SET cur_VendorID        = null; --\r\n          SET cur_WarehouseID     = null; --\r\n          -- SET cur_CustomerID      = null; -- we need to know who rented or bought that serial\r\n          -- SET cur_OrderID         = null; --\r\n          -- SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = CASE WHEN cur_TranType = 'Sold' THEN cur_TranTime ELSE null END; --\r\n          SET V_Status            = CASE cur_TranType WHEN 'Rented' THEN 'Rented' WHEN 'Sold' THEN 'Sold' ELSE null END; --\r\n          SET V_WarehouseID       = null; --\r\n          SET V_LastCustomerID    = V_CurrentCustomerID; --\r\n          SET V_CurrentCustomerID = cur_CustomerID; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status != 'Maintenance') AND (cur_TranType IN ('Returned')) THEN\r\n          -- ( 5, 'Returned'                ), -- means that user return RENTED serial\r\n          --                                   -- but serial must be cleaned out prior to re-using\r\n          SET cur_VendorID        = null; --\r\n          -- SET cur_WarehouseID     = null; -- we need to know where we returned that serial\r\n          -- SET cur_CustomerID      = null; -- we need to know whom we returned that serial from\r\n          -- SET cur_OrderID         = null; --\r\n          -- SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'Maintenance'; --\r\n          SET V_WarehouseID       = cur_WarehouseID; --\r\n          SET V_LastCustomerID    = V_CurrentCustomerID; --\r\n          SET V_CurrentCustomerID = null; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (cur_TranType IN ('Lost', 'Junked')) THEN\r\n          -- ( 6, 'Lost'                    ), -- can be added only manually to mark serial as 'Lost'\r\n          -- ( 7, 'Junked'                  ), -- can be added only manually to mark serial as 'Junked'\r\n          SET cur_VendorID        = null; --\r\n          SET cur_WarehouseID     = null; --\r\n          SET cur_CustomerID      = null; --\r\n          SET cur_OrderID         = null; --\r\n          SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = CASE cur_TranType WHEN 'Lost' THEN 'Lost' WHEN 'Junked' THEN 'Junked' ELSE null END; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status IN ('Unknown', 'Empty')) AND (cur_TranType = 'O2 Tank out for filling') THEN\r\n          -- ( 8, 'O2 Tank out for filling' ), -- Send    : \"Empty\"   -> \"Sent\"\r\n          -- SET cur_VendorID        = null; -- we need to know whom we sent that serial\r\n          SET cur_WarehouseID     = null; --\r\n          SET cur_CustomerID      = null; --\r\n          SET cur_OrderID         = null; --\r\n          SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'Sent'; --\r\n          SET V_VendorID          = cur_VendorID; --\r\n          SET V_WarehouseID       = null; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status IN ('Unknown', 'Sent')) AND (cur_TranType = 'O2 Tank in from filling') THEN\r\n          -- ( 9, 'O2 Tank in from filling' ), -- Receive : \"Sent\"    -> \"On Hand\"\r\n          SET cur_VendorID        = null; --\r\n          -- SET cur_WarehouseID     = null; -- we need to know where we returned that serial\r\n          SET cur_CustomerID      = null; --\r\n          SET cur_OrderID         = null; --\r\n          SET cur_OrderDetailsID  = null; --\r\n          -- SET cur_LotNumber       = null; --we need to know lot number assigned\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'On Hand'; --\r\n          SET V_WarehouseID       = cur_WarehouseID; --\r\n          SET V_LotNumber         = cur_LotNumber; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status IN ('Unknown', 'On Hand')) AND (cur_TranType = 'O2 Tank out to customer') THEN\r\n          -- (10, 'O2 Tank out to customer' ), -- Rent    : \"On Hand\" -> \"Rented\"\r\n          SET cur_VendorID        = null; --\r\n          SET cur_WarehouseID     = null; -- we need to know where we returned that serial\r\n          -- SET cur_CustomerID      = null; -- we need to know whom we sent that serial\r\n          -- SET cur_OrderID         = null; --\r\n          -- SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'Rented'; --\r\n          SET V_WarehouseID       = null; --\r\n          SET V_CurrentCustomerID = cur_CustomerID; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status IN ('Unknown', 'Rented')) AND (cur_TranType = 'O2 Tank in from customer') THEN\r\n          -- (11, 'O2 Tank in from customer'), -- Pickup  : \"Rented\"  -> \"Empty\"\r\n          SET cur_VendorID        = null; --\r\n          -- SET cur_WarehouseID     = null; -- we need to know where we returned that serial\r\n          SET cur_CustomerID      = null; --\r\n          SET cur_OrderID         = null; --\r\n          SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'Empty'; --\r\n          SET V_WarehouseID       = cur_WarehouseID; --\r\n          SET V_LastCustomerID    = V_CurrentCustomerID; --\r\n          SET V_CurrentCustomerID = null; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status IN ('Unknown', 'On Hand')) AND (cur_TranType = 'Transferred Out') THEN\r\n          -- (14, 'Transferred Out' ), -- Transferred Out  : \"On Hand\" -> \"Transferred Out\"\r\n          SET cur_VendorID        = null; --\r\n          SET cur_WarehouseID     = null; -- we need to know where we returned that serial\r\n          SET cur_CustomerID      = null; -- we need to know whom we sent that serial\r\n          SET cur_OrderID         = null; --\r\n          SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'Transferred Out'; --\r\n          SET V_WarehouseID       = null; --\r\n          SET V_CurrentCustomerID = null; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status IN ('Unknown', 'Transferred Out')) AND (cur_TranType = 'Transferred In') THEN\r\n          -- (15, 'Transferred In' ) -- Transferred In  : \"Transferred Out\" -> \"On Hand\"\r\n          --                                            :       <NULL>      -> \"On Hand\"\r\n          -- only way to assign warehouse to serial\r\n          SET cur_VendorID        = null; --\r\n          -- SET cur_WarehouseID     = null; -- we need to know where we returned that serial\r\n          SET cur_CustomerID      = null; -- we need to know whom we sent that serial\r\n          SET cur_OrderID         = null; --\r\n          SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'On Hand'; --\r\n          SET V_WarehouseID       = cur_WarehouseID; --\r\n          SET V_CurrentCustomerID = null; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status IN ('Unknown', 'On Hand')) AND (cur_TranType = 'Out for Maintenance') THEN\r\n          -- (12, 'Out for Maintenance' ), -- Out for Maintenance  : \"On Hand\" -> \"Maintenance\"\r\n          SET cur_VendorID        = null; --\r\n          -- SET cur_WarehouseID     = null; -- we need to know where we sent that serial\r\n          SET cur_CustomerID      = null; -- we do not need to know whom we sent that serial\r\n          SET cur_OrderID         = null; --\r\n          SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'Maintenance'; --\r\n          SET V_WarehouseID       = cur_WarehouseID; --\r\n          SET V_CurrentCustomerID = null; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSEIF (V_Status IN ('Unknown', 'Maintenance')) AND (cur_TranType = 'In from Maintenance') THEN\r\n          -- (13, 'In from Maintenance' ) -- In from Maintenance  : \"Maintenance\" -> \"On Hand\"\r\n          --                                                      :     <NULL>    -> \"On Hand\"\r\n          -- another way to assign warehouse to serial\r\n          SET cur_VendorID        = null; --\r\n          -- SET cur_WarehouseID     = null; -- we need to know where we returned that serial\r\n          SET cur_CustomerID      = null; -- we do not need to know whom we sent that serial\r\n          SET cur_OrderID         = null; --\r\n          SET cur_OrderDetailsID  = null; --\r\n          SET cur_LotNumber       = null; --\r\n\r\n          SET V_SoldDate          = null; --\r\n          SET V_Status            = 'On Hand'; --\r\n          SET V_WarehouseID       = cur_WarehouseID; --\r\n          SET V_CurrentCustomerID = null; --\r\n          SET V_LastUpdateUserID  = cur_LastUpdateUserID; --\r\n\r\n        ELSE\r\n          SET V_AcceptableTran = 0; --\r\n\r\n        END IF; --\r\n\r\n        IF (V_AcceptableTran = 1) AND (cur_TranExists = 0) THEN\r\n          INSERT INTO tbl_serial_transaction SET\r\n           TypeID              = cur_TranTypeID\r\n          ,SerialID            = P_SerialID\r\n          ,TransactionDatetime = cur_TranTime\r\n          ,VendorID            = cur_VendorID\r\n          ,WarehouseID         = cur_WarehouseID\r\n          ,CustomerID          = cur_CustomerID\r\n          ,OrderID             = cur_OrderID\r\n          ,OrderDetailsID      = cur_OrderDetailsID\r\n          ,LotNumber           = IFNULL(cur_LotNumber, '')\r\n          ,LastUpdateDatetime  = IFNULL(cur_LastUpdateDatetime, Now())\r\n          ,LastUpdateUserID    = IFNULL(cur_LastUpdateUserID, 1); -- root\r\n        END IF; --\r\n\r\n      END IF; --\r\n    UNTIL done END REPEAT; --\r\n\r\n    CLOSE cur; --\r\n\r\n    -- save into db\r\n    UPDATE tbl_serial SET\r\n      Status            = CASE WHEN V_Status = 'Unknown' THEN 'On Hand' ELSE V_Status END\r\n    , VendorID          = V_VendorID\r\n    , WarehouseID       = V_WarehouseID\r\n    , LotNumber         = IFNULL(V_LotNumber, '')\r\n    , SoldDate          = V_SoldDate\r\n    , CurrentCustomerID = V_CurrentCustomerID\r\n    , LastCustomerID    = V_LastCustomerID\r\n    , LastUpdateUserID  = IFNULL(V_LastUpdateUserID, 1) -- root\r\n    WHERE (ID = P_SerialID); --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "serial_order_refresh",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE done INT DEFAULT 0; --\r\n\r\n  -- cursor variables\r\n  DECLARE cur_Priority         int(11); --\r\n  DECLARE cur_CustomerID       int(11); --\r\n  DECLARE cur_OrderID          int(11); --\r\n  DECLARE cur_OrderDetailsID   int(11); --\r\n  DECLARE cur_SerialID         int(11); --\r\n  DECLARE cur_WarehouseID      int(11); --\r\n  DECLARE cur_TranType         varchar(50); --\r\n  DECLARE cur_TranTime         datetime; --\r\n\r\n  DECLARE cur CURSOR FOR\r\n    (\r\n     SELECT\r\n      1 as Priority\r\n     ,view_orderdetails.CustomerID\r\n     ,view_orderdetails.OrderID\r\n     ,view_orderdetails.ID as OrderDetailsID\r\n     ,view_orderdetails.SerialID\r\n     ,null as WarehouseID\r\n     ,'Reserved' as TranType\r\n     ,IFNULL(tbl_order.OrderDate, Now()) as TranTime\r\n     FROM tbl_order\r\n          INNER JOIN view_orderdetails ON view_orderdetails.CustomerID = tbl_order.CustomerID\r\n                                      AND view_orderdetails.OrderID    = tbl_order.ID\r\n          INNER JOIN tbl_serial ON view_orderdetails.SerialID        = tbl_serial.ID -- serial exists\r\n                               AND view_orderdetails.InventoryItemID = tbl_serial.InventoryItemID\r\n          INNER JOIN tbl_serial_transaction_type as stt ON stt.Name = 'Reserved'\r\n          LEFT JOIN tbl_serial_transaction as LastTran ON LastTran.CustomerID     = view_orderdetails.CustomerID\r\n                                                      AND LastTran.OrderID        = view_orderdetails.OrderID\r\n                                                      AND LastTran.OrderDetailsID = view_orderdetails.ID\r\n                                                      AND LastTran.TypeID         = stt.ID\r\n          LEFT JOIN (SELECT SerialID, Max(ID) as MaxID\r\n                     FROM tbl_serial_transaction\r\n                     GROUP BY SerialID) as TranHistory ON LastTran.SerialID = TranHistory.SerialID\r\n                                                      AND LastTran.ID       = TranHistory.MaxID\r\n     WHERE (tbl_order.Approved = 0) -- we reserve only for not approved orders\r\n       AND ((LastTran.ID IS NULL) OR (TranHistory.SerialID IS NULL))\r\n       AND ((tbl_order.ID = P_OrderID) OR (P_OrderID IS NULL))\r\n    ) UNION ALL (\r\n     SELECT\r\n      2 as Priority\r\n     ,LastTran.CustomerID\r\n     ,LastTran.OrderID\r\n     ,LastTran.OrderDetailsID\r\n     ,LastTran.SerialID\r\n     ,null as WarehouseID\r\n     ,'Reserve Cancelled' as TranType\r\n     ,Now() as TranTime\r\n     FROM (SELECT SerialID, Max(ID) as MaxID\r\n           FROM tbl_serial_transaction\r\n           GROUP BY SerialID) as TranHistory\r\n          INNER JOIN tbl_serial_transaction as LastTran ON LastTran.SerialID = TranHistory.SerialID\r\n                                                       AND LastTran.ID       = TranHistory.MaxID\r\n          INNER JOIN tbl_serial_transaction_type ON tbl_serial_transaction_type.ID   = LastTran.TypeID\r\n                                                AND tbl_serial_transaction_type.Name = 'Reserved'\r\n          INNER JOIN tbl_serial ON TranHistory.SerialID = tbl_serial.ID\r\n          LEFT JOIN view_orderdetails ON LastTran.CustomerID     =  view_orderdetails.CustomerID\r\n                                     AND LastTran.OrderID        =  view_orderdetails.OrderID\r\n                                     AND LastTran.OrderDetailsID =  view_orderdetails.ID\r\n          LEFT JOIN tbl_order ON view_orderdetails.CustomerID = tbl_order.CustomerID\r\n                             AND view_orderdetails.OrderID    = tbl_order.ID\r\n     WHERE ((view_orderdetails.SerialID IS NULL) OR (view_orderdetails.SerialID != LastTran.SerialID))\r\n       AND ((LastTran.OrderID = P_OrderID) OR (P_OrderID IS NULL))\r\n    ) UNION ALL (\r\n     SELECT DISTINCT\r\n      3 as Priority\r\n     ,view_orderdetails.CustomerID\r\n     ,view_orderdetails.OrderID\r\n     ,view_orderdetails.ID as OrderDetailsID\r\n     ,view_orderdetails.SerialID\r\n     ,null as WarehouseID\r\n     ,'Rented' as TranType\r\n     ,IFNULL(tbl_order.DeliveryDate, IFNULL(tbl_order.OrderDate, Now())) as TranTime\r\n     FROM tbl_order\r\n          INNER JOIN view_orderdetails ON view_orderdetails.CustomerID = tbl_order.CustomerID\r\n                                      AND view_orderdetails.OrderID    = tbl_order.ID\r\n          INNER JOIN tbl_serial ON view_orderdetails.SerialID        = tbl_serial.ID -- serial exists\r\n                               AND view_orderdetails.InventoryItemID = tbl_serial.InventoryItemID\r\n          INNER JOIN tbl_serial_transaction_type as stt ON stt.Name = 'Rented'\r\n          LEFT JOIN tbl_serial_transaction as st ON st.CustomerID     = view_orderdetails.CustomerID\r\n                                                AND st.OrderID        = view_orderdetails.OrderID\r\n                                                AND st.OrderDetailsID = view_orderdetails.ID\r\n                                                AND st.SerialID       = view_orderdetails.SerialID\r\n                                                AND st.TypeID         = stt.ID\r\n     WHERE (tbl_order.Approved = 1)\r\n       AND (view_orderdetails.IsRented = 1)\r\n       AND (st.ID IS NULL)\r\n       AND ((tbl_order.ID = P_OrderID) OR (P_OrderID IS NULL))\r\n    ) UNION ALL (\r\n     SELECT DISTINCT\r\n      3 as Priority\r\n     ,view_orderdetails.CustomerID\r\n     ,view_orderdetails.OrderID\r\n     ,view_orderdetails.ID as OrderDetailsID\r\n     ,view_orderdetails.SerialID\r\n     ,null as WarehouseID\r\n     ,'Sold' as TranType\r\n     ,IFNULL(tbl_order.DeliveryDate, IFNULL(tbl_order.OrderDate, Now())) as TranTime\r\n     FROM tbl_order\r\n          INNER JOIN view_orderdetails ON view_orderdetails.CustomerID = tbl_order.CustomerID\r\n                                      AND view_orderdetails.OrderID    = tbl_order.ID\r\n          INNER JOIN tbl_serial ON view_orderdetails.SerialID        = tbl_serial.ID -- serial exists\r\n                               AND view_orderdetails.InventoryItemID = tbl_serial.InventoryItemID\r\n          INNER JOIN tbl_serial_transaction_type as stt ON stt.Name = 'Sold'\r\n          LEFT JOIN tbl_serial_transaction as st ON st.CustomerID     = view_orderdetails.CustomerID\r\n                                                AND st.OrderID        = view_orderdetails.OrderID\r\n                                                AND st.OrderDetailsID = view_orderdetails.ID\r\n                                                AND st.SerialID       = view_orderdetails.SerialID\r\n                                                AND st.TypeID         = stt.ID\r\n     WHERE (tbl_order.Approved = 1)\r\n       AND (view_orderdetails.IsSold = 1)\r\n       AND (st.ID IS NULL)\r\n       AND ((tbl_order.ID = P_OrderID) OR (P_OrderID IS NULL))\r\n    ) UNION ALL (\r\n     SELECT DISTINCT\r\n      4 as Priority\r\n     ,view_orderdetails.CustomerID\r\n     ,view_orderdetails.OrderID\r\n     ,view_orderdetails.ID as OrderDetailsID\r\n     ,view_orderdetails.SerialID\r\n     ,view_orderdetails.WarehouseID\r\n     ,'Returned' as TranType\r\n     ,IFNULL(view_orderdetails.EndDate, Now()) as TranTime\r\n     FROM tbl_order\r\n          INNER JOIN view_orderdetails ON view_orderdetails.CustomerID = tbl_order.CustomerID\r\n                                      AND view_orderdetails.OrderID    = tbl_order.ID\r\n          INNER JOIN tbl_serial ON view_orderdetails.SerialID        = tbl_serial.ID -- serial exists\r\n                               AND view_orderdetails.InventoryItemID = tbl_serial.InventoryItemID\r\n          INNER JOIN tbl_serial_transaction_type as stt ON stt.Name = 'Returned'\r\n          LEFT JOIN tbl_serial_transaction as st ON st.CustomerID     = view_orderdetails.CustomerID\r\n                                                AND st.OrderID        = view_orderdetails.OrderID\r\n                                                AND st.OrderDetailsID = view_orderdetails.ID\r\n                                                AND st.SerialID       = view_orderdetails.SerialID\r\n                                                AND st.TypeID         = stt.ID\r\n     WHERE (tbl_order.Approved = 1)\r\n       AND (view_orderdetails.IsCanceled = 0)\r\n       AND (view_orderdetails.IsPickedup = 1)\r\n       AND (view_orderdetails.IsRented = 1)\r\n       AND (st.ID IS NULL)\r\n       AND ((tbl_order.ID = P_OrderID) OR (P_OrderID IS NULL))\r\n    ) UNION ALL (\r\n     SELECT DISTINCT\r\n      5 as Priority\r\n     ,view_orderdetails.CustomerID\r\n     ,view_orderdetails.OrderID\r\n     ,view_orderdetails.ID as OrderDetailsID\r\n     ,view_orderdetails.SerialID\r\n     ,null as WarehouseID\r\n     ,'Sold' as TranType\r\n     ,IFNULL(view_orderdetails.EndDate, Now()) as TranTime\r\n     FROM tbl_order\r\n          INNER JOIN view_orderdetails ON view_orderdetails.CustomerID = tbl_order.CustomerID\r\n                                      AND view_orderdetails.OrderID    = tbl_order.ID\r\n          INNER JOIN tbl_serial ON view_orderdetails.SerialID        = tbl_serial.ID -- serial exists\r\n                               AND view_orderdetails.InventoryItemID = tbl_serial.InventoryItemID\r\n          INNER JOIN tbl_serial_transaction_type as stt ON stt.Name = 'Sold'\r\n          LEFT JOIN tbl_serial_transaction as st ON st.CustomerID     = view_orderdetails.CustomerID\r\n                                                AND st.OrderID        = view_orderdetails.OrderID\r\n                                                AND st.OrderDetailsID = view_orderdetails.ID\r\n                                                AND st.SerialID       = view_orderdetails.SerialID\r\n                                                AND st.TypeID         = stt.ID\r\n     WHERE (tbl_order.Approved = 1)\r\n       AND (view_orderdetails.IsActive = 0)\r\n       AND (view_orderdetails.IsCanceled = 0)\r\n       AND (view_orderdetails.IsPickedup = 0)\r\n       AND (view_orderdetails.IsRented = 1)\r\n       AND (st.ID IS NULL)\r\n       AND ((tbl_order.ID = P_OrderID) OR (P_OrderID IS NULL))\r\n    ) ORDER BY SerialID, Priority, TranTime; --\r\n\r\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1; --\r\n\r\n  OPEN cur; --\r\n\r\n  REPEAT\r\n    FETCH cur INTO\r\n     cur_Priority\r\n    ,cur_CustomerID\r\n    ,cur_OrderID\r\n    ,cur_OrderDetailsID\r\n    ,cur_SerialID\r\n    ,cur_WarehouseID\r\n    ,cur_TranType\r\n    ,cur_TranTime; --\r\n\r\n    IF (done = 0) THEN\r\n      CALL serial_add_transaction(\r\n          cur_TranType       -- P_TranType         VARCHAR(50)\r\n        , cur_TranTime       -- P_TranTime         DATETIME\r\n        , cur_SerialID       -- P_SerialID         INT,\r\n        , cur_WarehouseID    -- P_WarehouseID      INT,\r\n        , null               -- P_VendorID         INT,\r\n        , cur_CustomerID     -- P_CustomerID       INT,\r\n        , cur_OrderID        -- P_OrderID          INT,\r\n        , cur_OrderDetailsID -- P_OrderDetailsID   INT,\r\n        , null               -- P_LotNumber        VARCHAR(50),\r\n        , 1                  -- P_LastUpdateUserID INT\r\n      ); --\r\n    END IF; --\r\n  UNTIL done END REPEAT; --\r\n\r\n  CLOSE cur; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  },
  {
    "ROUTINE_NAME": "serial_transfer",
    "ROUTINE_TYPE": "PROCEDURE",
    "ROUTINE_DEFINITION": "BEGIN\r\n  DECLARE V_SerialID, V_InventoryItemID, V_CountBefore, V_CountAfter INT; --\r\n\r\n  SELECT tbl_serial.ID, tbl_serial.InventoryItemID\r\n  INTO V_SerialID, V_InventoryItemID\r\n  FROM tbl_serial\r\n  WHERE ID = P_SerialID; --\r\n\r\n  IF (V_SerialID IS NOT NULL) THEN\r\n    SELECT Count(*)\r\n    INTO V_CountBefore\r\n    FROM tbl_serial_transaction\r\n    WHERE SerialID = V_SerialID; --\r\n\r\n    CALL serial_add_transaction(\r\n       'Transferred Out'  -- P_TranType         VARCHAR(50),\r\n      ,Now()              -- P_TranTime         DATETIME,\r\n      ,V_SerialID         -- P_SerialID         INT,\r\n      ,P_SrcWarehouseID   -- P_WarehouseID      INT,\r\n      ,null               -- P_VendorID         INT,\r\n      ,null               -- P_CustomerID       INT,\r\n      ,null               -- P_OrderID          INT,\r\n      ,null               -- P_OrderDetailsID   INT,\r\n      ,null               -- P_LotNumber        VARCHAR(50),\r\n      ,P_LastUpdateUserID -- P_LastUpdateUserID INT\r\n      ); --\r\n\r\n    CALL serial_add_transaction(\r\n       'Transferred In'   -- P_TranType         VARCHAR(50),\r\n      ,Now()              -- P_TranTime         DATETIME,\r\n      ,V_SerialID         -- P_SerialID         INT,\r\n      ,P_DstWarehouseID   -- P_WarehouseID      INT,\r\n      ,null               -- P_VendorID         INT,\r\n      ,null               -- P_CustomerID       INT,\r\n      ,null               -- P_OrderID          INT,\r\n      ,null               -- P_OrderDetailsID   INT,\r\n      ,null               -- P_LotNumber        VARCHAR(50),\r\n      ,P_LastUpdateUserID -- P_LastUpdateUserID INT\r\n      ); --\r\n\r\n    SELECT Count(*)\r\n    INTO V_CountAfter\r\n    FROM tbl_serial_transaction\r\n    WHERE SerialID = V_SerialID; --\r\n\r\n    IF V_CountAfter - V_CountBefore = 2 THEN\r\n      CALL internal_inventory_transfer(\r\n        V_InventoryItemID\r\n      , P_SrcWarehouseID\r\n      , P_DstWarehouseID\r\n      , 1\r\n      , CONCAT('Serial #', V_SerialID, ' Transfer')\r\n      , P_LastUpdateUserID); --\r\n    END IF; --\r\n  END IF; --\r\nEND",
    "DATA_TYPE": "",
    "SECURITY_TYPE": "DEFINER",
    "SQL_DATA_ACCESS": "CONTAINS SQL"
  }
]